<!DOCTYPE html>
<!--
  Contact List Application (list.html)
  Formerly contacts_new.html - Renamed for better clarity
  Full-featured contact management system with Supabase integration
  
  Features:
  - Complete CRUD operations for contacts
  - Real-time editing with automatic save to Supabase
  - User assignment and role management
  - Search and filtering capabilities
  - Pagination and bulk operations
  - Import/Export functionality
  - SMS, Email, and RVM integration (coming soon)
-->
<html>
<head>
  <meta charset="UTF-8">
  <title>Contact List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="static/supersparky.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script src="static/global-nav-v2.js"></script>
  <style>
    body { 
      margin: 0; 
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
    }
    
    /* Reset any margins from global navigation */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body * {
      margin: revert;
      padding: revert;
    }
    
    /* Force tight positioning against global nav */
    #global-nav, .global-nav, [id*="nav"], [class*="nav"] {
      margin-bottom: 0 !important;
      padding-bottom: 0 !important;
    }
    
    /* Ensure body content starts immediately after nav */
    body > div:first-child,
    body > header:first-child,
    body > nav:first-child {
      margin-bottom: 0 !important;
      padding-bottom: 0 !important;
    }
    
    .controls {
      background: white;
      padding: 5px 20px;
      margin: -10px 20px 0px 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: space-between;
      position: sticky;
      top: 60px;
      z-index: 3000;
    }
    
    .search-group {
      display: flex;
      gap: 10px;
      align-items: center;
      flex: 0.33;
      min-width: 100px;
      position: relative;
    }
    
    .search-input {
      flex: 1;
      padding: 2px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .search-input:focus {
      border-color: #667eea;
    }
    
    /* Search suggestions dropdown */
    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 1000;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    
    .suggestion-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #f8f9fa;
    }
    
    .suggestion-item:hover,
    .suggestion-item.active {
      background: #f8f9fa;
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .btn {
      padding: 2px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .btn-primary { 
      background: linear-gradient(to bottom, #4dabf7, #007bff); 
      color: white; 
    }
    .btn-success { 
      background: linear-gradient(to bottom, #51cf66, #28a745); 
      color: white; 
    }
    .btn-warning { 
      background: linear-gradient(to bottom, #ffd43b, #ffc107); 
      color: #212529; 
    }
    .btn-danger { 
      background: linear-gradient(to bottom, #ff6b6b, #dc3545); 
      color: white; 
    }
    .btn-info { 
      background: linear-gradient(to bottom, #22d3ee, #17a2b8); 
      color: white; 
    }
    .btn-secondary { 
      background: linear-gradient(to bottom, #adb5bd, #6c757d); 
      color: white; 
    }
    
    .table-container {
      margin: 0 20px 0 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow: auto;
      height: calc(100vh - 125px);
      border: 2px solid #e9ecef;
      padding: 0 10px 0 10px;
      position: sticky;
      top: 125px;
      z-index: 2000;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    .table th,
    .table td {
      padding: 0 12px;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
      font-size: 12px;
    }
    
    .table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    /* Sticky columns 1-5 with proper sizing */
    .table th:nth-child(1),
    .table td:nth-child(1) {
      background: #e3f2fd;
      padding: 0 !important;
      width: 20px;
      min-width: 20px;
      max-width: 20px;
      text-align: center;
      position: sticky;
      left: 0;
      z-index: 10;
    }
    
    .table th:nth-child(2),
    .table td:nth-child(2) {
      background: #c0c0c0;
      padding: 0 1px 0 2px !important;
      width: auto;
      min-width: fit-content;
      text-align: center !important;
      position: sticky;
      left: 20px;
      z-index: 9;
    }
    
    .table th:nth-child(3),
    .table td:nth-child(3) {
      background: #e8e8e8;
      padding: 0 1px 0 1px !important;
      width: 25px;
      min-width: 25px;
      max-width: 25px;
      text-align: center !important;
      position: sticky;
      left: 48px;
      z-index: 8;
    }
    
    .table th:nth-child(4),
    .table td:nth-child(4) {
      background: #d3d3d3;
      padding: 0 1px 0 1px !important;
      width: auto;
      min-width: fit-content;
      text-align: center !important;
      position: sticky;
      left: 73px;
      z-index: 7;
    }
    
    /* Red text for data cells only in columns 2, 3, 4 */
    .table td:nth-child(2),
    .table td:nth-child(3),
    .table td:nth-child(4) {
      color: #ff0000 !important;
    }
    
    .table th:nth-child(5),
    .table td:nth-child(5) {
      background: #fff3e0;
      padding: 0 !important;
      width: 30px;
      min-width: 30px;
      max-width: 30px;
      position: sticky;
      left: 107px;
      z-index: 6;
    }
    
    .table th:nth-child(6),
    .table td:nth-child(6) {
      background: #e8f5e8;
      padding: 0 !important;
      width: 50px;
      min-width: 50px;
      max-width: 50px;
      position: sticky;
      left: 137px;
      z-index: 5;
    }
    
    /* Ensure sticky headers appear above data cells and are sticky vertically */
    .table thead th {
      position: sticky;
      top: 0;
      z-index: 20;
    }
    
    .table thead th:nth-child(1) { 
      position: sticky;
      top: 0;
      left: 0;
      z-index: 30; 
    }
    .table thead th:nth-child(2) { 
      position: sticky;
      top: 0;
      left: 20px;
      z-index: 29; 
    }
    .table thead th:nth-child(3) { 
      position: sticky;
      top: 0;
      left: 48px;
      z-index: 28; 
    }
    .table thead th:nth-child(4) { 
      position: sticky;
      top: 0;
      left: 73px;
      z-index: 27; 
    }
    .table thead th:nth-child(5) { 
      position: sticky;
      top: 0;
      left: 107px;
      z-index: 26; 
    }
    .table thead th:nth-child(6) { 
      position: sticky;
      top: 0;
      left: 137px;
      z-index: 25; 
    }
    
    .table tbody tr:hover {
      background-color: #f1f3f4;
    }
    
    .table tbody tr.selected {
      background-color: #e3f2fd !important;
    }
    
    .table tbody tr.selected:hover {
      background-color: #bbdefb !important;
    }
    
    .checkbox {
      margin: 0;
      cursor: pointer;
    }
    
    /* Editable table styles */
    .editable-cell {
      position: relative;
      cursor: pointer;
    }
    
    .editable-cell:hover {
      background-color: #e8f4fd !important;
      outline: 1px solid #007bff;
    }
    
    .editable-cell.editing {
      padding: 0 !important;
      background-color: #fff !important;
      outline: 2px solid #007bff;
    }
    
    .cell-input {
      width: 100%;
      height: 100%;
      border: none;
      padding: 4px 6px;
      font-size: 12px;
      font-family: inherit;
      background: white;
      outline: none;
      min-height: 28px;
      box-sizing: border-box;
    }
    
    .cell-input:focus {
      outline: none;
    }
    
    .edit-indicator {
      display: none;
    }
    
    .readonly-cell {
      background-color: #f8f9fa !important;
      cursor: text;
      user-select: text;
    }
    
    .readonly-cell:hover {
      background-color: #e9ecef !important;
      outline: 1px solid #6c757d !important;
    }
    
    .readonly-cell .cell-content {
      user-select: text;
      cursor: text;
    }
    
    /* Tooltip styles for cell hover */
    .cell-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-family: inherit;
      white-space: nowrap;
      z-index: 10000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      max-width: 300px;
      word-break: break-all;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .cell-tooltip.show {
      opacity: 1;
    }
    
    .cell-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
    }
    
    /* Save indicator */
    .saving-cell {
      background-color: #fff3cd !important;
      animation: pulse 1s infinite;
    }
    
    .saved-cell {
      background-color: #d4edda !important;
      transition: background-color 0.3s ease;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    .red-header {
      background: #ffebee !important;
      color: #c62828 !important;
    }
    
    .grey-header {
      background: #ff0000 !important;
      color: #ffffff !important;
      font-weight: bold !important;
    }
    
    /* Blue gradient for table headers starting from column 7 */
    .table th:nth-child(n+7) {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      color: white !important;
      font-weight: bold !important;
    }
    
    /* Blue gradient background for columns 7 and up */
    .table th:nth-child(n+7) {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      color: white !important;
      font-weight: bold !important;
    }
    
    /* Make headers from column 6 onward vertically sticky */
    .table thead th:nth-child(n+6) {
      position: sticky;
      top: 0;
      z-index: 15;
    }
    
    /* Resizable column styles */
    .table th:nth-child(n+6) {
      position: relative;
      min-width: 50px;
    }
    
    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      cursor: col-resize;
      background: rgba(0,0,0,0.1);
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 100;
    }
    
    .table th:nth-child(n+6):hover .resize-handle {
      opacity: 1;
    }
    
    .resize-handle:hover {
      background: rgba(0,0,0,0.3);
      opacity: 1 !important;
    }
    
    .resize-handle.resizing {
      background: #007bff;
      opacity: 1 !important;
    }
    
    .table th.resizing {
      user-select: none;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 20px 0 20px;
      background: white;
      margin: 0px 20px 0 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      font-size: 12px;
      position: sticky;
      top: 90px;
      z-index: 2500;
    }
    
    .pagination {
      display: flex;
      align-items: center;
      font-size: 12px;
    }
    
    .pagination button {
      padding: 2px 6px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 12px;
      color: #007bff;
      text-decoration: none;
    }
    
    .pagination button:hover:not(:disabled) {
      color: #0056b3;
      text-decoration: underline;
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      color: #6c757d;
    }
    
    .pagination button.active {
      color: #ffffff;
      background-color: #007bff;
      font-weight: bold;
    }
    
    .page-size-selector {
      display: flex;
      gap: 5px;
      align-items: center;
      font-size: 12px;
    }
    
    .page-size-selector select {
      padding: 2px 4px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      background: white;
      font-size: 12px;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 5vh auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .modal-header h3 {
      margin: 0;
      color: #495057;
    }
    
    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }
    
    .close:hover {
      color: #000;
    }
    
    .user-search {
      width: 100%;
      padding: 0 10px;
      border: 2px solid #e9ecef;
      border-radius: 5px;
      font-size: 16px;
      margin-bottom: 5px;
      line-height: 1.2;
    }
    
    .user-search:focus {
      border-color: #007bff;
      outline: none;
    }
    
    .user-results {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e9ecef;
      border-radius: 5px;
      background: white;
    }
    
    .user-item {
      padding: 0 10px;
      cursor: pointer;
      border-bottom: 1px solid #f8f9fa;
      display: flex;
      align-items: center;
      gap: 10px;
      height: 36px;
    }
    
    .user-item:hover {
      background: #f0f0f0 !important;
    }
    
    .user-item-alt {
      background: #f8f9fa;
    }
    
    .user-item-alt:hover {
      background: #e9ecef !important;
    }
    
    .user-item:last-child {
      border-bottom: none;
    }
    
    .user-item.selected {
      background: #e3f2fd !important;
      border-left: 4px solid #007bff;
    }
    
    .user-info {
      flex: 1;
    }
    
    .user-name {
      font-weight: 600;
      color: #495057;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #e9ecef;
    }

    /* Responsive modal adjustments */
    @media (max-height: 600px) {
      .modal-content {
        margin: 2vh auto;
        max-height: 95vh;
        padding: 15px;
      }
    }

    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        margin: 2vh auto;
        padding: 15px;
      }
    }

    @media (max-width: 480px) {
      .modal-content {
        width: 98%;
        margin: 1vh auto;
        padding: 10px;
      }
      
      .modal-header {
        margin-bottom: 15px;
      }
      
      .modal-actions {
        margin-top: 15px;
        padding-top: 10px;
      }
    }
  </style>
</head>

<body>
  <!-- Controls -->
  <div class="controls">
    <div style="display: flex; gap: 15px; align-items: center;">
      <button id="delete-btn" class="btn btn-danger">Delete</button>
      
      <div class="search-group">
        <input id="search-input" type="text" class="search-input" placeholder="Search contacts..." autocomplete="off" />
        <div id="search-suggestions" class="search-suggestions"></div>
        <button id="search-btn" class="btn btn-primary">Search</button>
        <button id="reset-btn" class="btn btn-secondary">Reset</button>
      </div>
    </div>
    
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <button id="assign-btn" class="btn btn-success">Assign</button>
      <button id="sms-btn" class="btn btn-success">SMS</button>
      <button id="email-btn" class="btn btn-info">Email</button>
      <button id="rvm-btn" class="btn btn-warning">RVM</button>
      <button id="campaign-btn" class="btn btn-primary">Campaign</button>
      <button id="add-btn" class="btn btn-success">View</button>
      <button id="sort-btn" class="btn btn-secondary">Sort <span id="sort-indicator" style="display: none;">✓</span></button>
      <button id="import-btn" class="btn btn-info">Import</button>
      <button id="export-btn" class="btn btn-warning">Export</button>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Loading contacts...</p>
  </div>

  <!-- Pagination -->
  <div class="pagination-container">
    <div class="dnd-indicator" style="color: #dc3545; font-weight: bold; font-size: 12px;">
      Do Not Disturb = X
    </div>
    
    <div id="select-all-toggle" style="display: none; color: #0056b3; font-weight: bold; font-size: 12px;">
      <a href="#" id="select-all-link" style="color: #0056b3; text-decoration: none; cursor: pointer;">
        <span id="selected-count">0</span> selected - Select all <span id="total-contacts-count">0</span> contacts
      </a>
    </div>
    
    <div class="contact-info" style="color: #495057; font-weight: bold; font-size: 12px;">
      <span id="contact-count-display">Loading...</span>
    </div>
    
    <div class="page-size-selector">
      <label>Show:</label>
      <select id="page-size-select">
        <option value="all">All</option>
        <option value="20">20</option>
        <option value="40">40</option>
        <option value="60">60</option>
        <option value="80">80</option>
        <option value="100">100</option>
        <option value="120">120</option>
        <option value="140">140</option>
        <option value="160">160</option>
        <option value="180">180</option>
        <option value="200">200</option>
        <option value="220">220</option>
        <option value="240">240</option>
        <option value="260">260</option>
        <option value="280">280</option>
        <option value="300">300</option>
        <option value="500">500</option>
        <option value="1000">1000</option>
        <option value="1500">1500</option>
        <option value="2000">2000</option>
        <option value="2500">2500</option>
        <option value="3000">3000</option>
      </select>
      <span>entries</span>
    </div>
    
    <div class="pagination" id="pagination">
      <!-- Pagination buttons will be inserted here -->
    </div>
  </div>

  <!-- Table -->
  <div class="table-container">
    <table class="table" id="contacts-table">
      <thead>
        <tr>
          <th>
            <input type="checkbox" id="header-checkbox" class="checkbox">
          </th>
          <th class="grey-header">SMS</th>
          <th class="grey-header">Call</th>
          <th class="grey-header">Email</th>
          <th>No.</th>
          <th>Contact ID<div class="resize-handle"></div></th>
          <th>Assignee<div class="resize-handle"></div></th>
          <th>Sponsor<div class="resize-handle"></div></th>
          <th>Sponsor First<div class="resize-handle"></div></th>
          <th>Sponsor Last<div class="resize-handle"></div></th>
          <th>Sparky ID<div class="resize-handle"></div></th>
          <th>First Name<div class="resize-handle"></div></th>
          <th>Last Name<div class="resize-handle"></div></th>
          <th>Email<div class="resize-handle"></div></th>
          <th>Valid<div class="resize-handle"></div></th>
          <th>Phone<div class="resize-handle"></div></th>
          <th>Address<div class="resize-handle"></div></th>
          <th>City<div class="resize-handle"></div></th>
          <th>State<div class="resize-handle"></div></th>
          <th>Zip<div class="resize-handle"></div></th>
          <th>IP<div class="resize-handle"></div></th>
          <th>Date<div class="resize-handle"></div></th>
          <th>Timezone<div class="resize-handle"></div></th>
          <th>Cell<div class="resize-handle"></div></th>
          <th>Carrier<div class="resize-handle"></div></th>
          <th>Landline<div class="resize-handle"></div></th>
          <th>VoIP<div class="resize-handle"></div></th>
          <th>Other<div class="resize-handle"></div></th>
          <th>Foreign<div class="resize-handle"></div></th>
          <th>Country<div class="resize-handle"></div></th>
        </tr>
      </thead>
      <tbody id="contacts-tbody">
        <!-- Contacts will be populated here -->
      </tbody>
    </table>
  </div>

  <!-- User Assignment Modal -->
  <div id="user-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Assign Users</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <input type="text" id="user-search" class="user-search" placeholder="Search users..." autocomplete="off">
        <div id="user-results" class="user-results">
          <!-- User search results will appear here -->
        </div>
        <div id="selected-user" style="margin-top: 5px; padding: 5px 10px; background: #f8f9fa; border-radius: 5px; display: none;">
          <strong>Selected User:</strong> <span id="selected-user-name"></span>
        </div>
      </div>
      <div class="modal-actions">
        <button id="cancel-assign" class="btn btn-secondary">Cancel</button>
        <button id="unassign-selected" class="btn btn-warning">Unassign Selected</button>
        <button id="confirm-assign" class="btn btn-success" disabled>Assign Selected</button>
      </div>
    </div>
  </div>

  <!-- Add Contact Modal -->
  <div id="add-contact-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Add New Contact</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <form id="add-contact-form">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label>First Name *</label>
              <input type="text" name="first_name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label>Last Name *</label>
              <input type="text" name="last_name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label>Email *</label>
              <input type="email" name="email" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label>Phone</label>
              <input type="tel" name="phone" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label>City</label>
              <input type="text" name="city" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label>State</label>
              <input type="text" name="state" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-actions">
        <button id="cancel-add" class="btn btn-secondary">Cancel</button>
        <button id="confirm-add" class="btn btn-success">Add Contact</button>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="import-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Import Contacts</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 15px;">
          <label>Choose CSV file:</label>
          <input type="file" id="csv-file" accept=".csv" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 15px;">
          <button id="download-template" class="btn btn-info">Download Template</button>
        </div>
        <div id="import-preview" style="display: none;">
          <h4>Preview (first 5 rows):</h4>
          <div id="preview-table" style="max-height: 200px; overflow: auto; border: 1px solid #ddd; border-radius: 4px;"></div>
          <p><strong>Total rows:</strong> <span id="total-rows">0</span></p>
        </div>
      </div>
      <div class="modal-actions">
        <button id="cancel-import" class="btn btn-secondary">Cancel</button>
        <button id="confirm-import" class="btn btn-success" disabled>Import Contacts</button>
      </div>
    </div>
  </div>

  <!-- Message Composer Modal -->
  <div id="message-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="message-modal-title">Compose Message</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 15px;">
          <label>Recipients: <span id="recipient-count">0</span> contacts selected</label>
        </div>
        <div style="margin-bottom: 15px;">
          <label>Subject (for email):</label>
          <input type="text" id="message-subject" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 15px;">
          <label>Message:</label>
          <textarea id="message-content" rows="6" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Enter your message here..."></textarea>
        </div>
        <div style="margin-bottom: 15px;">
          <label>
            <input type="checkbox" id="message-preview"> Preview before sending
          </label>
        </div>
      </div>
      <div class="modal-actions">
        <button id="cancel-message" class="btn btn-secondary">Cancel</button>
        <button id="send-message" class="btn btn-success">Send Message</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Confirm Delete</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong id="delete-count">0</strong> selected contact(s)?</p>
        <p style="color: #dc3545; font-size: 14px;">This action cannot be undone.</p>
      </div>
      <div class="modal-actions">
        <button id="cancel-delete" class="btn btn-secondary">Cancel</button>
        <button id="confirm-delete" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>

  <!-- Sort Modal -->
  <div id="sort-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Sort Contacts</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div id="sort-levels" style="font-size: 12px;">
          <!-- Sort levels will be added here dynamically -->
        </div>
        <div style="margin-top: 10px;">
          <button id="add-sort-level" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px;">Add Level</button>
          <button id="clear-sort" class="btn btn-secondary" style="font-size: 12px; padding: 5px 10px; margin-left: 10px;">Clear All</button>
        </div>
      </div>
      <div class="modal-actions">
        <button id="cancel-sort" class="btn btn-secondary">Cancel</button>
        <button id="apply-sort" class="btn btn-primary">Apply Sort</button>
      </div>
    </div>
  </div>

  <!-- Column Visibility Modal -->
  <div id="column-modal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Column Visibility</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div style="font-size: 12px; max-height: 300px; overflow-y: auto;">
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="contact_id" checked style="margin-right: 8px;">
              <span>Contact ID</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="assignee" checked style="margin-right: 8px;">
              <span>Assignee</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="sponsor" checked style="margin-right: 8px;">
              <span>Sponsor</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="sponsor_first" checked style="margin-right: 8px;">
              <span>Sponsor First</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="sponsor_last" checked style="margin-right: 8px;">
              <span>Sponsor Last</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="user_id" checked style="margin-right: 8px;">
              <span>Sparky ID</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="first_name" checked style="margin-right: 8px;">
              <span>First Name</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="last_name" checked style="margin-right: 8px;">
              <span>Last Name</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="email" checked style="margin-right: 8px;">
              <span>Email</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="valid" checked style="margin-right: 8px;">
              <span>Valid</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="phone" checked style="margin-right: 8px;">
              <span>Phone</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="address" checked style="margin-right: 8px;">
              <span>Address</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="city" checked style="margin-right: 8px;">
              <span>City</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="state" checked style="margin-right: 8px;">
              <span>State</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="zip" checked style="margin-right: 8px;">
              <span>Zip</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="ip_address" checked style="margin-right: 8px;">
              <span>IP</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="date_created" checked style="margin-right: 8px;">
              <span>Date</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="timezone" checked style="margin-right: 8px;">
              <span>Timezone</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="cell" checked style="margin-right: 8px;">
              <span>Cell</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="carrier" checked style="margin-right: 8px;">
              <span>Carrier</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="landline" checked style="margin-right: 8px;">
              <span>Landline</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="voip" checked style="margin-right: 8px;">
              <span>VoIP</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="other_phone" checked style="margin-right: 8px;">
              <span>Other</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="foreign_number" checked style="margin-right: 8px;">
              <span>Foreign</span>
            </label>
          </div>
          <div style="margin-bottom: 5px; padding: 5px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="checkbox" class="column-toggle" data-column="country" checked style="margin-right: 8px;">
              <span>Country</span>
            </label>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="show-all-columns" class="btn btn-secondary">Show All</button>
        <button id="hide-all-columns" class="btn btn-secondary">Hide All</button>
        <button id="close-column-modal" class="btn btn-primary">Close</button>
      </div>
    </div>
  </div>

  <script>
    console.log('=== SCRIPT STARTED ===');
    
    // Supabase configuration - using direct Supabase access
    const SUPABASE_URL = 'https://yggfiuqxfxsoyesqgpyt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlnZ2ZpdXF4Znhzb3llc3FncHl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4MTQ0NjEsImV4cCI6MjA2NjM5MDQ2MX0.YD3fUy1m7lNWCMfUhd1DP7rlmq2tmlwAxg_yJxruB-Q';
    
    // Use global Supabase client if available, otherwise create one
    let supabase = null;
    if (window.globalSupabase) {
      console.log('Using existing global Supabase client');
      supabase = window.globalSupabase;
    } else if (window.supabase && typeof window.supabase.createClient === 'function') {
      console.log('Creating new Supabase client...');
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else {
      console.error('Supabase library not loaded or createClient not available');
      console.log('window.supabase:', window.supabase);
      console.log('typeof window.supabase:', typeof window.supabase);
      if (window.supabase) {
        console.log('window.supabase.createClient:', window.supabase.createClient);
      }
    }
    
    console.log('Supabase client initialized:', !!supabase);
    console.log('Supabase client type:', typeof supabase);
    console.log('Supabase.from available:', typeof supabase?.from);

    // Global variables
    let allContacts = [];
    let filteredContacts = [];
    let selectedContactIds = new Set();
    let pageSize = 20;
    let currentPage = 1;
    let paginatedContacts = [];
    let selectedUser = null;
    let importData = [];
    let users = [];

    // Load users from Supabase profiles table
    async function loadUsers() {
      const timestamp = new Date().toISOString();
      console.log(`[${timestamp}] loadUsers() called - starting fresh user load attempt`);
      
      try {
        // Get current user from session for role-based filtering
        const currentUser = await getCurrentUser();
        if (!currentUser) {
          console.warn('No current user found, cannot load users for assignment');
          users = [];
          return;
        }
        
        console.log('Loading users from API server for current user:', currentUser.email);
        
        // Build API URL with user context for role-based filtering
        const apiUrl = new URL('/api/users', window.location.origin);
        apiUrl.searchParams.set('current_user_id', currentUser.id);
        
        console.log('Fetching users from:', apiUrl.toString());
        
        const response = await fetch(apiUrl);
        if (!response.ok) {
          throw new Error(`API request failed: ${response.status} ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('Users API response:', result);
        
        if (result.error) {
          throw new Error(result.message || 'API returned an error');
        }
        
        const data = result.users || [];
        console.log(`Loaded ${data.length} users for user role: ${result.current_user_role}`);
        
        if (data.length === 0) {
          console.log('No users found that current user can assign to');
          users = [];
          showAlert('info', 'No users available for assignment based on your role permissions.');
          return;
        }
        
        console.log('Raw user data from API:', data.slice(0, 2)); // Show first 2 users for debugging
        
        // Map user data to expected format for UI
        users = data.map(user => {
          const firstName = user.first_name || '';
          const lastName = user.last_name || '';
          const fullName = `${firstName} ${lastName}`.trim();
          const name = fullName || user.email || 'Unknown User';
          
          // Create avatar from name or email
          let avatar;
          if (name && name !== 'Unknown User') {
            avatar = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
          } else {
            avatar = user.email.charAt(0).toUpperCase();
          }
          
          return {
            id: user.id,
            name: name,
            email: user.email,
            avatar: avatar,
            role: user.role || 'User',
            manager_name: user.manager_first_name && user.manager_last_name ? 
                         `${user.manager_first_name} ${user.manager_last_name}` : '',
            raw: user // Keep original data for debugging
          };
        });
        
        // Sort users by name
        users.sort((a, b) => a.name.localeCompare(b.name));
        
        console.log(`Successfully loaded ${users.length} users from API server:`, users.slice(0, 3));
        console.log('User mapping sample:', users[0]);
        
      } catch (error) {
        console.error('Error loading users:', error);
        users = [];
        showAlert('error', 'Failed to load users from API server. User assignment may not work properly.');
      }
    }

    async function handleAssign() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts to assign');
        return;
      }
      
      console.log('Opening assign modal for', selectedContacts.length, 'contacts');
      
      const modal = document.getElementById('user-modal');
      modal.style.display = 'block';
      
      try {
        // Load users from Supabase before displaying
        await loadUsers();
        
        // Show all users initially
        displayUsers(users);
        
        if (users.length === 0) {
          const debugMessage = supabase ? 
            'No users found in the database. Open browser console and run window.debugSupabase() to diagnose the issue.' :
            'Supabase not initialized. Check your connection settings.';
          showAlert('info', debugMessage);
        }
        
        // Focus on search input
        const searchInput = document.getElementById('user-search');
        if (searchInput) {
          searchInput.value = ''; // Clear previous search
          searchInput.focus();
        }
        
        // Disable confirm button initially
        document.getElementById('confirm-assign').disabled = true;
        
      } catch (error) {
        console.error('Error in handleAssign:', error);
        document.getElementById('user-results').innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading users. Please try again.</div>';
        showAlert('error', 'Failed to load users from database');
      }
    }

    async function confirmAssign() {
      console.log('confirmAssign() called'); // Debug log
      
      const selectedUser = document.querySelector('.user-item.selected');
      console.log('Selected user element:', selectedUser); // Debug log
      
      if (!selectedUser) {
        showAlert('warning', 'Please select a user to assign contacts to');
        return;
      }
      
      const userId = selectedUser.getAttribute('data-user-id');
      const user = users.find(u => u.id === userId);
      console.log('Found user object:', user); // Debug log
      
      if (!user) {
        showAlert('error', 'Selected user not found');
        return;
      }
      
      const selectedContacts = getSelectedContacts();
      console.log('Selected contacts for assignment:', selectedContacts); // Debug log
      
      if (selectedContacts.length === 0) {
        showAlert('warning', 'No contacts selected for assignment');
        return;
      }
      
      try {
        console.log('Assigning', selectedContacts.length, 'contacts to user:', user);
        console.log('Selected contact IDs:', selectedContacts);
        console.log('Selected contact IDs types:', selectedContacts.map(id => typeof id));
        
        // Update each selected contact in Supabase
        // Use contact IDs as strings (UUIDs)
        const updates = selectedContacts.map(contactId => {
          console.log(`Updating contact ${contactId} (${typeof contactId})`);
          
          return supabase
            .from('contacts')
            .update({ assignee: user.name })
            .eq('id', contactId); // Use contactId directly (UUID string)
        });
        
        const results = await Promise.all(updates);
        
        // Check for errors
        const errors = results.filter(result => result.error);
        if (errors.length > 0) {
          console.error('Assignment errors:', errors);
          showAlert('error', 'Some contacts could not be assigned: ' + errors[0].error.message);
          return;
        }
        
        // Update local data - use string comparison for UUIDs
        allContacts.forEach(contact => {
          if (selectedContacts.includes(contact.id)) {
            contact.assignee = user.name;
            console.log(`Updated local contact ${contact.id} assignee to ${user.name}`);
          }
        });
        
        // Also update filtered contacts
        filteredContacts.forEach(contact => {
          if (selectedContacts.includes(contact.id)) {
            contact.assignee = user.name;
          }
        });
        
        // Refresh display
        renderContacts();
        
        // Close modal and clear selections
        document.getElementById('user-modal').style.display = 'none';
        clearContactSelections();
        
        // Clear user selection in modal
        const selectedUserDiv = document.getElementById('selected-user');
        selectedUserDiv.style.display = 'none';
        document.querySelectorAll('.user-item.selected').forEach(item => {
          item.classList.remove('selected');
        });
        document.getElementById('confirm-assign').disabled = true;
        
        showAlert('success', `Successfully assigned ${selectedContacts.length} contact(s) to ${user.name}`);
        
      } catch (error) {
        console.error('Error assigning contacts:', error);
        showAlert('error', 'Failed to assign contacts: ' + error.message);
      }
    }

    async function confirmUnassign() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'No contacts selected for unassignment');
        return;
      }
      
      try {
        console.log('Unassigning', selectedContacts.length, 'contacts');
        console.log('Selected contact IDs:', selectedContacts);
        
        // Update each selected contact in Supabase to clear assignee
        const updates = selectedContacts.map(contactId => {
          console.log(`Clearing assignee for contact ${contactId} (${typeof contactId})`);
          
          return supabase
            .from('contacts')
            .update({ assignee: null })
            .eq('id', contactId); // Use contactId directly (UUID string)
        });
        
        const results = await Promise.all(updates);
        
        // Check for errors
        const errors = results.filter(result => result.error);
        if (errors.length > 0) {
          console.error('Unassignment errors:', errors);
          showAlert('error', 'Some contacts could not be unassigned: ' + errors[0].error.message);
          return;
        }
        
        // Update local data - use string comparison for UUIDs
        allContacts.forEach(contact => {
          if (selectedContacts.includes(contact.id)) {
            contact.assignee = '';
            console.log(`Cleared local contact ${contact.id} assignee`);
          }
        });
        
        // Also update filtered contacts
        filteredContacts.forEach(contact => {
          if (selectedContacts.includes(contact.id)) {
            contact.assignee = '';
          }
        });
        
        // Refresh display
        renderContacts();
        
        // Close modal and clear selections
        document.getElementById('user-modal').style.display = 'none';
        clearContactSelections();
        
        // Clear user selection in modal
        const selectedUserDiv = document.getElementById('selected-user');
        selectedUserDiv.style.display = 'none';
        document.querySelectorAll('.user-item.selected').forEach(item => {
          item.classList.remove('selected');
        });
        document.getElementById('confirm-assign').disabled = true;
        
        showAlert('success', `Successfully unassigned ${selectedContacts.length} contact(s)`);
        
      } catch (error) {
        console.error('Error unassigning contacts:', error);
        showAlert('error', 'Failed to unassign contacts: ' + error.message);
      }
    }

    function handleDelete() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts to delete');
        return;
      }
      
      const modal = document.getElementById('delete-modal');
      document.getElementById('delete-count').textContent = selectedContacts.length;
      modal.style.display = 'block';
    }

    function handleSMS() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts for SMS');
        return;
      }
      // Open SMS modal or redirect to SMS page
      showAlert('info', `SMS feature for ${selectedContacts.length} contacts - Coming soon!`);
    }

    function handleEmail() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts for email');
        return;
      }
      // Open email modal or redirect to email page
      showAlert('info', `Email feature for ${selectedContacts.length} contacts - Coming soon!`);
    }

    function handleRVM() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts for RVM');
        return;
      }
      // Open RVM modal or redirect to RVM page
      showAlert('info', `RVM feature for ${selectedContacts.length} contacts - Coming soon!`);
    }

    function handleCampaign() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts for campaign');
        return;
      }
      // Open campaign modal or redirect to campaign page
      showAlert('info', `Campaign feature for ${selectedContacts.length} contacts - Coming soon!`);
    }

    function handleAdd() {
      const modal = document.getElementById('column-modal');
      modal.style.display = 'block';
    }

    function handleSort() {
      const modal = document.getElementById('sort-modal');
      modal.style.display = 'block';
      
      // Update modal title to show if sort is applied
      const modalTitle = modal.querySelector('h3');
      if (appliedSortLevels.length > 0) {
        modalTitle.textContent = `Sort Contacts (${appliedSortLevels.length} level${appliedSortLevels.length > 1 ? 's' : ''} applied)`;
      } else {
        modalTitle.textContent = 'Sort Contacts';
      }
      
      // Initialize with first sort level
      initializeSortModal();
    }

    function handleImport() {
      const modal = document.getElementById('import-modal');
      modal.style.display = 'block';
      // Clear file input and preview
      document.getElementById('csv-file').value = '';
      document.getElementById('import-preview').style.display = 'none';
      document.getElementById('confirm-import').disabled = true;
    }

    function handleExport() {
      // Export all contacts or filtered contacts to CSV
      const contactsToExport = filteredContacts.length > 0 ? filteredContacts : allContacts;
      if (contactsToExport.length === 0) {
        showAlert('warning', 'No contacts to export');
        return;
      }
      
      // Create CSV content
      const headers = ['First Name', 'Last Name', 'Email', 'Phone', 'City', 'State', 'Assignee'];
      const csvContent = [
        headers.join(','),
        ...contactsToExport.map(contact => [
          contact.first_name || '',
          contact.last_name || '',
          contact.email || '',
          contact.phone || '',
          contact.city || '',
          contact.state || '',
          contact.assignee || ''
        ].map(field => `"${field}"`).join(','))
      ].join('\n');
      
      // Download CSV
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'contacts.csv';
      link.click();
      window.URL.revokeObjectURL(url);
      
      showAlert('success', `Exported ${contactsToExport.length} contacts`);
    }

    function handleSearchInput() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
      
      if (!searchTerm) {
        filteredContacts = [...allContacts];
        hideSuggestions();
      } else {
        filteredContacts = allContacts.filter(contact => {
          return Object.values(contact).some(value => 
            value && value.toString().toLowerCase().includes(searchTerm)
          );
        });
        showSuggestions(searchTerm);
      }
      
      // Apply saved sort if it exists
      if (appliedSortLevels.length > 0) {
        applySavedSort();
      } else {
        currentPage = 1;
        renderContacts();
      }
      
      console.log('Search input changed for "' + searchTerm + '", found ' + filteredContacts.length + ' contacts');
    }

    function handleSearch() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
      
      // Always hide suggestions when search button is clicked
      hideSuggestions();
      
      if (!searchTerm) {
        filteredContacts = [...allContacts];
      } else {
        filteredContacts = allContacts.filter(contact => {
          return Object.values(contact).some(value => 
            value && value.toString().toLowerCase().includes(searchTerm)
          );
        });
      }
      
      // Apply saved sort if it exists
      if (appliedSortLevels.length > 0) {
        applySavedSort();
      } else {
        currentPage = 1;
        renderContacts();
      }
      
      console.log('Search performed for "' + searchTerm + '", found ' + filteredContacts.length + ' contacts');
    }

    function showSuggestions(searchTerm) {
      const suggestions = document.getElementById('search-suggestions');
      const uniqueSuggestions = new Set();
      
      // Get field-specific suggestions
      allContacts.forEach(contact => {
        Object.entries(contact).forEach(([key, value]) => {
          if (value && value.toString().toLowerCase().includes(searchTerm)) {
            uniqueSuggestions.add(value.toString());
          }
        });
      });
      
      const suggestionArray = Array.from(uniqueSuggestions).slice(0, 8);
      
      if (suggestionArray.length > 0) {
        suggestions.innerHTML = suggestionArray.map(suggestion => 
          `<div class="suggestion-item" onclick="selectSuggestion('${suggestion}')">${suggestion}</div>`
        ).join('');
        suggestions.style.display = 'block';
      } else {
        suggestions.style.display = 'none';
      }
    }

    function selectSuggestion(suggestion) {
      document.getElementById('search-input').value = suggestion;
      // Immediately hide suggestions when a suggestion is clicked
      hideSuggestions();
      // Update the search results without showing suggestions again
      handleSearch();
    }

    function hideSuggestions() {
      document.getElementById('search-suggestions').style.display = 'none';
    }

    // Sort modal functions
    let sortLevels = [];
    let appliedSortLevels = []; // Remember the last applied sort
    const maxSortLevels = 8;
    
    const sortableColumns = [
      { value: 'first_name', label: 'First Name' },
      { value: 'last_name', label: 'Last Name' },
      { value: 'email', label: 'Email' },
      { value: 'phone', label: 'Phone' },
      { value: 'city', label: 'City' },
      { value: 'state', label: 'State' },
      { value: 'assignee', label: 'Assignee' },
      { value: 'sponsor', label: 'Sponsor' },
      { value: 'sponsor_first', label: 'Sponsor First' },
      { value: 'sponsor_last', label: 'Sponsor Last' },
      { value: 'date_created', label: 'Date Created' },
      { value: 'zip', label: 'Zip Code' },
      { value: 'user_id', label: 'Sparky ID' },
      { value: 'valid', label: 'Valid' },
      { value: 'address', label: 'Address' },
      { value: 'timezone', label: 'Timezone' },
      { value: 'carrier', label: 'Carrier' },
      { value: 'country', label: 'Country' }
    ];

    function initializeSortModal() {
      sortLevels = [];
      const sortLevelsContainer = document.getElementById('sort-levels');
      sortLevelsContainer.innerHTML = '';
      
      // If we have applied sort levels, restore them
      if (appliedSortLevels.length > 0) {
        appliedSortLevels.forEach(appliedLevel => {
          addSortLevel();
          const levelIndex = sortLevels.length - 1;
          sortLevels[levelIndex] = { ...appliedLevel };
          
          // Set the values in the UI
          const levelDiv = sortLevelsContainer.children[levelIndex];
          const columnSelect = levelDiv.querySelector('.sort-column');
          const directionSelect = levelDiv.querySelector('.sort-direction');
          
          columnSelect.value = appliedLevel.column;
          directionSelect.value = appliedLevel.direction;
        });
      } else {
        // Add first sort level if no previous sort exists
        addSortLevel();
      }
    }

    function addSortLevel() {
      if (sortLevels.length >= maxSortLevels) {
        showAlert('info', `Maximum ${maxSortLevels} sort levels allowed`);
        return;
      }

      const levelIndex = sortLevels.length;
      const sortLevel = {
        column: '',
        direction: 'asc'
      };
      
      sortLevels.push(sortLevel);

      const sortLevelsContainer = document.getElementById('sort-levels');
      const levelDiv = document.createElement('div');
      levelDiv.className = 'sort-level';
      levelDiv.style.cssText = 'margin-bottom: 5px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;';
      
      levelDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px; font-size: 12px;">
          <span style="min-width: 60px; font-weight: bold;">Level ${levelIndex + 1}:</span>
          <select class="sort-column" data-level="${levelIndex}" style="flex: 1; padding: 3px; font-size: 12px;">
            <option value="">Select Column</option>
            ${sortableColumns.map(col => `<option value="${col.value}">${col.label}</option>`).join('')}
          </select>
          <select class="sort-direction" data-level="${levelIndex}" style="padding: 3px; font-size: 12px;">
            <option value="asc">A→Z</option>
            <option value="desc">Z→A</option>
          </select>
          ${levelIndex > 0 ? `<button class="remove-level" data-level="${levelIndex}" style="padding: 2px 6px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">×</button>` : ''}
        </div>
      `;

      sortLevelsContainer.appendChild(levelDiv);

      // Update Add Level button visibility
      const addButton = document.getElementById('add-sort-level');
      if (sortLevels.length >= maxSortLevels) {
        addButton.style.display = 'none';
      } else {
        addButton.style.display = 'inline-block';
      }

      // Add event listeners
      const columnSelect = levelDiv.querySelector('.sort-column');
      const directionSelect = levelDiv.querySelector('.sort-direction');
      const removeButton = levelDiv.querySelector('.remove-level');

      columnSelect.addEventListener('change', (e) => {
        sortLevels[levelIndex].column = e.target.value;
      });

      directionSelect.addEventListener('change', (e) => {
        sortLevels[levelIndex].direction = e.target.value;
      });

      if (removeButton) {
        removeButton.addEventListener('click', () => {
          removeSortLevel(levelIndex);
        });
      }
    }

    function removeSortLevel(levelIndex) {
      // Remove from array
      sortLevels.splice(levelIndex, 1);
      
      // Rebuild the entire UI to fix level numbers
      rebuildSortLevels();
    }

    function rebuildSortLevels() {
      const sortLevelsContainer = document.getElementById('sort-levels');
      sortLevelsContainer.innerHTML = '';
      
      // Save current values
      const currentLevels = [...sortLevels];
      sortLevels = [];
      
      // Recreate each level
      currentLevels.forEach((level, index) => {
        addSortLevel();
        
        // Restore values
        const levelDiv = sortLevelsContainer.children[index];
        const columnSelect = levelDiv.querySelector('.sort-column');
        const directionSelect = levelDiv.querySelector('.sort-direction');
        
        columnSelect.value = level.column;
        directionSelect.value = level.direction;
        sortLevels[index] = { ...level };
      });
    }

    function clearAllSortLevels() {
      sortLevels = [];
      appliedSortLevels = []; // Clear saved sort as well
      const sortLevelsContainer = document.getElementById('sort-levels');
      sortLevelsContainer.innerHTML = '';
      
      // Add first level back
      addSortLevel();
      
      // Re-render contacts without sorting
      filteredContacts = [...allContacts];
      if (document.getElementById('search-input').value.trim()) {
        // Reapply current search filter
        handleSearch();
      } else {
        currentPage = 1;
        renderContacts();
      }
      
      // Update sort indicator
      updateSortIndicator();
    }

    function applySortToContacts() {
      // Filter out empty sort levels
      const validSortLevels = sortLevels.filter(level => level.column);
      
      if (validSortLevels.length === 0) {
        showAlert('warning', 'Please select at least one column to sort by');
        return;
      }

      console.log('Applying sort with levels:', validSortLevels);

      // Save the applied sort configuration
      appliedSortLevels = validSortLevels.map(level => ({ ...level }));

      // Apply the sort
      applySavedSort();
      
      // Update sort indicator
      updateSortIndicator();
      
      // Close modal
      document.getElementById('sort-modal').style.display = 'none';
      
      const levelText = validSortLevels.length === 1 ? 'level' : 'levels';
      showAlert('success', `Contacts sorted by ${validSortLevels.length} ${levelText}`);
    }

    function applySavedSort() {
      if (appliedSortLevels.length === 0) {
        return; // No sort to apply
      }

      // Apply multi-level sorting
      filteredContacts.sort((a, b) => {
        for (const level of appliedSortLevels) {
          const aValue = a[level.column] || '';
          const bValue = b[level.column] || '';
          
          let comparison = 0;
          
          // Handle different data types
          if (level.column === 'date_created') {
            const aDate = new Date(aValue);
            const bDate = new Date(bValue);
            comparison = aDate - bDate;
          } else if (typeof aValue === 'number' && typeof bValue === 'number') {
            comparison = aValue - bValue;
          } else {
            // String comparison
            const aStr = String(aValue).toLowerCase();
            const bStr = String(bValue).toLowerCase();
            comparison = aStr.localeCompare(bStr);
          }
          
          if (comparison !== 0) {
            return level.direction === 'desc' ? -comparison : comparison;
          }
        }
        return 0;
      });

      // Refresh the display
      currentPage = 1;
      renderContacts();
    }

    // Utility functions for contact selection
    function getSelectedContacts() {
      return Array.from(selectedContactIds);
    }

    function clearContactSelections() {
      selectedContactIds.clear();
      
      // Uncheck all checkboxes
      document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // Remove selected class from all rows
      document.querySelectorAll('tr.selected').forEach(row => {
        row.classList.remove('selected');
      });
      
      // Update header checkbox and buttons
      updateHeaderCheckboxAndDeleteButton();
    }

    function updateSortIndicator() {
      const sortIndicator = document.getElementById('sort-indicator');
      if (sortIndicator) {
        if (appliedSortLevels.length > 0) {
          sortIndicator.style.display = 'inline';
          sortIndicator.title = `Sorted by ${appliedSortLevels.length} level${appliedSortLevels.length > 1 ? 's' : ''}`;
        } else {
          sortIndicator.style.display = 'none';
        }
      }
    }

    function showAlert(type, message) {
      console.log(`[${type.toUpperCase()}] ${message}`);
      // Simple alert for now to ensure user sees messages
      alert(`${type.toUpperCase()}: ${message}`);
    }

    // Stub function to prevent ReferenceError
    function handleDuplicates() {
      console.log('handleDuplicates called - not implemented yet');
      showAlert('info', 'Duplicate handling feature is not yet implemented');
    }

    function updateStats() {
      console.log('Stats updated - Total contacts:', allContacts.length, 'Filtered:', filteredContacts.length);
    }

    // Utility function to add timeout to async operations
    function withTimeout(promise, timeoutMs = 10000, operation = 'operation') {
      return Promise.race([
        promise,
        new Promise((_, reject) =>
          setTimeout(() => reject(new Error(`${operation} timed out after ${timeoutMs}ms`)), timeoutMs)
        )
      ]);
    }

    // Role-based access helper functions
    async function getCurrentUser() {
      console.log('[DEBUG] getCurrentUser called');
      
      try {
        // Try to get user from global Supabase session (same way as global nav)
        const supabase = window.globalSupabase || window.supabase;
        if (supabase && supabase.auth) {
          console.log('[DEBUG] Getting user from Supabase session...');
          const sessionResult = await supabase.auth.getSession();
          const session = sessionResult.data.session;
          console.log('[DEBUG] Supabase session:', session);
          
          if (session && session.user) {
            const userId = session.user.id;
            const userEmail = session.user.email;
            console.log('[DEBUG] User from session - ID:', userId, 'Email:', userEmail);
            
            // For your specific email, map to the correct local user ID
            if (userEmail === 'john+2@tpnlife.com') {
              const user = {
                id: 'user-john+2-tpnlife-com',
                supabase_id: userId,
                email: userEmail,
                first_name: 'John',
                last_name: 'User',
                role: 'user'
              };
              console.log('[DEBUG] Using mapped user for john+2@tpnlife.com:', user);
              return user;
            } else if (userEmail === 'john+3@tpnlife.com') {
              const user = {
                id: 'user-manager-example-com',
                supabase_id: userId,
                email: userEmail,
                first_name: 'John',
                last_name: 'Manager',
                role: 'manager'
              };
              console.log('[DEBUG] Using mapped manager user for john+3@tpnlife.com:', user);
              return user;
            }
            
            // For other users, try to get profile data
            try {
              const { data: profileData, error } = await supabase
                .from('profiles')
                .select('first_name, last_name, email, role')
                .eq('id', userId)
                .maybeSingle();
                
              if (profileData) {
                const role = profileData.role || 'user';
                let localUserId;
                
                if (role === 'admin') {
                  localUserId = '63847570-8094-48c5-b531-24ae0ed00bd8';
                } else {
                  localUserId = 'user-' + userEmail.replace('@', '-').replace(/\./g, '-');
                }
                
                const user = {
                  id: localUserId,
                  supabase_id: userId,
                  email: profileData.email || userEmail,
                  first_name: profileData.first_name || '',
                  last_name: profileData.last_name || '',
                  role: role
                };
                console.log('[DEBUG] Using profile-based user:', user);
                return user;
              }
            } catch (profileError) {
              console.warn('[DEBUG] Profile lookup failed:', profileError);
            }
          }
        }
      } catch (e) {
        console.error('[DEBUG] Error getting user from Supabase:', e);
      }
      
      // Fallback: use demo admin
      console.warn('No user found, using demo manager user for testing.');
      return {
        id: 'user-manager-example-com',
        email: 'manager@example.com',
        first_name: 'Test',
        last_name: 'Manager',
        role: 'manager'
      };
    }
    
    function updateRoleBasedUI(userRole, isFiltered) {
      // Update page title and headers to show role-based context
      const pageTitle = document.querySelector('h1, .page-title');
      if (pageTitle) {
        const roleContext = userRole === 'admin' ? 'All Contacts' :
                           userRole === 'supervisor' ? 'Team Contacts' :
                           userRole === 'manager' ? 'Managed Contacts' :
                           'My Contacts';
        
        if (pageTitle.textContent && !pageTitle.textContent.includes('Contacts')) {
          pageTitle.textContent = roleContext;
        }
      }
      
      // Show role indicator in the UI
      const statsContainer = document.querySelector('.stats-container, .contact-stats');
      if (statsContainer && isFiltered) {
        let roleIndicator = document.getElementById('role-indicator');
        if (!roleIndicator) {
          roleIndicator = document.createElement('div');
          roleIndicator.id = 'role-indicator';
          roleIndicator.style.cssText = `
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
          `;
          statsContainer.appendChild(roleIndicator);
        }
        
        const roleLabels = {
          admin: '👑 Admin View',
          supervisor: '👥 Team View', 
          manager: '📋 Manager View',
          user: '👤 Personal View'
        };
        
        roleIndicator.textContent = roleLabels[userRole] || `${userRole} View`;
      }
      
      console.log(`UI updated for role: ${userRole}, filtered: ${isFiltered}`);
    }

    // Simple startup diagnostic for API server
    async function runStartupDiagnostic() {
      console.log('=== STARTUP DIAGNOSTIC ===');
      console.log('1. API Server mode: ENABLED');
      console.log('2. Current user check...');
      
      try {
        const currentUser = await getCurrentUser();
        console.log('3. Current user:', currentUser);
        
        if (!currentUser || !currentUser.id) {
          console.log('4. User authentication: FAILED - No user found');
          showAlert('error', 'User authentication required. Please log in through the global navigation.');
          return;
        }
        
        console.log('4. User authentication: SUCCESS');
        console.log('5. Testing API server connection...');
        
        // Test API server health
        const healthResponse = await fetch('/api/health');
        if (!healthResponse.ok) {
          throw new Error(`API server not responding: ${healthResponse.status}`);
        }
        
        const healthData = await healthResponse.json();
        console.log('6. API server health:', healthData);
        console.log('7. API server connection: SUCCESS');
        
      } catch (error) {
        console.log('API server connection: FAILED -', error.message);
        showAlert('error', `API server connection failed: ${error.message}. Please ensure the API server is running at http://localhost:3000`);
      }
      
      console.log('=== DIAGNOSTIC COMPLETE ===');
    }

    // Initialize app with diagnostic
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Contacts app starting...');
      adjustTableHeight();
      
      // Simplified startup - skip diagnostic that might be hanging
      setTimeout(async () => {
        try {
          console.log('Starting simplified initialization...');
          await withTimeout(initializeApp(), 15000, 'app initialization');
        } catch (error) {
          console.error('Startup failed:', error);
          showAlert('error', `Application startup failed: ${error.message}. Please refresh the page or check the console.`);
          
          // Fallback: try to load with demo data
          try {
            console.log('Attempting fallback initialization...');
            allContacts = [];
            filteredContacts = [];
            renderContacts();
            setupEventListeners();
          } catch (fallbackError) {
            console.error('Fallback also failed:', fallbackError);
          }
        }
      }, 100); // Small delay to ensure DOM is ready
    });

    // Adjust table height dynamically
    function adjustTableHeight() {
      const tableContainer = document.querySelector('.table-container');
      if (!tableContainer) return;
      
      const viewportHeight = window.innerHeight;
      const availableHeight = viewportHeight - 120;
      const bottomMargin = 40;
      
      const dynamicHeight = Math.max(200, availableHeight - bottomMargin);
      tableContainer.style.height = dynamicHeight + 'px';
      
      console.log('Table height adjusted to:', dynamicHeight, 'px');
    }

    async function initializeApp() {
      try {
        console.log('Initializing app...');
        
        // First try to load contacts with timeout
        await withTimeout(loadContacts(), 15000, 'contact loading');
        
        // Only setup event listeners if we get this far
        setupEventListeners();
        
        // Initialize delete button as disabled
        const deleteBtn = document.getElementById('delete-btn');
        if (deleteBtn) {
          deleteBtn.disabled = true;
          deleteBtn.style.opacity = '0.5';
          deleteBtn.style.cursor = 'not-allowed';
        }
        
        updateStats();
        
        if (allContacts.length === 0) {
          showAlert('info', 'No contacts found. The table may be empty or you may need to run the table setup script. Check the browser console for more details.');
        }
        
        // Test the column visibility modal functionality
        setTimeout(() => {
          testColumnVisibilityModal();
        }, 1000);
      } catch (error) {
        console.error('Error initializing app:', error);
        const errorMessage = error.message || 'Unknown error occurred';
        
        // Provide specific guidance based on error type
        let guidance = '';
        if (errorMessage.includes('does not exist')) {
          guidance = ' Please run the complete_contacts_table_setup.sql script in your Supabase SQL Editor.';
        } else if (errorMessage.includes('JWT') || errorMessage.includes('auth')) {
          guidance = ' Please check your Supabase URL and API key configuration.';
        } else if (errorMessage.includes('permission')) {
          guidance = ' Please check your Supabase RLS policies and table permissions.';
        } else if (errorMessage.includes('timed out')) {
          guidance = ' The operation took too long. Please check your internet connection and API server status.';
        }
        
        showAlert('error', `Failed to load contacts: ${errorMessage}.${guidance} Check the browser console for details.`);
        
        // Still render empty table so user can see the interface
        allContacts = [];
        filteredContacts = [];
        renderContacts();
      }
    }

    // Load contacts from Supabase
    async function loadContacts() {
      try {
        console.log('=== STARTING LOAD CONTACTS ===');
        console.log('Supabase client available:', !!supabase);
        console.log('Supabase client type:', typeof supabase);
        
        if (!supabase) {
          console.error('No Supabase client available');
          throw new Error('Supabase client not initialized');
        }
        
        if (typeof supabase.from !== 'function') {
          console.error('supabase.from is not a function:', typeof supabase.from);
          console.log('Supabase client object:', supabase);
          throw new Error('Invalid Supabase client - from method not available');
        }
        
        console.log('Loading contacts from Supabase...');
        console.log('Supabase client:', supabase);
        
        // First check if the table exists and get its structure
        console.log('Testing connection to contacts table...');
        const { data: testData, error: testError } = await supabase
          .from('contacts')
          .select('*')
          .limit(1);
        
        if (testError) {
          console.error('Error testing contacts table:', testError);
          
          // Provide specific error messages for common issues
          if (testError.message.includes('relation "contacts" does not exist')) {
            throw new Error('Contacts table does not exist. Please run the table creation SQL script in your Supabase database.');
          } else if (testError.message.includes('JWT')) {
            throw new Error('Authentication error. Please check your Supabase configuration and permissions.');
          } else {
            throw new Error(`Database connection error: ${testError.message}`);
          }
        }
        
        console.log('Contacts table accessible, loading all data...');
        const { data, error } = await supabase
          .from('contacts')
          .select('*')
          .order('id', { ascending: true });
          
          if (error) {
            console.error('Error querying contacts:', error);
            throw new Error(`Query error: ${error.message}`);
          }
          
          console.log('Raw data from Supabase:', data);
          console.log('Data type:', typeof data, 'Is array:', Array.isArray(data), 'Length:', data?.length);
          
          if (data && Array.isArray(data)) {
            // Map data and ensure all expected fields exist with defaults
            allContacts = data.map(contact => ({
              id: contact.id || '',
              sms: contact.sms || '',
              call: contact.call || '',
              email_flag: contact.email_flag || '',
              assignee: contact.assignee || '',
              sponsor: contact.sponsor || '',
              sponsor_first: contact.sponsor_first || '',
              sponsor_last: contact.sponsor_last || '',
              user_id: contact.user_id || '',
              first_name: contact.first_name || '',
              last_name: contact.last_name || '',
              email: contact.email || '',
              valid: contact.valid || (contact.email_valid ? 'Yes' : ''), // Handle both field names
              phone: contact.phone || '',
              address: contact.address || '',
              city: contact.city || '',
              state: contact.state || '',
              zip: contact.zip || '',
              ip_address: contact.ip_address || '',
              date_created: contact.date_created || '',
              timezone: contact.timezone || '',
              cell: contact.cell,
              carrier: contact.carrier || '',
              landline: contact.landline,
              voip: contact.voip,
              other_phone: contact.other_phone,
              foreign_number: contact.foreign_number,
              country: contact.country || 'US'
            }));
            
            filteredContacts = [...allContacts];
            
            // Apply saved sort if it exists
            if (appliedSortLevels.length > 0) {
              applySavedSort();
            } else {
              renderContacts();
            }
            
            console.log('Successfully loaded ' + allContacts.length + ' contacts from Supabase');
            return;
          } else {
            console.warn('No data returned from Supabase, initializing empty arrays');
            allContacts = [];
            filteredContacts = [];
            renderContacts();
            return;
          }
          
        } catch (error) {
          console.error('Error loading contacts from Supabase:', error);
          console.error('Error details:', {
            message: error.message,
            stack: error.stack,
            supabaseConnected: !!supabase,
            supabaseUrl: SUPABASE_URL
          });
          
          // Initialize empty arrays if Supabase fails
          allContacts = [];
          filteredContacts = [];
          renderContacts();
          
          throw error; // Re-throw to be handled by initializeApp
        }
      }
    // Test the column visibility modal functionality
    function testColumnVisibilityModal() {
      console.log('=== TESTING COLUMN VISIBILITY MODAL ===');
      
      // Test opening modal
      const modal = document.getElementById('column-visibility-modal');
      const openBtn = document.getElementById('open-column-modal');
      const closeBtn = document.getElementById('close-column-modal');
      
      console.log('Modal element found:', !!modal);
      console.log('Open button found:', !!openBtn);
      console.log('Close button found:', !!closeBtn);
      
      // Test checkboxes
      const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
      console.log('Number of checkboxes found:', checkboxes.length);
      
      // Test some column visibility toggles
      const table = document.querySelector('.table');
      const allColumns = table.querySelectorAll('th');
      console.log('Total table columns:', allColumns.length);
      
      // Test the first toggleable column (should be column 6 - index 5)
      if (checkboxes.length > 0) {
        const firstCheckbox = checkboxes[0];
        const columnIndex = parseInt(firstCheckbox.dataset.column);
        console.log('First checkbox controls column:', columnIndex);
        
        // Test hiding/showing
        toggleColumnVisibility(columnIndex, false);
        console.log('Column', columnIndex, 'hidden');
        
        setTimeout(() => {
          toggleColumnVisibility(columnIndex, true);
          console.log('Column', columnIndex, 'shown again');
        }, 1000);
      }
      
    }

    function renderContacts() {
      console.log('renderContacts called - pageSize:', pageSize, 'currentPage:', currentPage, 'filteredContacts.length:', filteredContacts.length);
      const tbody = document.getElementById('contacts-tbody');
      
      if (!tbody) {
        console.error('Tbody element not found!');
        return;
      }
      
      tbody.innerHTML = '';
      
      if (filteredContacts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="30" style="text-align: center; padding: 40px; color: #6c757d;">No contacts found</td></tr>';
        return;
      }

      // Calculate pagination
      let contactsToShow;
      if (pageSize === 'all') {
        contactsToShow = filteredContacts;
      } else {
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        contactsToShow = filteredContacts.slice(startIndex, endIndex);
      }

      contactsToShow.forEach((contact, index) => {
        const row = document.createElement('tr');
        
        // Calculate row number based on pagination
        const rowNumber = pageSize === 'all' ? index + 1 : ((currentPage - 1) * pageSize) + index + 1;
        
        // All columns are now editable except the checkbox
        row.innerHTML = 
          '<td><input type="checkbox" class="contact-checkbox checkbox" data-id="' + contact.id + '"></td>' +
          '<td class="editable-cell" data-field="sms" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.sms || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="call" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.call || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="email_flag" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.email_flag || '') + '</span>' +
          '</td>' +
          '<td class="readonly-cell">' + 
            '<span class="cell-content">' + rowNumber + '</span>' +
          '</td>' +
          '<td class="readonly-cell">' + 
            '<span class="cell-content">' + (contact.id || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="assignee" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.assignee || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="sponsor" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.sponsor || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="sponsor_first" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.sponsor_first || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="sponsor_last" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.sponsor_last || '') + '</span>' +
          '</td>' +
          '<td class="readonly-cell">' + 
            '<span class="cell-content">' + (contact.user_id || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="first_name" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.first_name || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="last_name" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.last_name || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="email" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.email || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="valid" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.valid || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="phone" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.phone || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="address" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.address || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="city" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.city || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="state" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.state || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="zip" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.zip || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="ip_address" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.ip_address || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="date_created" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.date_created || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="timezone" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.timezone || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="cell" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.cell ? 'Yes' : (contact.cell === false ? 'No' : '')) + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="carrier" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.carrier || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="landline" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.landline ? 'Yes' : (contact.landline === false ? 'No' : '')) + '</span>' +
          '</td>' +
                   '<td class="editable-cell" data-field="voip" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.voip ? 'Yes' : (contact.voip === false ? 'No' : '')) + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="other_phone" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.other_phone ? 'Yes' : (contact.other_phone === false ? 'No' : '')) + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="foreign_number" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.foreign_number ? 'Yes' : (contact.foreign_number === false ? 'No' : '')) + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="country" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.country || '') + '</span>' +
          '</td>';
        
        tbody.appendChild(row);
      });
      
      // Update pagination
      updatePagination();
      
      // Add event listeners to checkboxes
      document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', handleContactSelection);
      });
      
      // Add event listeners to editable cells
      document.querySelectorAll('.editable-cell').forEach(cell => {
        cell.addEventListener('click', function(e) {
          if (!this.classList.contains('editing')) {
            makeEditable(this);
          }
        });
        
        cell.addEventListener('dblclick', function(e) {
          if (!this.classList.contains('editing')) {
            makeEditable(this);
          }
        });
      });
      
      console.log('renderContacts completed - rendered ' + contactsToShow.length + ' rows');
      updatePagination();
    }

    function handleContactSelection(event) {
      const contactId = event.target.dataset.id; // Keep as string for UUID
      const row = event.target.closest('tr');
      
           
      console.log('Contact selection - ID:', contactId, 'Type:', typeof contactId);
      
      if (event.target.checked) {
        selectedContactIds.add(contactId);
        row.classList.add('selected');
        console.log('Contact selected, added to selectedContactIds'); // Debug log
      } else {
        selectedContactIds.delete(contactId);
        row.classList.remove('selected');
        console.log('Contact deselected, removed from selectedContactIds'); // Debug log
      }
      
      // Update header checkbox and delete button state
      updateHeaderCheckboxAndDeleteButton();
      
      console.log('Selected contacts:', Array.from(selectedContactIds));
    }

    function updateHeaderCheckboxAndDeleteButton() {
      const headerCheckbox = document.getElementById('header-checkbox');
      const deleteBtn = document.getElementById('delete-btn');
      const selectAllToggle = document.getElementById('select-all-toggle');
      const totalContactsCount = document.getElementById('total-contacts-count');
      const selectedCount = document.getElementById('selected-count');
      const allCheckboxes = document.querySelectorAll('.contact-checkbox');
      const checkedCheckboxes = document.querySelectorAll('.contact-checkbox:checked');
      
      // Update selected count display
      if (selectedCount) {
        selectedCount.textContent = selectedContactIds.size;
      }
      
      if (totalContactsCount) {
        totalContactsCount.textContent = filteredContacts.length;
      }
      
      // Show/hide select all toggle
      if (selectAllToggle) {
        if (selectedContactIds.size > 0) {
          selectAllToggle.style.display = 'block';
        } else {
          selectAllToggle.style.display = 'none';
        }
      }
      
      // Update header checkbox state
      if (headerCheckbox) {
        if (allCheckboxes.length === 0) {
          headerCheckbox.indeterminate = false;
          headerCheckbox.checked = false;
        } else if (checkedCheckboxes.length === allCheckboxes.length) {
          headerCheckbox.indeterminate = false;
          headerCheckbox.checked = true;
        } else if (checkedCheckboxes.length > 0) {
          headerCheckbox.indeterminate = true;
          headerCheckbox.checked = false;
        } else {
          headerCheckbox.indeterminate = false;
          headerCheckbox.checked = false;
        }
      }
      
      // Update delete button state
      if (deleteBtn) {
        // Disable delete button if header checkbox is checked (all contacts selected) or if no contacts selected
        const isHeaderChecked = headerCheckbox && headerCheckbox.checked && !headerCheckbox.indeterminate;
        
        if (selectedContactIds.size > 0 && !isHeaderChecked) {
          deleteBtn.disabled = false;
          deleteBtn.style.opacity = '1';
          deleteBtn.style.cursor = 'pointer';
        } else {
          deleteBtn.disabled = true;
          deleteBtn.style.opacity = '0.5';
          deleteBtn.style.cursor = 'not-allowed';
        }
      }
    }

    function updatePagination() {
      const paginationContainer = document.getElementById('pagination');
      const contactCountDisplay = document.getElementById('contact-count-display');
      
      if (contactCountDisplay) {
        contactCountDisplay.textContent = `Showing ${filteredContacts.length} contacts`;
      }
      
      if (paginationContainer) {
        if (pageSize === 'all' || filteredContacts.length <= pageSize) {
          // No pagination needed
          paginationContainer.innerHTML = '';
          return;
        }
        
        const totalPages = Math.ceil(filteredContacts.length / pageSize);
        
        let paginationHTML = '';
        
        // Previous button
        if (currentPage > 1) {
          paginationHTML += `<button onclick="changePage(${currentPage - 1})">&laquo; Previous</button>`;
        }
        
        // Page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        // Adjust start page if we're near the end
        if (endPage - startPage < maxVisiblePages - 1) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        // First page and ellipsis
        if (startPage > 1) {
          paginationHTML += `<button onclick="changePage(1)" ${currentPage === 1 ? 'class="active"' : ''}>1</button>`;
          if (startPage > 2) {
            paginationHTML += `<span style="color: #6c757d; padding: 0 8px; display: inline-flex; align-items: center;">...</span>`;
          }
        }
        
        // Page number buttons
        for (let i = startPage; i <= endPage; i++) {
          paginationHTML += `<button onclick="changePage(${i})" ${currentPage === i ? 'class="active"' : ''}>${i}</button>`;
        }
        
        // Last page and ellipsis
        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            paginationHTML += `<span style="color: #6c757d; padding: 0 8px; display: inline-flex; align-items: center;">...</span>`;
          }
          paginationHTML += `<button onclick="changePage(${totalPages})" ${currentPage === totalPages ? 'class="active"' : ''}>${totalPages}</button>`;
        }
        
        // Next button
        if (currentPage < totalPages) {
          paginationHTML += `<button onclick="changePage(${currentPage + 1})">Next &raquo;</button>`;
        }
        
        paginationContainer.innerHTML = paginationHTML;
      }
    }
    
    function changePage(page) {
      const totalPages = Math.ceil(filteredContacts.length / pageSize);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderContacts();
      }
    }

    function displayUsers(usersToShow) {
      const userResults = document.getElementById('user-results');
      if (!userResults) return;
      
      if (!usersToShow || usersToShow.length === 0) {
        userResults.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">No users found</div>';
        return;
      }
      
      userResults.innerHTML = usersToShow.map((user, index) => `
        <div class="user-item ${index % 2 === 1 ? 'user-item-alt' : ''}" data-user-id="${user.id}">
          <div class="user-info">
            <div class="user-name">${user.name} - ${user.role}</div>
          </div>
        </div>
      `).join('');
      
      // Add click listeners to user items
      document.querySelectorAll('.user-item').forEach(item => {
        item.addEventListener('click', function() {
          // Clear previous selections
          document.querySelectorAll('.user-item.selected').forEach(selectedItem => {
            selectedItem.classList.remove('selected');
          });
          
          // Select this item
          this.classList.add('selected');
          
          // Update UI
          const userId = this.getAttribute('data-user-id');
          const user = users.find(u => u.id === userId);
          
          if (user) {
            const selectedUserDiv = document.getElementById('selected-user');
            const selectedUserName = document.getElementById('selected-user-name');
            
            if (selectedUserDiv && selectedUserName) {
              selectedUserName.textContent = user.name;
              selectedUserDiv.style.display = 'block';
            }
            
            // Enable confirm button
            const confirmBtn = document.getElementById('confirm-assign');
            if (confirmBtn) {
              confirmBtn.disabled = false;
            }
          }
        });
      });
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const csvData = e.target.result;
          const lines = csvData.split('\n');
          const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
          
          importData = [];
          for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim()) {
              const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
              const contact = {};
              headers.forEach((header, index) => {
                contact[header.toLowerCase().replace(/\s+/g, '_')] = values[index] || '';
              });
              importData.push(contact);
            }
          }
          
          // Show preview
          const previewDiv = document.getElementById('import-preview');
          const previewTable = document.getElementById('preview-table');
          const totalRows = document.getElementById('total-rows');
          
          if (previewDiv && previewTable && totalRows) {
            previewDiv.style.display = 'block';
            totalRows.textContent = importData.length;
            
            // Create preview table
            const previewData = importData.slice(0, 5);
            let tableHTML = '<table style="width: 100%; font-size: 12px;"><thead><tr>';
            headers.forEach(header => {
              tableHTML += `<th style="padding: 5px; border: 1px solid #ddd;">${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            previewData.forEach(row => {
              tableHTML += '<tr>';
              headers.forEach(header => {
                const value = row[header.toLowerCase().replace(/\s+/g, '_')] || '';
                tableHTML += `<td style="padding: 5px; border: 1px solid #ddd;">${value}</td>`;
              });
              tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            previewTable.innerHTML = tableHTML;
            
            // Enable import button
            const confirmImportBtn = document.getElementById('confirm-import');
            if (confirmImportBtn) {
              confirmImportBtn.disabled = false;
            }
          }
          
        } catch (error) {
          console.error('Error parsing CSV:', error);
          showAlert('error', 'Error parsing CSV file. Please check the format.');
        }
      };
      
      reader.readAsText(file);
    }

    function setupEventListeners() {
      // Button event listeners
      const deleteBtn = document.getElementById('delete-btn');
      const assignBtn = document.getElementById('assign-btn');
      const smsBtn = document.getElementById('sms-btn');
      const emailBtn = document.getElementById('email-btn');
      const rvmBtn = document.getElementById('rvm-btn');
      const campaignBtn = document.getElementById('campaign-btn');
      const addBtn = document.getElementById('add-btn');
      const importBtn = document.getElementById('import-btn');
      const exportBtn = document.getElementById('export-btn');
      const searchBtn = document.getElementById('search-btn');
      const resetBtn = document.getElementById('reset-btn');
      
      if (deleteBtn) deleteBtn.addEventListener('click', handleDelete);
      if (assignBtn) assignBtn.addEventListener('click', handleAssign);
      if (smsBtn) smsBtn.addEventListener('click', handleSMS);
      if (emailBtn) emailBtn.addEventListener('click', handleEmail);
      if (rvmBtn) rvmBtn.addEventListener('click', handleRVM);
      if (campaignBtn) campaignBtn.addEventListener('click', handleCampaign);
      if (addBtn) addBtn.addEventListener('click', handleAdd);
      if (importBtn) importBtn.addEventListener('click', handleImport);
      if (exportBtn) exportBtn.addEventListener('click', handleExport);
      if (searchBtn) searchBtn.addEventListener('click', handleSearch);
      if (resetBtn) resetBtn.addEventListener('click', () => {
        document.getElementById('search-input').value = '';
        filteredContacts = [...allContacts];
        
        // Apply saved sort if it exists
        if (appliedSortLevels.length > 0) {
          applySavedSort();
        } else {
          currentPage = 1;
          renderContacts();
        }
        
        hideSuggestions();
      });
      
      // Search input event listener
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.addEventListener('input', handleSearchInput);
        searchInput.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            hideSuggestions();
          }
        });
      }
      
      // Header checkbox event listener
      const headerCheckbox = document.getElementById('header-checkbox');
      if (headerCheckbox) {
        headerCheckbox.addEventListener('change', function(e) {
          const isChecked = e.target.checked;
          document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
            checkbox.checked = isChecked;
            const contactId = checkbox.dataset.id;
            const row = checkbox.closest('tr');
            
            if (isChecked) {
              selectedContactIds.add(contactId);
              row.classList.add('selected');
            } else {
              selectedContactIds.delete(contactId);
              row.classList.remove('selected');
            }
          });
          updateHeaderCheckboxAndDeleteButton();
        });
      }
      
      // Modal event listeners
      setupModalEventListeners();
      
      // Global click listener to hide suggestions when clicking outside search area
      document.addEventListener('click', function(e) {
        const searchGroup = document.querySelector('.search-group');
        const suggestions = document.getElementById('search-suggestions');
        
        // Hide suggestions if clicking outside the search group and suggestions are visible
        if (searchGroup && suggestions && !searchGroup.contains(e.target)) {
          hideSuggestions();
        }
      });
      
      // File input event listener
      const csvFileInput = document.getElementById('csv-file');
      if (csvFileInput) {
        csvFileInput.addEventListener('change', handleFileSelect);
      }
      
      // Page size selector event listener
      const pageSizeSelect = document.getElementById('page-size-select');
      if (pageSizeSelect) {
        // Set initial value to match the pageSize variable
        pageSizeSelect.value = pageSize.toString();
        
        pageSizeSelect.addEventListener('change', function(e) {
          const newPageSize = e.target.value === 'all' ? 'all' : parseInt(e.target.value);
          pageSize = newPageSize;
          currentPage = 1; // Reset to first page when changing page size
          console.log('Page size changed to:', pageSize);
          renderContacts();
        });
      }
      
      // Cell editing event delegation
      const contactsTable = document.getElementById('contacts-table');
      if (contactsTable) {
        contactsTable.addEventListener('click', function(e) {
          const cell = e.target.closest('.editable-cell');
          if (cell) {
            makeEditable(cell);
          }
        });
      }
      
      // Checkbox event delegation
      if (contactsTable) {
        contactsTable.addEventListener('change', function(e) {
          if (e.target.classList.contains('contact-checkbox')) {
            const contactId = e.target.dataset.id;
            const row = e.target.closest('tr');
            
            if (e.target.checked) {
              selectedContactIds.add(contactId);
              row.classList.add('selected');
            } else {
              selectedContactIds.delete(contactId);
              row.classList.remove('selected');
            }
            updateHeaderCheckboxAndDeleteButton();
          }
        });
      }

      console.log('Event listeners set up successfully');
    }

    function setupModalEventListeners() {
      // Close buttons for all modals
      document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.addEventListener('click', function() {
          this.closest('.modal').style.display = 'none';
        });
      });
      
      // Modal background click to close
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            this.style.display = 'none';
          }
        });
      });
      
      // User modal buttons
      const cancelAssignBtn = document.getElementById('cancel-assign');
      const confirmAssignBtn = document.getElementById('confirm-assign');
      const unassignBtn = document.getElementById('unassign-selected');
      
      if (cancelAssignBtn) {
        cancelAssignBtn.addEventListener('click', () => {
          document.getElementById('user-modal').style.display = 'none';
        });
      }
      
      if (confirmAssignBtn) {
        confirmAssignBtn.addEventListener('click', confirmAssign);
      }
      
      if (unassignBtn) {
        unassignBtn.addEventListener('click', confirmUnassign);
      }
      
      // User search functionality
      const userSearchInput = document.getElementById('user-search');
      if (userSearchInput) {
        userSearchInput.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          if (searchTerm.trim() === '') {
            displayUsers(users);
          } else {
            const filteredUsers = users.filter(user => 
              user.name.toLowerCase().includes(searchTerm) ||
              user.email.toLowerCase().includes(searchTerm) ||
              user.role.toLowerCase().includes(searchTerm)
            );
            displayUsers(filteredUsers);
          }
        });
      }
      
      // Add contact modal buttons
      const cancelAddBtn = document.getElementById('cancel-add');
      const confirmAddBtn = document.getElementById('confirm-add');
      
      if (cancelAddBtn) {
        cancelAddBtn.addEventListener('click', () => {
          document.getElementById('add-contact-modal').style.display = 'none';
        });
      }
      
      if (confirmAddBtn) {
        confirmAddBtn.addEventListener('click', async () => {
          const form = document.getElementById('add-contact-form');
          const formData = new FormData(form);
          const newContact = Object.fromEntries(formData.entries());
          
          try {
            // Add current user assignment if not specified
            const currentUser = await getCurrentUser();
            if (!newContact.assigned_to && currentUser) {
              newContact.assigned_to = currentUser.id;
            }
            
            const response = await fetch('/api/contacts', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(newContact)
            });
            
            if (!response.ok) {
              throw new Error(`API request failed: ${response.status} ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.error) {
              throw new Error(result.message || 'Failed to add contact');
            }
            
            showAlert('success', 'Contact added successfully');
            document.getElementById('add-contact-modal').style.display = 'none';
            await loadContacts(); // Reload contacts
            
          } catch (error) {
            console.error('Error adding contact:', error);
            showAlert('error', 'Failed to add contact: ' + error.message);
          }
        });
      }
      
      // Import modal buttons
      const cancelImportBtn = document.getElementById('cancel-import');
      const confirmImportBtn = document.getElementById('confirm-import');
      
      if (cancelImportBtn) {
        cancelImportBtn.addEventListener('click', () => {
          document.getElementById('import-modal').style.display = 'none';
        });
      }
      
      if (confirmImportBtn) {
        confirmImportBtn.addEventListener('click', async () => {
          if (importData.length === 0) {
            showAlert('warning', 'No data to import');
            return;
          }
          
          try {
            const response = await fetch('/api/contacts/import', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ contacts: importData })
            });
            
            if (!response.ok) {
              throw new Error(`API request failed: ${response.status} ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.error) {
              throw new Error(result.message || 'Failed to import contacts');
            }
            
            showAlert('success', `Successfully imported ${result.imported} contacts`);
            if (result.errors && result.errors.length > 0) {
              console.warn('Import errors:', result.errors);
              showAlert('warning', `${result.errors.length} contacts had errors. Check console for details.`);
            }
            
            document.getElementById('import-modal').style.display = 'none';
            await loadContacts(); // Reload contacts
            
          } catch (error) {
            console.error('Error importing contacts:', error);
            showAlert('error', 'Failed to import contacts: ' + error.message);
          }
        });
      }
      
      // Delete modal buttons
      const cancelDeleteBtn = document.getElementById('cancel-delete');
      const confirmDeleteBtn = document.getElementById('confirm-delete');
      
      if (cancelDeleteBtn) {
        cancelDeleteBtn.addEventListener('click', () => {
          document.getElementById('delete-modal').style.display = 'none';
        });
      }
      
      if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', async () => {
          const selectedContacts = getSelectedContacts();
          
          try {
            const { error } = await supabase
              .from('contacts')
              .delete()
              .in('id', selectedContacts);
              
            if (error) throw error;
            
            showAlert('success', `Successfully deleted ${selectedContacts.length} contact(s)`);
            document.getElementById('delete-modal').style.display = 'none';
            clearContactSelections();
            await loadContacts(); // Reload contacts
            
          } catch (error) {
            console.error('Error deleting contacts:', error);
            showAlert('error', 'Failed to delete contacts: ' + error.message);
          }
        });
      }

      // Sort modal buttons
      const sortBtn = document.getElementById('sort-btn');
      const cancelSortBtn = document.getElementById('cancel-sort');
      const applySortBtn = document.getElementById('apply-sort');
      const addSortLevelBtn = document.getElementById('add-sort-level');
      const clearSortBtn = document.getElementById('clear-sort');

      if (sortBtn) {
        sortBtn.addEventListener('click', handleSort);
      }

      if (cancelSortBtn) {
        cancelSortBtn.addEventListener('click', () => {
          document.getElementById('sort-modal').style.display = 'none';
        });
      }

      if (applySortBtn) {
        applySortBtn.addEventListener('click', applySortToContacts);
      }

      if (addSortLevelBtn) {
        addSortLevelBtn.addEventListener('click', addSortLevel);
      }

      if (clearSortBtn) {
        clearSortBtn.addEventListener('click', clearAllSortLevels);
      }

      // Column modal buttons
      const showAllColumnsBtn = document.getElementById('show-all-columns');
      const hideAllColumnsBtn = document.getElementById('hide-all-columns');
      const closeColumnModalBtn = document.getElementById('close-column-modal');

      if (showAllColumnsBtn) {
        showAllColumnsBtn.addEventListener('click', showAllColumns);
      }

      if (hideAllColumnsBtn) {
        hideAllColumnsBtn.addEventListener('click', hideAllColumns);
      }

      if (closeColumnModalBtn) {
        closeColumnModalBtn.addEventListener('click', () => {
          document.getElementById('column-modal').style.display = 'none';
        });
      }

      // Column toggle checkboxes
      document.querySelectorAll('.column-toggle').forEach(checkbox => {
        checkbox.addEventListener('change', handleColumnToggle);
      });
    }

    // Column visibility functions
    function toggleColumn(columnName, visible) {
      const table = document.getElementById('contacts-table');
      if (!table) return;
      
      // Map column names to their positions in the table
      const columnMap = {
        'contact_id': 5,
        'assignee': 6,
        'sponsor': 7,
        'sponsor_first': 8,
        'sponsor_last': 9,
        'user_id': 10,
        'first_name': 11,
        'last_name': 12,
        'email': 13,
        'valid': 14,
        'phone': 15,
        'address': 16,
        'city': 17,
        'state': 18,
        'zip': 19,
        'ip_address': 20,
        'date_created': 21,
        'timezone': 22,
        'cell': 23,
        'carrier': 24,
        'landline': 25,
        'voip': 26,
        'other_phone': 27,
        'foreign_number': 28,
        'country': 29
      };
      
      const columnIndex = columnMap[columnName];
      if (columnIndex === undefined) return;
      
      // Toggle header
      const headers = table.querySelectorAll('th');
      const header = headers[columnIndex];
      if (header) {
        header.style.display = visible ? '' : 'none';
      }
      
      // Toggle all cells in this column
      const rows = table.querySelectorAll('tbody tr');
      rows.forEach(row => {
        const cell = row.cells[columnIndex];
        if (cell) {
          cell.style.display = visible ? '' : 'none';
        }
      });
    }

    function handleColumnToggle(event) {
      const columnName = event.target.dataset.column;
      const visible = event.target.checked;
      toggleColumn(columnName, visible);
    }

    function showAllColumns() {
      const checkboxes = document.querySelectorAll('.column-toggle');
      checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        toggleColumn(checkbox.dataset.column, true);
      });
    }

    function hideAllColumns() {
      const checkboxes = document.querySelectorAll('.column-toggle');
      checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        toggleColumn(checkbox.dataset.column, false);
      });
    }
  </script>
</body>
</html>