<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Contact List</title>
  <style>
    body { margin: 0; }
    .gradient-btn {
      background: linear-gradient(90deg, #4e73df 0%, #8f5be8 100%);
      box-shadow: 0 2px 6px rgba(78,115,223,0.08);
      transition: background 0.2s;
    }
    .gradient-btn:hover {
      background: linear-gradient(90deg, #8f5be8 0%, #4e73df 100%);
    }
    .red-btn {
      background: #e53935;
      box-shadow: 0 2px 6px rgba(229,57,53,0.08);
      transition: background 0.2s;
    }
    .red-btn:hover {
      background: #b71c1c;
    }
    /* Make table always visible and full width */
    .table-box {
      width: 100vw !important;
      min-width: 100vw !important;
      max-width: 100vw !important;
      margin: 0 !important;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      background: #fff;
      box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    }
    .contact-table {
      width: 100vw !important;
      min-width: 100vw !important;
      max-width: 100vw !important;
      margin: 0 !important;
      background: #fff;
      border-collapse: collapse;
      table-layout: auto;
    }
    .contact-table th, .contact-table td {
      padding: 8px;
      text-align: left;
      border: 1px solid #000;
      border-right: 1px solid #000 !important;
      border-left: 1px solid #000 !important;
      white-space: nowrap;
      min-width: 1px;
      max-width: none;
      word-break: normal;
    }
    .contact-table th {
      background-color: #f4f4f4;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .contact-table th.sticky-col-1,
    .contact-table td.sticky-col-1 {
      position: sticky;
      left: 0;
      background: #f0f0f0 !important;
      border-right: 3px solid #000 !important;
      border-left: 3px solid #000 !important;
      border-top: 2px solid #000 !important;
      border-bottom: 2px solid #000 !important;
      z-index: 50;
    }
    .contact-table th.sticky-col-2,
    .contact-table td.sticky-col-2 {
      position: sticky;
      left: 50px;
      background: #f0f0f0 !important;
      border-right: 3px solid #000 !important;
      border-left: none !important;
      border-top: 2px solid #000 !important;
      border-bottom: 2px solid #000 !important;
      z-index: 49;
    }
    .contact-table th.sticky-col-3,
    .contact-table td.sticky-col-3 {
      position: sticky;
      left: 100px;
      background: #f0f0f0 !important;
      border-right: 3px solid #000 !important;
      border-left: none !important;
      border-top: 2px solid #000 !important;
      border-bottom: 2px solid #000 !important;
      z-index: 48;
    }
    .contact-table th.sticky-col-4,
    .contact-table td.sticky-col-4 {
      position: sticky;
      left: 150px;
      background: #f0f0f0 !important;
      border-right: 3px solid #000 !important;
      border-left: none !important;
      border-top: 2px solid #000 !important;
      border-bottom: 2px solid #000 !important;
      z-index: 47;
    }
    /* Remove left border from first non-sticky column to prevent double border */
    .contact-table th:nth-child(5),
    .contact-table td:nth-child(5) {
      border-left: none !important;
    }
    /* Remove left border from non-sticky columns to avoid double border */
    .contact-table th:not(.sticky-col-1):not(.sticky-col-2):not(.sticky-col-3):not(.sticky-col-4),
    .contact-table td:not(.sticky-col-1):not(.sticky-col-2):not(.sticky-col-3):not(.sticky-col-4) {
      border-left: none;
    }
    /* Remove right border from sticky columns to avoid double lines */
    .contact-table th.sticky-col-1,
    .contact-table th.sticky-col-2,
    .contact-table th.sticky-col-3,
    .contact-table th.sticky-col-4,
    .contact-table td.sticky-col-1,
    .contact-table td.sticky-col-2,
    .contact-table td.sticky-col-3,
    .contact-table td.sticky-col-4 {
      /* border-right: none !important;  -- REMOVE this line to keep right borders! */
    }
    /* Remove previous conflicting border rules for sticky columns */
    .contact-table th:last-child,
    .contact-table td:last-child {
      border-right: 1px solid #000 !important;
      border-left: 1px solid #000 !important;
      background: inherit !important;
      z-index: auto;
    }
    /* Force right border on last visible cell in each row */
    .contact-table tr > td:last-child:not(.hidden),
    .contact-table tr > th:last-child:not(.hidden) {
      border-right: 1.5px solid #000 !important;
    }
    /* When columns are hidden, ensure the last visible cell gets the right border */
    .contact-table tr > td:not(.hidden):last-of-type,
    .contact-table tr > th:not(.hidden):last-of-type {
      border-right: 1.5px solid #000 !important;
    }
  </style>
</head>
<body>
  <!-- Contacts Table -->
  <div class="table-box" style="margin:0 0 24px 0;">
    <table class="contact-table">
      <thead>
        <tr>
          <th colspan="4" style="font-size:10px;background:#fffbe6;color:#b26a00;text-align:left;padding:2px 8px 2px 8px;border-bottom:none;">Do Not Disturb, indicated by X</th>
          <th colspan="24" style="border-bottom:none;background:transparent;"></th>
        </tr>
        <tr>
          <th class="sticky-col-1">SMS</th>
          <th class="sticky-col-2">Call</th>
          <th class="sticky-col-3">Email</th>
          <th class="sticky-col-4"><input type="checkbox" id="select-all"></th>
          <th>Sponsor</th>
          <th>Sponsor First</th>
          <th>Sponsor Last</th>
          <th>Campaign</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>E-mail</th>
          <th>Valid</th>
          <th>Phone</th>
          <th>Address</th>
          <th>City</th>
          <th>State</th>
          <th>Zip</th>
          <th>Status</th>
          <th>Rating</th>
          <th>IP</th>
          <th>Date</th>
          <th>Timezone</th>
          <th>Cell</th>
          <th>Carrier</th>
          <th>Landline</th>
          <th>Voip</th>
          <th>Other</th>
          <th>Foreign</th>
          <th>Country</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="sticky-col-1"></td>
          <td class="sticky-col-2"></td>
          <td class="sticky-col-3"></td>
          <td class="sticky-col-4"><input type="checkbox" class="row-select"></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- Button/Search Box -->
  <div style="width:100%;display:flex;align-items:center;margin:5px 0 20px 0;gap:16px;">
    <button id="delete-selected-btn" class="red-btn" style="font-size:12px;padding:4px 16px;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-right:auto;">Delete Selected</button>
    <div style="display:flex;gap:16px;align-items:center;justify-content:center;width:100%;">
      <input id="search-input" type="text" placeholder="Search contacts..." style="font-size:12px;padding:4px 8px;border:1px solid #ccc;border-radius:4px;outline:none;">
      <button id="reset-search-btn" style="font-size:12px;padding:4px 16px;background:#e0e0e0;color:#222;border:none;border-radius:4px;cursor:pointer;">Reset</button>
      <button id="search-btn" style="font-size:12px;padding:4px 16px;background:#4e73df;color:#fff;border:none;border-radius:4px;cursor:pointer;">Search</button>
      <button id="add-btn" class="gradient-btn" style="font-size:12px;padding:4px 16px;color:#fff;border:none;border-radius:4px;cursor:pointer;">Add Contact</button>
      <button id="select-columns-btn" class="gradient-btn" style="font-size:12px;padding:4px 16px;color:#fff;border:none;border-radius:4px;cursor:pointer;">Select Columns</button>
      <button id="sort-btn" class="gradient-btn" style="font-size:12px;padding:4px 16px;color:#fff;border:none;border-radius:4px;cursor:pointer;">Sort</button>
      <button id="import-btn" class="gradient-btn" style="font-size:12px;padding:4px 16px;color:#fff;border:none;border-radius:4px;cursor:pointer;">Import</button>
      <button id="export-btn" class="gradient-btn" style="font-size:12px;padding:4px 16px;color:#fff;border:none;border-radius:4px;cursor:pointer;">Export</button>
    </div>
  </div>

  <!-- Modal for Add Contact -->
  <div id="add-contact-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:24px 32px;border-radius:8px;min-width:320px;max-width:90vw;max-height:90vh;overflow:auto;box-shadow:0 4px 24px rgba(0,0,0,0.2);">
      <h2 style="margin-top:0;">Add Contact</h2>
      <form id="add-contact-form">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <input name="Sponsor" placeholder="Sponsor" required />
          <input name="Sponsor First" placeholder="Sponsor First" required />
          <input name="Sponsor Last" placeholder="Sponsor Last" required />
          <input name="Campaign" placeholder="Campaign" required />
          <input name="First Name" placeholder="First Name" required />
          <input name="Last Name" placeholder="Last Name" required />
          <input name="E-mail" placeholder="E-mail" type="email" required />
          <input name="Valid" placeholder="Valid" />
          <input name="Phone" placeholder="Phone" />
          <input name="Address" placeholder="Address" />
          <input name="City" placeholder="City" />
          <input name="State" placeholder="State" />
          <input name="Zip" placeholder="Zip" />
          <input name="Status" placeholder="Status" />
          <input name="Rating" placeholder="Rating" />
          <input name="IP" placeholder="IP" />
          <input name="Date" placeholder="Date" />
          <input name="Timezone" placeholder="Timezone" />
          <input name="Cell" placeholder="Cell" />
          <input name="Carrier" placeholder="Carrier" />
          <input name="Landline" placeholder="Landline" />
          <input name="Voip" placeholder="Voip" />
          <input name="Other" placeholder="Other" />
          <input name="Foreign" placeholder="Foreign" />
          <input name="Country" placeholder="Country" />
        </div>
        <div style="margin-top:20px;display:flex;gap:12px;justify-content:flex-end;">
          <button type="button" id="cancel-add-contact" style="padding:6px 18px;border:none;border-radius:4px;background:#ccc;color:#222;cursor:pointer;">Cancel</button>
          <button type="submit" class="gradient-btn" style="padding:6px 18px;border:none;border-radius:4px;color:#fff;cursor:pointer;">Add</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Modal for Select Columns -->
  <div id="select-columns-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:24px 32px;border-radius:8px;min-width:320px;max-width:90vw;max-height:90vh;overflow:auto;box-shadow:0 4px 24px rgba(0,0,0,0.2);">
      <h2 style="margin-top:0;">Select Columns</h2>
      <form id="select-columns-form">
        <div id="columns-checkboxes" style="display:grid;grid-template-columns:1fr 1fr;gap:12px 24px;"></div>
        <div style="margin-top:20px;display:flex;gap:12px;justify-content:flex-end;">
          <button type="button" id="cancel-select-columns" style="padding:6px 18px;border:none;border-radius:4px;background:#ccc;color:#222;cursor:pointer;">Cancel</button>
          <button type="submit" class="gradient-btn" style="padding:6px 18px;border:none;border-radius:4px;color:#fff;cursor:pointer;">Apply</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Modal for Sort -->
  <div id="sort-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:24px 32px;border-radius:8px;min-width:320px;max-width:90vw;max-height:90vh;overflow:auto;box-shadow:0 4px 24px rgba(0,0,0,0.2);">
      <h2 style="margin-top:0;">Sort</h2>
      <form id="sort-form">
        <div id="sort-levels"></div>
        <div style="margin-top:16px;display:flex;gap:12px;justify-content:flex-end;">
          <button type="button" id="add-sort-level" class="gradient-btn" style="font-size:12px;padding:4px 16px;color:#fff;border:none;border-radius:4px;cursor:pointer;">Add level</button>
          <button type="button" id="cancel-sort" style="padding:6px 18px;border:none;border-radius:4px;background:#ccc;color:#222;cursor:pointer;">Cancel</button>
          <button type="submit" class="gradient-btn" style="padding:6px 18px;border:none;border-radius:4px;color:#fff;cursor:pointer;">Apply</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Modal for Import -->
  <div id="import-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:24px 32px;border-radius:8px;min-width:320px;max-width:90vw;max-height:90vh;overflow:auto;box-shadow:0 4px 24px rgba(0,0,0,0.2);">
      <h2 style="margin-top:0;">Import Contacts</h2>
      <div style="display:flex;flex-direction:column;gap:16px;">
        <button id="import-google-btn" class="gradient-btn" style="font-size:12px;padding:6px 18px;color:#fff;border:none;border-radius:4px;cursor:pointer;">Import from Google Sheets</button>
        <button id="import-csv-btn" class="gradient-btn" style="font-size:12px;padding:6px 18px;color:#fff;border:none;border-radius:4px;cursor:pointer;">Import CSV</button>
        <input id="import-csv-input" type="file" accept=".csv" style="display:none;">
        <div style="font-size:11px;color:#555;margin-bottom:4px;margin-top:2px;max-width:400px;">CSV file must have the first row as headers matching the contact columns. Use commas to separate fields. Example: First Name,Last Name,E-mail,Phone,...</div>
        <button id="import-xls-btn" class="gradient-btn" style="font-size:12px;padding:6px 18px;color:#fff;border:none;border-radius:4px;cursor:pointer;">Import XLS/XLSX</button>
        <input id="import-xls-input" type="file" accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none;">
        <div style="font-size:11px;color:#555;margin-bottom:4px;margin-top:2px;max-width:400px;">Excel file must have the first row as headers matching the contact columns. Only the first sheet will be imported.</div>
        <button id="import-txt-btn" class="gradient-btn" style="font-size:12px;padding:6px 18px;color:#fff;border:none;border-radius:4px;cursor:pointer;">Import TXT</button>
        <input id="import-txt-input" type="file" accept=".txt,text/plain" style="display:none;">
        <div style="font-size:11px;color:#555;margin-bottom:4px;margin-top:2px;max-width:400px;">TXT file must be tab- or comma-delimited, with the first row as headers matching the contact columns.</div>
        <button id="cancel-import-btn" style="padding:6px 18px;border:none;border-radius:4px;background:#ccc;color:#222;cursor:pointer;">Cancel</button>
      </div>
    </div>
  </div>
  <!-- Modal for Google Sheets URL -->
  <div id="google-sheet-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:1100;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:24px 32px;border-radius:8px;min-width:320px;max-width:90vw;max-height:90vh;overflow:auto;box-shadow:0 4px 24px rgba(0,0,0,0.2);">
      <h2 style="margin-top:0;">Import from Google Sheets</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:16px;">
        <input id="google-sheet-url" type="text" placeholder="Paste Google Sheet URL here" style="flex:1;font-size:12px;padding:4px 8px;border:1px solid #ccc;border-radius:4px;min-width:180px;">
        <button id="load-google-sheet-btn" type="button" style="font-size:12px;padding:4px 12px;background:#4e73df;color:#fff;border:none;border-radius:4px;cursor:pointer;">Load Sheet</button>
      </div>
      <div style="font-size:11px;color:#555;max-width:400px;">Google Sheet must have the first row as headers matching the contact columns (e.g., First Name, Last Name, E-mail, etc). Share the sheet or publish to web for access.</div>
      <div style="margin-top:20px;display:flex;gap:12px;justify-content:flex-end;">
        <button id="cancel-google-sheet-btn" style="padding:6px 18px;border:none;border-radius:4px;background:#ccc;color:#222;cursor:pointer;">Cancel</button>
      </div>
    </div>
  </div>
  <!-- Modal for Export -->
  <div id="export-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:1050;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:24px 32px;border-radius:8px;min-width:320px;max-width:90vw;max-height:90vh;overflow:auto;box-shadow:0 4px 24px rgba(0,0,0,0.2);">
      <h2 style="margin-top:0;">Export Contacts</h2>
      <div style="display:flex;flex-direction:column;gap:16px;">
        <button id="export-csv-btn" class="gradient-btn" style="font-size:12px;padding:6px 18px;color:#fff;border:none;border-radius:4px;cursor:pointer;">Export as CSV</button>
        <button id="export-xls-btn" class="gradient-btn" style="font-size:12px;padding:6px 18px;color:#fff;border:none;border-radius:4px;cursor:pointer;">Export as XLS/XLSX</button>
        <button id="export-txt-btn" class="gradient-btn" style="font-size:12px;padding:6px 18px;color:#fff;border:none;border-radius:4px;cursor:pointer;">Export as TXT</button>
        <button id="cancel-export-btn" style="padding:6px 18px;border:none;border-radius:4px;background:#ccc;color:#222;cursor:pointer;">Cancel</button>
      </div>
    </div>
  </div>
  <!-- Add global navigation JS -->
  <script src="static/global-nav.js"></script>
  <script>
    // Search functionality for the contact table
    function highlightMatches(cell, input) {
      if (!input) return cell.textContent;
      const regex = new RegExp(`(${input.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return cell.textContent.replace(regex, '<mark>$1</mark>');
    }

    function filterTable() {
      const input = document.getElementById('search-input').value.toLowerCase();
      const table = document.querySelector('.contact-table tbody');
      const rows = table.getElementsByTagName('tr');
      for (let i = 0; i < rows.length; i++) {
        let row = rows[i];
        let cells = row.getElementsByTagName('td');
        let match = false;
        for (let j = 0; j < cells.length; j++) {
          // Remove previous highlights
          cells[j].innerHTML = cells[j].textContent;
          if (input && cells[j].textContent.toLowerCase().includes(input)) {
            match = true;
          }
        }
        row.style.display = match || input === '' ? '' : 'none';
        // Highlight matches if visible
        if ((match || input === '') && input) {
          for (let j = 0; j < cells.length; j++) {
            cells[j].innerHTML = highlightMatches(cells[j], input);
          }
        }
      }
    }

    document.getElementById('search-btn').addEventListener('click', filterTable);
    document.getElementById('search-input').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        filterTable();
      }
    });
    // Move reset button logic to new button
    document.getElementById('reset-search-btn').addEventListener('click', function() {
      document.getElementById('search-input').value = '';
      filterTable();
    });
    // Modal logic for Add Contact
    const addModal = document.getElementById('add-contact-modal');
    document.getElementById('add-btn').addEventListener('click', function() {
      addModal.style.display = 'flex';
    });
    document.getElementById('cancel-add-contact').addEventListener('click', function() {
      addModal.style.display = 'none';
    });
    // Optional: close modal on outside click
    addModal.addEventListener('click', function(e) {
      if (e.target === addModal) addModal.style.display = 'none';
    });
    // Prevent form submit for now
    document.getElementById('add-contact-form').addEventListener('submit', function(e) {
      e.preventDefault();
      // You can add logic here to add the contact to the table
      addModal.style.display = 'none';
      this.reset();
    });
    // Select Columns Modal logic
    const selectColumnsModal = document.getElementById('select-columns-modal');
    const columnsForm = document.getElementById('select-columns-form');
    const columnsCheckboxes = document.getElementById('columns-checkboxes');
    const columnHeaders = [
      {name: 'SMS', mandatory: true},
      {name: 'Call', mandatory: true},
      {name: 'Email', mandatory: true},
      {name: '', mandatory: true}, // Select checkbox column
      {name: 'Sponsor'},
      {name: 'Sponsor First'},
      {name: 'Sponsor Last'},
      {name: 'Campaign'},
      {name: 'First Name', mandatory: true},
      {name: 'Last Name', mandatory: true},
      {name: 'E-mail', mandatory: true},
      {name: 'Valid'},
      {name: 'Phone'},
      {name: 'Address'},
      {name: 'City'},
      {name: 'State'},
      {name: 'Zip'},
      {name: 'Status'},
      {name: 'Rating'},
      {name: 'IP'},
      {name: 'Date'},
      {name: 'Timezone'},
      {name: 'Cell'},
      {name: 'Carrier'},
      {name: 'Landline'},
      {name: 'Voip'},
      {name: 'Other'},
      {name: 'Foreign'},
      {name: 'Country'}
    ];
    // Helper: Save and load column visibility from localStorage
    function saveColumnVisibility(settings) {
      localStorage.setItem('contactListColumnVisibility', JSON.stringify(settings));
    }
    function loadColumnVisibility() {
      const s = localStorage.getItem('contactListColumnVisibility');
      return s ? JSON.parse(s) : null;
    }
    // Utility: Add right border to last visible cell in each row
    function updateLastVisibleBorders() {
      const table = document.querySelector('.contact-table');
      if (!table) return;
      const rows = table.querySelectorAll('tr');
      rows.forEach(row => {
        // Remove previous forced right borders
        row.querySelectorAll('.last-visible-cell').forEach(cell => {
          cell.classList.remove('last-visible-cell');
        });
        // Find last visible cell
        const cells = Array.from(row.children).filter(cell => cell.style.display !== 'none');
        if (cells.length > 0) {
          cells[cells.length - 1].classList.add('last-visible-cell');
        }
      });
    }
    // Add style for last-visible-cell
    const style = document.createElement('style');
    style.innerHTML = `.contact-table th.last-visible-cell, .contact-table td.last-visible-cell { border-right: 2px solid #000 !important; }`;
    document.head.appendChild(style);
    // Apply column visibility settings
    function applyColumnVisibility(settings) {
      const ths = document.querySelectorAll('.contact-table th');
      const trs = document.querySelectorAll('.contact-table tr');
      let colIdx = 0;
      columnHeaders.forEach((col, idx) => {
        if (col.name === '') {
          colIdx++;
          return;
        }
        const show = settings && settings[idx] !== undefined ? settings[idx] : true;
        ths[colIdx].style.display = show ? '' : 'none';
        trs.forEach(tr => {
          const tds = tr.querySelectorAll('td,th');
          if (tds[colIdx]) tds[colIdx].style.display = show ? '' : 'none';
        });
        colIdx++;
      });
      updateLastVisibleBorders();
    }
    // On open, checkboxes reflect saved settings
    document.getElementById('select-columns-btn').addEventListener('click', function() {
      columnsCheckboxes.innerHTML = '';
      const saved = loadColumnVisibility();
      columnHeaders.forEach((col, idx) => {
        if (col.name === '') return;
        const id = 'col-checkbox-' + idx;
        const checked = col.mandatory || (saved ? saved[idx] : !document.querySelectorAll('.contact-table th')[idx].classList.contains('hidden'));
        columnsCheckboxes.innerHTML += `<label><input type="checkbox" id="${id}" data-col="${idx}" ${checked ? 'checked' : ''} ${col.mandatory ? 'disabled' : ''}/> ${col.name}</label>`;
      });
      selectColumnsModal.style.display = 'flex';
    });
    columnsForm.addEventListener('submit', function(e) {
      e.preventDefault();
      // Save settings
      let colIdx = 0;
      const settings = [];
      columnHeaders.forEach((col, idx) => {
        if (col.name === '') {
          colIdx++;
          return;
        }
        const cb = document.getElementById('col-checkbox-' + idx);
        settings[idx] = cb.checked;
        colIdx++;
      });
      saveColumnVisibility(settings);
      applyColumnVisibility(settings);
      selectColumnsModal.style.display = 'none';
      updateLastVisibleBorders();
    });
    // Add reset to default columns button in Select Columns modal
    const resetColumnsBtn = document.createElement('button');
    resetColumnsBtn.type = 'button';
    resetColumnsBtn.textContent = 'Reset to Default';
    resetColumnsBtn.className = 'gradient-btn';
    resetColumnsBtn.style.fontSize = '12px';
    resetColumnsBtn.style.padding = '4px 16px';
    resetColumnsBtn.style.color = '#fff';
    resetColumnsBtn.style.border = 'none';
    resetColumnsBtn.style.borderRadius = '4px';
    resetColumnsBtn.style.cursor = 'pointer';
    // Insert before the Apply button
    document.querySelector('#select-columns-form > div[style*="margin-top"]')
      .insertBefore(resetColumnsBtn, document.getElementById('cancel-select-columns'));
    resetColumnsBtn.addEventListener('click', function() {
      localStorage.removeItem('contactListColumnVisibility');
      // All columns except non-mandatory default to visible
      const defaultSettings = columnHeaders.map(col => col.mandatory !== false);
      applyColumnVisibility(defaultSettings);
      // Also update checkboxes in modal
      columnsCheckboxes.querySelectorAll('input[type="checkbox"]').forEach((cb, idx) => {
        cb.checked = true;
      });
    });
    // Fix: Cancel button for Select Columns modal
    document.getElementById('cancel-select-columns').addEventListener('click', function() {
      selectColumnsModal.style.display = 'none';
    });
    // On page load, apply saved settings
    document.addEventListener('DOMContentLoaded', function() {
      const settings = loadColumnVisibility();
      if (settings) applyColumnVisibility(settings);
    });
    // Sort Modal logic
    const sortModal = document.getElementById('sort-modal');
    const sortBtn = document.getElementById('sort-btn');
    const sortForm = document.getElementById('sort-form');
    const sortLevelsDiv = document.getElementById('sort-levels');
    const cancelSortBtn = document.getElementById('cancel-sort');
    const addSortLevelBtn = document.getElementById('add-sort-level');
    // Columns available for sorting (skip select/checkbox column)
    const sortableColumns = columnHeaders
      .map((col, idx) => ({ name: col.name, idx }))
      .filter(col => col.name && col.idx !== 3); // skip select column
    function createSortLevel(selectedCol, order) {
      const levelIdx = sortLevelsDiv.children.length;
      if (levelIdx >= 4) return; // Prevent more than 4 levels
      const div = document.createElement('div');
      div.style.display = 'flex';
      div.style.gap = '8px';
      div.style.alignItems = 'center';
      div.style.marginBottom = '8px';
      // Add label for first sort level
      if (levelIdx === 0) {
        const label = document.createElement('span');
        label.textContent = 'Sort by:';
        label.style.fontWeight = 'bold';
        label.style.fontSize = '12px';
        label.style.marginRight = '8px';
        div.appendChild(label);
      } else {
        const label = document.createElement('span');
        label.textContent = 'Then by:';
        label.style.fontSize = '12px';
        label.style.marginRight = '8px';
        div.appendChild(label);
      }
      // Column select
      const select = document.createElement('select');
      select.name = 'sort-col-' + levelIdx;
      sortableColumns.forEach(col => {
        const opt = document.createElement('option');
        opt.value = col.idx;
        opt.textContent = col.name;
        select.appendChild(opt);
      });
      if (selectedCol !== undefined) select.value = selectedCol;
      // Order select
      const orderSelect = document.createElement('select');
      orderSelect.name = 'sort-order-' + levelIdx;
      [
        { value: 'asc', label: 'A → Z / 0 → 9' },
        { value: 'desc', label: 'Z → A / 9 → 0' }
      ].forEach(optData => {
        const opt = document.createElement('option');
        opt.value = optData.value;
        opt.textContent = optData.label;
        orderSelect.appendChild(opt);
      });
      div.appendChild(select);
      div.appendChild(orderSelect);
      // Remove level button (except for first)
      if (levelIdx > 0) {
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = 'Remove';
        removeBtn.style.marginLeft = '8px';
        removeBtn.style.fontSize = '11px';
        removeBtn.style.padding = '2px 10px';
        removeBtn.style.background = '#e0e0e0';
        removeBtn.style.color = '#222';
        removeBtn.style.border = 'none';
        removeBtn.style.borderRadius = '4px';
        removeBtn.style.cursor = 'pointer';
        removeBtn.addEventListener('click', function() {
          div.remove();
          // Re-enable Add Level if less than 4
          if (sortLevelsDiv.children.length < 4) {
            addSortLevelBtn.disabled = false;
          }
        });
        div.appendChild(removeBtn);
      }
      sortLevelsDiv.appendChild(div);
      // Disable Add Level if 4 levels present
      if (sortLevelsDiv.children.length >= 4) {
        addSortLevelBtn.disabled = true;
      } else {
        addSortLevelBtn.disabled = false;
      }
    }
    // Open sort modal logic
    sortBtn.addEventListener('click', function() {
      sortModal.style.display = 'flex';
      // Clear existing sort levels
      sortLevelsDiv.innerHTML = '';
      // For each existing sort level, recreate the UI
      const existingSortSettings = Array.from(sortForm.elements)
        .filter(el => el.name && el.name.startsWith('sort-col-'))
        .map((el, idx) => {
          return {
            column: el.value,
            order: sortForm.elements['sort-order-' + idx].value
          };
        });
      if (existingSortSettings.length > 0) {
        existingSortSettings.forEach(sortLevel => {
          createSortLevel(sortLevel.column, sortLevel.order);
        });
      } else {
        // Always show at least one sort level
        createSortLevel();
      }
    });
    // Add sort level button logic
    addSortLevelBtn.addEventListener('click', function() {
      if (sortLevelsDiv.children.length < 4) {
        createSortLevel();
      }
    });
    // Cancel sort modal
    cancelSortBtn.addEventListener('click', function() {
      sortModal.style.display = 'none';
    });
    // Apply sort settings
    sortForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const sortSettings = Array.from(sortForm.elements)
        .filter(el => el.name.startsWith('sort-col-'))
        .map((el, idx) => {
          return {
            column: el.value,
            order: sortForm.elements['sort-order-' + idx].value
          };
        });
      // Sort table rows based on settings
      const table = document.querySelector('.contact-table tbody');
      const rows = Array.from(table.getElementsByTagName('tr'));
      rows.sort((a, b) => {
        let order = 0;
        sortSettings.forEach(sortLevel => {
          const colIdx = parseInt(sortLevel.column);
          const aText = a.children[colIdx].textContent.trim();
          const bText = b.children[colIdx].textContent.trim();
          if (aText < bText) {
            order = sortLevel.order === 'asc' ? -1 : 1;
          } else if (aText > bText) {
            order = sortLevel.order === 'asc' ? 1 : -1;
          }
        });
        return order;
      });
      // Reattach sorted rows
      rows.forEach(row => table.appendChild(row));
      sortModal.style.display = 'none';
    });
    // Export/Import button logic (stub)
    const importModal = document.getElementById('import-modal');
    const googleSheetModal = document.getElementById('google-sheet-modal');
    const exportModal = document.createElement('div');
    exportModal.id = 'export-modal';
    // Already added above, so just get reference if needed
    // Open Export modal
    document.getElementById('export-btn').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('export-modal').style.display = 'flex';
    });
    document.getElementById('cancel-export-btn').addEventListener('click', function() {
      document.getElementById('export-modal').style.display = 'none';
    });
    document.getElementById('export-modal').addEventListener('click', function(e) {
      if (e.target === document.getElementById('export-modal')) {
        document.getElementById('export-modal').style.display = 'none';
      }
    });
    // Export option stubs
    document.getElementById('export-csv-btn').addEventListener('click', function() {
      // Find table and visible columns
      const table = document.querySelector('.contact-table');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      const ths = Array.from(thead.querySelectorAll('th'));
      // Only include visible columns
      const visibleColIdxs = ths.map((th, idx) => th.style.display !== 'none' ? idx : -1).filter(idx => idx !== -1);
      // Get header row (skip the first row with colspan)
      const headerRow = thead.querySelectorAll('tr')[1];
      const headerCells = Array.from(headerRow.children).filter((th, idx) => visibleColIdxs.includes(idx));
      const headers = headerCells.map(th => th.textContent.trim());
      // Get visible rows
      const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.style.display !== 'none');
      // Compose CSV rows
      const csvRows = [];
      csvRows.push(headers.map(h => '"' + h.replace(/"/g, '""') + '"').join(','));
      rows.forEach(row => {
        const cells = Array.from(row.children).filter((td, idx) => visibleColIdxs.includes(idx));
        csvRows.push(cells.map(td => '"' + td.textContent.replace(/"/g, '""').trim() + '"').join(','));
      });
      // Get user's name from .user-name span
      let userName = 'User';
      const userNameSpan = document.querySelector('.user-name');
      if (userNameSpan) {
        userName = userNameSpan.textContent.trim();
      }
      // Format date as YYYY-MM-DD
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const dateStr = `${yyyy}-${mm}-${dd}`;
      // Compose filename
      const fileName = `${userName} ${dateStr} Contacts List.csv`.replace(/\s+/g, ' ').trim();
      // Download CSV
      const blob = new Blob([csvRows.join('\r\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
      document.getElementById('export-modal').style.display = 'none';
    });
    // TXT export
    document.getElementById('export-txt-btn').addEventListener('click', function() {
      const table = document.querySelector('.contact-table');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      const ths = Array.from(thead.querySelectorAll('th'));
      const visibleColIdxs = ths.map((th, idx) => th.style.display !== 'none' ? idx : -1).filter(idx => idx !== -1);
      const headerRow = thead.querySelectorAll('tr')[1];
      const headerCells = Array.from(headerRow.children).filter((th, idx) => visibleColIdxs.includes(idx));
      const headers = headerCells.map(th => th.textContent.trim());
      const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.style.display !== 'none');
      const txtRows = [];
      txtRows.push(headers.join('\t'));
      rows.forEach(row => {
        const cells = Array.from(row.children).filter((td, idx) => visibleColIdxs.includes(idx));
        txtRows.push(cells.map(td => td.textContent.trim()).join('\t'));
      });
      let userName = 'User';
      const userNameSpan = document.querySelector('.user-name');
      if (userNameSpan) {
        userName = userNameSpan.textContent.trim();
      }
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const dateStr = `${yyyy}-${mm}-${dd}`;
      const fileName = `${userName} ${dateStr} Contacts List.txt`.replace(/\s+/g, ' ').trim();
      const blob = new Blob([txtRows.join('\r\n')], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
      document.getElementById('export-modal').style.display = 'none';
    });
    // XLS/XLSX export (CSV with .xlsx extension for now)
    document.getElementById('export-xls-btn').addEventListener('click', function() {
      const table = document.querySelector('.contact-table');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      const ths = Array.from(thead.querySelectorAll('th'));
      const visibleColIdxs = ths.map((th, idx) => th.style.display !== 'none' ? idx : -1).filter(idx => idx !== -1);
      const headerRow = thead.querySelectorAll('tr')[1];
      const headerCells = Array.from(headerRow.children).filter((th, idx) => visibleColIdxs.includes(idx));
      const headers = headerCells.map(th => th.textContent.trim());
      const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.style.display !== 'none');
      const csvRows = [];
      csvRows.push(headers.map(h => '"' + h.replace(/"/g, '""') + '"').join(','));
      rows.forEach(row => {
        const cells = Array.from(row.children).filter((td, idx) => visibleColIdxs.includes(idx));
        csvRows.push(cells.map(td => '"' + td.textContent.replace(/"/g, '""').trim() + '"').join(','));
      });
      let userName = 'User';
      const userNameSpan = document.querySelector('.user-name');
      if (userNameSpan) {
        userName = userNameSpan.textContent.trim();
      }
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const dateStr = `${yyyy}-${mm}-${dd}`;
      const fileName = `${userName} ${dateStr} Contacts List.xlsx`.replace(/\s+/g, ' ').trim();
      const blob = new Blob([csvRows.join('\r\n')], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
      document.getElementById('export-modal').style.display = 'none';
    });
    // Blue import buttons open file selectors
    document.getElementById('import-csv-btn').addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('import-csv-input').click();
    });
    document.getElementById('import-xls-btn').addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('import-xls-input').click();
    });
    document.getElementById('import-txt-btn').addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('import-txt-input').click();
    });
    // CSV import logic: parse and add to table
    document.getElementById('import-csv-input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        const text = evt.target.result;
        // Parse CSV (simple, no quoted commas)
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
        if (lines.length < 2) {
          alert('CSV must have a header and at least one data row.');
          importModal.style.display = 'none';
          return;
        }
        // Get headers from first row
        const headers = lines[0].split(',').map(h => h.trim());
        // Map headers to table columns
        const tableHeaders = Array.from(document.querySelectorAll('.contact-table thead tr')[1].children).map(th => th.textContent.trim());
        const colMap = headers.map(h => tableHeaders.indexOf(h));
        if (colMap.some(idx => idx === -1)) {
          alert('CSV headers must match table columns.\nMissing: ' + headers.filter((h, i) => colMap[i] === -1).join(', '));
          importModal.style.display = 'none';
          return;
        }
        // Add each row
        const tbody = document.querySelector('.contact-table tbody');
        for (let i = 1; i < lines.length; i++) {
          const row = lines[i].split(',');
          if (row.length !== headers.length) continue; // skip malformed
          const tr = document.createElement('tr');
          for (let j = 0; j < tableHeaders.length; j++) {
            const td = document.createElement('td');
            if (j === 0) td.className = 'sticky-col-1';
            if (j === 1) td.className = 'sticky-col-2';
            if (j === 2) td.className = 'sticky-col-3';
            if (j === 3) {
              td.className = 'sticky-col-4';
              td.innerHTML = '<input type="checkbox" class="row-select">';
              tr.appendChild(td);
              continue;
            }
            const csvIdx = colMap.indexOf(j);
            td.textContent = csvIdx !== -1 ? row[csvIdx] : '';
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }
        importModal.style.display = 'none';
        e.target.value = '';
      };
      reader.readAsText(file);
    });
    // TXT import logic: parse and add to table
    document.getElementById('import-txt-input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        const text = evt.target.result;
        // Try tab first, then comma
        let lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
        if (lines.length < 2) {
          alert('TXT must have a header and at least one data row.');
          importModal.style.display = 'none';
          return;
        }
        let delimiter = '\t';
        if (lines[0].indexOf('\t') === -1 && lines[0].indexOf(',') !== -1) delimiter = ',';
        const headers = lines[0].split(delimiter).map(h => h.trim());
        const tableHeaders = Array.from(document.querySelectorAll('.contact-table thead tr')[1].children).map(th => th.textContent.trim());
        const colMap = headers.map(h => tableHeaders.indexOf(h));
        if (colMap.some(idx => idx === -1)) {
          alert('TXT headers must match table columns.\nMissing: ' + headers.filter((h, i) => colMap[i] === -1).join(', '));
          importModal.style.display = 'none';
          return;
        }
        const tbody = document.querySelector('.contact-table tbody');
        for (let i = 1; i < lines.length; i++) {
          const row = lines[i].split(delimiter);
          if (row.length !== headers.length) continue;
          const tr = document.createElement('tr');
          for (let j = 0; j < tableHeaders.length; j++) {
            const td = document.createElement('td');
            if (j === 0) td.className = 'sticky-col-1';
            if (j === 1) td.className = 'sticky-col-2';
            if (j === 2) td.className = 'sticky-col-3';
            if (j === 3) {
              td.className = 'sticky-col-4';
              td.innerHTML = '<input type="checkbox" class="row-select">';
              tr.appendChild(td);
              continue;
            }
            const txtIdx = colMap.indexOf(j);
            td.textContent = txtIdx !== -1 ? row[txtIdx] : '';
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }
        importModal.style.display = 'none';
        e.target.value = '';
      };
      reader.readAsText(file);
    });
    // XLS/XLSX import logic: parse and add to table (using SheetJS)
    document.getElementById('import-xls-input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          // SheetJS library required
          if (typeof XLSX === 'undefined') {
            alert('XLS/XLSX import requires SheetJS. Please include SheetJS library.');
            importModal.style.display = 'none';
            return;
          }
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          if (json.length < 2) {
            alert('XLS/XLSX must have a header and at least one data row.');
            importModal.style.display = 'none';
            return;
          }
          const headers = json[0].map(h => (h || '').toString().trim());
          const tableHeaders = Array.from(document.querySelectorAll('.contact-table thead tr')[1].children).map(th => th.textContent.trim());
          const colMap = headers.map(h => tableHeaders.indexOf(h));
          if (colMap.some(idx => idx === -1)) {
            alert('XLS/XLSX headers must match table columns.\nMissing: ' + headers.filter((h, i) => colMap[i] === -1).join(', '));
            importModal.style.display = 'none';
            return;
          }
          const tbody = document.querySelector('.contact-table tbody');
          for (let i = 1; i < json.length; i++) {
            const row = json[i];
            if (row.length !== headers.length) continue;
            const tr = document.createElement('tr');
            for (let j = 0; j < tableHeaders.length; j++) {
              const td = document.createElement('td');
              if (j === 0) td.className = 'sticky-col-1';
              if (j === 1) td.className = 'sticky-col-2';
              if (j === 2) td.className = 'sticky-col-3';
              if (j === 3) {
                td.className = 'sticky-col-4';
                td.innerHTML = '<input type="checkbox" class="row-select">';
                tr.appendChild(td);
                continue;
              }
              const xlsIdx = colMap.indexOf(j);
              td.textContent = xlsIdx !== -1 ? (row[xlsIdx] || '') : '';
              tr.appendChild(td);
            }
            tbody.appendChild(tr);
          }
          importModal.style.display = 'none';
          e.target.value = '';
        } catch (err) {
          alert('Failed to import XLS/XLSX: ' + err.message);
          importModal.style.display = 'none';
        }
      };
      reader.readAsArrayBuffer(file);
    });
    // Google Sheets import button opens Google Sheets modal
    document.getElementById('import-google-btn').addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('import-modal').style.display = 'none';
      document.getElementById('google-sheet-modal').style.display = 'flex';
    });
    // Cancel button in Google Sheets modal closes it
    document.getElementById('cancel-google-sheet-btn').addEventListener('click', function() {
      document.getElementById('google-sheet-modal').style.display = 'none';
    });
    // Close Google Sheets modal on outside click
    document.getElementById('google-sheet-modal').addEventListener('click', function(e) {
      if (e.target === document.getElementById('google-sheet-modal')) {
        document.getElementById('google-sheet-modal').style.display = 'none';
      }
    });
    // Cancel button in Import modal closes it
    document.getElementById('cancel-import-btn').addEventListener('click', function() {
      document.getElementById('import-modal').style.display = 'none';
    });
    // Make all modals close on clicking outside the modal overlay
    [
      'add-contact-modal',
      'select-columns-modal',
      'sort-modal',
      'import-modal',
      'export-modal',
      'google-sheet-modal'
    ].forEach(function(modalId) {
      var modal = document.getElementById(modalId);
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) modal.style.display = 'none';
        });
      }
    });
  </script>
</body>
</html>