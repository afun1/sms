<!DOCTYPE html>
<!--
  Contact List Application (list.html)
  Formerly contacts_new.html - Renamed for better clarity
  Full-featured contact management system with Supabase integration
  
  Features:
  - Complete CRUD operations for contacts
  - Real-time editing with automatic save to Supabase
  - User assignment and role management
  - Search and filtering capabilities
  - Pagination and bulk operations
  - Import/Export functionality
  - SMS, Email, and RVM integration (coming soon)
-->
<html>
<head>
  <meta charset="UTF-8">
  <title>Contact List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="static/supersparky.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script src="static/global-nav-v2.js"></script>
  <style>
    body { 
      margin: 0; 
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
    }
    
    /* Reset any margins from global navigation */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body * {
      margin: revert;
      padding: revert;
    }
    
    /* Force tight positioning against global nav */
    #global-nav, .global-nav, [id*="nav"], [class*="nav"] {
      margin-bottom: 0 !important;
      padding-bottom: 0 !important;
    }
    
    /* Ensure body content starts immediately after nav */
    body > div:first-child,
    body > header:first-child,
    body > nav:first-child {
      margin-bottom: 0 !important;
      padding-bottom: 0 !important;
    }
    
    .controls {
      background: white;
      padding: 5px 20px;
      margin: -10px 20px 0px 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: space-between;
      position: sticky;
      top: 60px;
      z-index: 3000;
    }
    
    .search-group {
      display: flex;
      gap: 10px;
      align-items: center;
      flex: 0.33;
      min-width: 100px;
      position: relative;
    }
    
    .search-input {
      flex: 1;
      padding: 2px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .search-input:focus {
      border-color: #667eea;
    }
    
    /* Search suggestions dropdown */
    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 1000;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    
    .suggestion-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #f8f9fa;
    }
    
    .suggestion-item:hover,
    .suggestion-item.active {
      background: #f8f9fa;
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .btn {
      padding: 2px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .btn-primary { 
      background: linear-gradient(to bottom, #4dabf7, #007bff); 
      color: white; 
    }
    .btn-success { 
      background: linear-gradient(to bottom, #51cf66, #28a745); 
      color: white; 
    }
    .btn-warning { 
      background: linear-gradient(to bottom, #ffd43b, #ffc107); 
      color: #212529; 
    }
    .btn-danger { 
      background: linear-gradient(to bottom, #ff6b6b, #dc3545); 
      color: white; 
    }
    .btn-info { 
      background: linear-gradient(to bottom, #22d3ee, #17a2b8); 
      color: white; 
    }
    .btn-secondary { 
      background: linear-gradient(to bottom, #adb5bd, #6c757d); 
      color: white; 
    }
    
    .table-container {
      margin: 0 20px 0 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow: auto;
      height: calc(100vh - 125px);
      border: 2px solid #e9ecef;
      padding: 0 10px 0 10px;
      position: sticky;
      top: 125px;
      z-index: 2000;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    .table th,
    .table td {
      padding: 0 12px;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
      font-size: 12px;
    }
    
    .table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    /* Sticky columns 1-5 with proper sizing */
    .table th:nth-child(1),
    .table td:nth-child(1) {
      background: #e3f2fd;
      padding: 0 !important;
      width: 20px;
      min-width: 20px;
      max-width: 20px;
      text-align: center;
      position: sticky;
      left: 0;
      z-index: 10;
    }
    
    .table th:nth-child(2),
    .table td:nth-child(2) {
      background: #c0c0c0;
      padding: 0 1px 0 2px !important;
      width: auto;
      min-width: fit-content;
      text-align: center !important;
      position: sticky;
      left: 20px;
      z-index: 9;
    }
    
    .table th:nth-child(3),
    .table td:nth-child(3) {
      background: #e8e8e8;
      padding: 0 1px 0 1px !important;
      width: 25px;
      min-width: 25px;
      max-width: 25px;
      text-align: center !important;
      position: sticky;
      left: 48px;
      z-index: 8;
    }
    
    .table th:nth-child(4),
    .table td:nth-child(4) {
      background: #d3d3d3;
      padding: 0 1px 0 1px !important;
      width: auto;
      min-width: fit-content;
      text-align: center !important;
      position: sticky;
      left: 73px;
      z-index: 7;
    }
    
    /* Red text for data cells only in columns 2, 3, 4 */
    .table td:nth-child(2),
    .table td:nth-child(3),
    .table td:nth-child(4) {
      color: #ff0000 !important;
    }
    
    .table th:nth-child(5),
    .table td:nth-child(5) {
      background: #fff3e0;
      padding: 0 !important;
      width: 30px;
      min-width: 30px;
      max-width: 30px;
      position: sticky;
      left: 107px;
      z-index: 6;
    }
    
    .table th:nth-child(6),
    .table td:nth-child(6) {
      background: #e8f5e8;
      padding: 0 !important;
      width: 50px;
      min-width: 50px;
      max-width: 50px;
      position: sticky;
      left: 137px;
      z-index: 5;
    }
    
    /* Ensure sticky headers appear above data cells and are sticky vertically */
    .table thead th {
      position: sticky;
      top: 0;
      z-index: 20;
    }
    
    .table thead th:nth-child(1) { 
      position: sticky;
      top: 0;
      left: 0;
      z-index: 30; 
    }
    .table thead th:nth-child(2) { 
      position: sticky;
      top: 0;
      left: 20px;
      z-index: 29; 
    }
    .table thead th:nth-child(3) { 
      position: sticky;
      top: 0;
      left: 48px;
      z-index: 28; 
    }
    .table thead th:nth-child(4) { 
      position: sticky;
      top: 0;
      left: 73px;
      z-index: 27; 
    }
    .table thead th:nth-child(5) { 
      position: sticky;
      top: 0;
      left: 107px;
      z-index: 26; 
    }
    .table thead th:nth-child(6) { 
      position: sticky;
      top: 0;
      left: 137px;
      z-index: 25; 
    }
    
    .table tbody tr:hover {
      background-color: #f1f3f4;
    }
    
    .table tbody tr.selected {
      background-color: #e3f2fd !important;
    }
    
    .table tbody tr.selected:hover {
      background-color: #bbdefb !important;
    }
    
    .checkbox {
      margin: 0;
      cursor: pointer;
    }
    
    /* Editable table styles */
    .editable-cell {
      position: relative;
      cursor: pointer;
    }
    
    .editable-cell:hover {
      background-color: #e8f4fd !important;
      outline: 1px solid #007bff;
    }
    
    .editable-cell.editing {
      padding: 0 !important;
      background-color: #fff !important;
      outline: 2px solid #007bff;
    }
    
    .cell-input {
      width: 100%;
      height: 100%;
      border: none;
      padding: 4px 6px;
      font-size: 12px;
      font-family: inherit;
      background: white;
      outline: none;
      min-height: 28px;
      box-sizing: border-box;
    }
    
    .cell-input:focus {
      outline: none;
    }
    
    .edit-indicator {
      display: none;
    }
    
    .readonly-cell {
      background-color: #f8f9fa !important;
      cursor: text;
      user-select: text;
    }
    
    .readonly-cell:hover {
      background-color: #e9ecef !important;
      outline: 1px solid #6c757d !important;
    }
    
    .readonly-cell .cell-content {
      user-select: text;
      cursor: text;
    }
    
    /* Tooltip styles for cell hover */
    .cell-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-family: inherit;
      white-space: nowrap;
      z-index: 10000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      max-width: 300px;
      word-break: break-all;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .cell-tooltip.show {
      opacity: 1;
    }
    
    .cell-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
    }
    
    /* Save indicator */
    .saving-cell {
      background-color: #fff3cd !important;
      animation: pulse 1s infinite;
    }
    
    .saved-cell {
      background-color: #d4edda !important;
      transition: background-color 0.3s ease;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    .red-header {
      background: #ffebee !important;
      color: #c62828 !important;
    }
    
    .grey-header {
      background: #ff0000 !important;
      color: #ffffff !important;
      font-weight: bold !important;
    }
    
    /* Blue gradient for table headers starting from column 7 */
    .table th:nth-child(n+7) {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      color: white !important;
      font-weight: bold !important;
    }
    
    /* Blue gradient background for columns 7 and up */
    .table th:nth-child(n+7) {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      color: white !important;
      font-weight: bold !important;
    }
    
    /* Make headers from column 6 onward vertically sticky */
    .table thead th:nth-child(n+6) {
      position: sticky;
      top: 0;
      z-index: 15;
    }
    
    /* Resizable column styles */
    .table th:nth-child(n+6) {
      position: relative;
      min-width: 50px;
    }
    
    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      cursor: col-resize;
      background: rgba(0,0,0,0.1);
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 100;
    }
    
    .table th:nth-child(n+6):hover .resize-handle {
      opacity: 1;
    }
    
    .resize-handle:hover {
      background: rgba(0,0,0,0.3);
      opacity: 1 !important;
    }
    
    .resize-handle.resizing {
      background: #007bff;
      opacity: 1 !important;
    }
    
    .table th.resizing {
      user-select: none;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 20px 0 20px;
      background: white;
      margin: 0px 20px 0 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      font-size: 12px;
      position: sticky;
      top: 90px;
      z-index: 2500;
    }
    
    .pagination {
      display: flex;
      align-items: center;
      font-size: 12px;
    }
    
    .pagination button {
      padding: 2px 6px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 12px;
      color: #007bff;
      text-decoration: none;
    }
    
    .pagination button:hover:not(:disabled) {
      color: #0056b3;
      text-decoration: underline;
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      color: #6c757d;
    }
    
    .pagination button.active {
      color: #ffffff;
      background-color: #007bff;
      font-weight: bold;
    }
    
    .page-size-selector {
      display: flex;
      gap: 5px;
      align-items: center;
      font-size: 12px;
    }
    
    .page-size-selector select {
      padding: 2px 4px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      background: white;
      font-size: 12px;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 5vh auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .modal-header h3 {
      margin: 0;
      color: #495057;
    }
    
    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }
    
    .close:hover {
      color: #000;
    }
    
    .user-search {
      width: 100%;
      padding: 0 10px;
      border: 2px solid #e9ecef;
      border-radius: 5px;
      font-size: 16px;
      margin-bottom: 5px;
      line-height: 1.2;
    }
    
    .user-search:focus {
      border-color: #007bff;
      outline: none;
    }
    
    .user-results {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e9ecef;
      border-radius: 5px;
      background: white;
    }
    
    .user-item {
      padding: 0 10px;
      cursor: pointer;
      border-bottom: 1px solid #f8f9fa;
      display: flex;
      align-items: center;
      gap: 10px;
      height: 36px;
    }
    
    .user-item:hover {
      background: #f0f0f0 !important;
    }
    
    .user-item-alt {
      background: #f8f9fa;
    }
    
    .user-item-alt:hover {
      background: #e9ecef !important;
    }
    
    .user-item:last-child {
      border-bottom: none;
    }
    
    .user-item.selected {
      background: #e3f2fd !important;
      border-left: 4px solid #007bff;
    }
    
    .user-info {
      flex: 1;
    }
    
    .user-name {
      font-weight: 600;
      color: #495057;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #e9ecef;
    }

    /* Responsive modal adjustments */
    @media (max-height: 600px) {
      .modal-content {
        margin: 2vh auto;
        max-height: 95vh;
        padding: 15px;
      }
    }

    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        margin: 2vh auto;
        padding: 15px;
      }
    }

    @media (max-width: 480px) {
      .modal-content {
        width: 98%;
        margin: 1vh auto;
        padding: 10px;
      }
      
      .modal-header {
        margin-bottom: 15px;
      }
      
      .modal-actions {
        margin-top: 15px;
        padding-top: 10px;
      }
    }
  </style>
</head>

<body>
  <!-- Controls -->
  <div class="controls">
    <div style="display: flex; gap: 15px; align-items: center;">
      <!-- View Mode Indicator -->
      <div id="view-indicator" style="font-weight: bold; color: #6c757d; font-size: 14px;">
        Admin View
      </div>
      
      <!-- Manual Toggle Button (for testing) -->
      <button onclick="toggleSupervisorView()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
        Toggle View
      </button>
    </div>
    
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <button id="delete-btn" class="btn btn-danger">Delete</button>
      
      <div class="search-group">
        <input id="search-input" type="text" class="search-input" placeholder="Search contacts..." autocomplete="off" />
        <div id="search-suggestions" class="search-suggestions"></div>
        <button id="search-btn" class="btn btn-primary">Search</button>
        <button id="reset-btn" class="btn btn-secondary">Reset</button>
      </div>
    </div>
    
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <button id="assign-btn" class="btn btn-success">Assign</button>
      <button id="sms-btn" class="btn btn-success">SMS</button>
      <button id="email-btn" class="btn btn-info">Email</button>
      <button id="rvm-btn" class="btn btn-warning">RVM</button>
      <button id="campaign-btn" class="btn btn-primary">Campaign</button>
      <button id="add-btn" class="btn btn-success">Add</button>
      <button id="import-btn" class="btn btn-info">Import</button>
      <button id="export-btn" class="btn btn-warning">Export</button>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Loading contacts...</p>
  </div>

  <!-- Pagination -->
  <div class="pagination-container">
    <div class="dnd-indicator" style="color: #dc3545; font-weight: bold; font-size: 12px;">
      Do Not Disturb = X
    </div>
    
    <div id="select-all-toggle" style="display: none; color: #0056b3; font-weight: bold; font-size: 12px;">
      <a href="#" id="select-all-link" style="color: #0056b3; text-decoration: none; cursor: pointer;">
        <span id="selected-count">0</span> selected - Select all <span id="total-contacts-count">0</span> contacts
      </a>
    </div>
    
    <div class="contact-info" style="color: #495057; font-weight: bold; font-size: 12px;">
      <span id="contact-count-display">Loading...</span>
    </div>
    
    <div class="page-size-selector">
      <label>Show:</label>
      <select id="page-size-select">
        <option value="all">All</option>
        <option value="20">20</option>
        <option value="40">40</option>
        <option value="60">60</option>
        <option value="80">80</option>
        <option value="100">100</option>
        <option value="120">120</option>
        <option value="140">140</option>
        <option value="160">160</option>
        <option value="180">180</option>
        <option value="200">200</option>
        <option value="220">220</option>
        <option value="240">240</option>
        <option value="260">260</option>
        <option value="280">280</option>
        <option value="300">300</option>
        <option value="500">500</option>
        <option value="1000">1000</option>
        <option value="1500">1500</option>
        <option value="2000">2000</option>
        <option value="2500">2500</option>
        <option value="3000">3000</option>
      </select>
      <span>entries</span>
    </div>
    
    <div class="pagination" id="pagination">
      <!-- Pagination buttons will be inserted here -->
    </div>
  </div>

  <!-- Table -->
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>
            <input type="checkbox" id="header-checkbox" class="checkbox">
          </th>
          <th class="grey-header">SMS</th>
          <th class="grey-header">Call</th>
          <th class="grey-header">Email</th>
          <th>No.</th>
          <th>Contact ID<div class="resize-handle"></div></th>
          <th>Assignee<div class="resize-handle"></div></th>
          <th>Sponsor<div class="resize-handle"></div></th>
          <th>Sponsor First<div class="resize-handle"></div></th>
          <th>Sponsor Last<div class="resize-handle"></div></th>
          <th>Sparky ID<div class="resize-handle"></div></th>
          <th>First Name<div class="resize-handle"></div></th>
          <th>Last Name<div class="resize-handle"></div></th>
          <th>Email<div class="resize-handle"></div></th>
          <th>Valid<div class="resize-handle"></div></th>
          <th>Phone<div class="resize-handle"></div></th>
          <th>Address<div class="resize-handle"></div></th>
          <th>City<div class="resize-handle"></div></th>
          <th>State<div class="resize-handle"></div></th>
          <th>Zip<div class="resize-handle"></div></th>
          <th>IP<div class="resize-handle"></div></th>
          <th>Date<div class="resize-handle"></div></th>
          <th>Timezone<div class="resize-handle"></div></th>
          <th>Cell<div class="resize-handle"></div></th>
          <th>Carrier<div class="resize-handle"></div></th>
          <th>Landline<div class="resize-handle"></div></th>
          <th>VoIP<div class="resize-handle"></div></th>
          <th>Other<div class="resize-handle"></div></th>
          <th>Foreign<div class="resize-handle"></div></th>
          <th>Country<div class="resize-handle"></div></th>
        </tr>
      </thead>
      <tbody id="contacts-tbody">
        <!-- Contacts will be populated here -->
      </tbody>
    </table>
  </div>

  <!-- User Assignment Modal -->
  <div id="user-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Assign Users</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <input type="text" id="user-search" class="user-search" placeholder="Search users..." autocomplete="off">
        <div id="user-results" class="user-results">
          <!-- User search results will appear here -->
        </div>
        <div id="selected-user" style="margin-top: 5px; padding: 5px 10px; background: #f8f9fa; border-radius: 5px; display: none;">
          <strong>Selected User:</strong> <span id="selected-user-name"></span>
        </div>
      </div>
      <div class="modal-actions">
        <button id="cancel-assign" class="btn btn-secondary">Cancel</button>
        <button id="unassign-selected" class="btn btn-warning">Unassign Selected</button>
        <button id="confirm-assign" class="btn btn-success" disabled>Assign Selected</button>
      </div>
    </div>
  </div>

  <!-- Add Contact Modal -->
  <div id="add-contact-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Add New Contact</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <form id="add-contact-form">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label>First Name *</label>
              <input type="text" name="first_name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label>Last Name *</label>
              <input type="text" name="last_name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label>Email *</label>
              <input type="email" name="email" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label>Phone</label>
              <input type="tel" name="phone" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label>City</label>
              <input type="text" name="city" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label>State</label>
              <input type="text" name="state" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-actions">
        <button id="cancel-add" class="btn btn-secondary">Cancel</button>
        <button id="confirm-add" class="btn btn-success">Add Contact</button>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="import-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Import Contacts</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 15px;">
          <label>Choose CSV file:</label>
          <input type="file" id="csv-file" accept=".csv" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 15px;">
          <button id="download-template" class="btn btn-info">Download Template</button>
        </div>
        <div id="import-preview" style="display: none;">
          <h4>Preview (first 5 rows):</h4>
          <div id="preview-table" style="max-height: 200px; overflow: auto; border: 1px solid #ddd; border-radius: 4px;"></div>
          <p><strong>Total rows:</strong> <span id="total-rows">0</span></p>
        </div>
      </div>
      <div class="modal-actions">
        <button id="cancel-import" class="btn btn-secondary">Cancel</button>
        <button id="confirm-import" class="btn btn-success" disabled>Import Contacts</button>
      </div>
    </div>
  </div>

  <!-- Message Composer Modal -->
  <div id="message-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="message-modal-title">Compose Message</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 15px;">
          <label>Recipients: <span id="recipient-count">0</span> contacts selected</label>
        </div>
        <div style="margin-bottom: 15px;">
          <label>Subject (for email):</label>
          <input type="text" id="message-subject" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 15px;">
          <label>Message:</label>
          <textarea id="message-content" rows="6" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Enter your message here..."></textarea>
        </div>
        <div style="margin-bottom: 15px;">
          <label>
            <input type="checkbox" id="message-preview"> Preview before sending
          </label>
        </div>
      </div>
      <div class="modal-actions">
        <button id="cancel-message" class="btn btn-secondary">Cancel</button>
        <button id="send-message" class="btn btn-success">Send Message</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Confirm Delete</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong id="delete-count">0</strong> selected contact(s)?</p>
        <p style="color: #dc3545; font-size: 14px;">This action cannot be undone.</p>
      </div>
      <div class="modal-actions">
        <button id="cancel-delete" class="btn btn-secondary">Cancel</button>
        <button id="confirm-delete" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://yggfiuqxfxsoyesqgpyt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlnZ2ZpdXF4Znhzb3llc3FncHl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4MTQ0NjEsImV4cCI6MjA2NjM5MDQ2MX0.YD3fUy1m7lNWCMfUhd1DP7rlmq2tmlwAxg_yJxruB-Q';
    
    // Initialize Supabase client
    let supabase;
    try {
      if (typeof window.supabase !== 'undefined') {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase client initialized successfully');
        
        // Test the connection immediately
        supabase.from('contacts').select('count', { count: 'exact', head: true })
          .then(({ data, error }) => {
            if (error) {
              console.error('Supabase connection test failed:', error);
            } else {
              console.log('Supabase connection test passed');
            }
          })
          .catch(err => {
            console.error('Supabase connection error:', err);
          });
      } else {
        console.warn('Supabase library not loaded, using sample data');
        supabase = null;
      }
    } catch (error) {
      console.error('Failed to initialize Supabase client:', error);
      supabase = null;
    }

    // Global variables
    let allContacts = [];
    let filteredContacts = [];
    let selectedContactIds = new Set();
    let pageSize = 20;
    let currentPage = 1;
    let paginatedContacts = [];
    let selectedUser = null;
    let importData = [];
    let users = [];
    let supervisorViewActive = false; // Track if supervisor view is active
    let currentUser = null; // Store current user info

    // Load users from Supabase profiles table
    async function loadUsers() {
      const timestamp = new Date().toISOString();
      console.log(`[${timestamp}] loadUsers() called - starting fresh user load attempt`);
      
      try {
        if (!supabase) {
          console.warn('Supabase not available');
          users = [];
          return;
        }

        console.log('Attempting to fetch users from profiles table...');

        // Try multiple approaches to get user data from Supabase
        let data = null;
        let error = null;
        
        // First attempt: Simple select from profiles
        try {
          console.log('About to execute profiles query with simple select...');
          const result1 = await supabase
            .from('profiles')
            .select('*');
          
          console.log('Profiles query executed, result:', result1);
          
          if (!result1.error && result1.data) {
            data = result1.data;
            console.log('Success with profiles table (simple select):', data.length + ' users found');
          } else {
            error = result1.error;
            console.log('Profiles table failed, error:', error);
          }
        } catch (e) {
          console.log('Profiles table exception:', e);
          error = e;
        }
        
        // Second attempt: Try auth.users if profiles fails
        if (!data && error) {
          try {
            console.log('Trying auth.users table as fallback...');
            const result2 = await supabase.auth.admin.listUsers();
            if (result2.data && result2.data.users) {
              // Convert auth users to expected format
              data = result2.data.users.map(user => ({
                id: user.id,
                email: user.email,
                name: user.user_metadata?.full_name || user.user_metadata?.name || user.email,
                role: user.user_metadata?.role || 'User',
                created_at: user.created_at
              }));
              console.log('Success with auth.users:', data.length + ' users found');
              error = null;
            }
          } catch (e) {
            console.log('Auth users failed:', e);
          }
        }
        
        // Third attempt: Try a different table name
        if (!data && error) {
          try {
            console.log('Trying users table as final fallback...');
            const result3 = await supabase
              .from('users')
              .select('*');
            
            if (!result3.error && result3.data) {
              data = result3.data;
              console.log('Success with users table:', data.length + ' users found');
              error = null;
            }
          } catch (e) {
            console.log('Users table failed:', e);
          }
        }
        
        if (error && !data) {
          console.error('All user loading attempts failed. Final error:', error);
          users = [];
          showAlert('warning', 'Could not load users from database. Please check your Supabase setup. User assignment may not work properly.');
          return;
        }
        
        if (!data || data.length === 0) {
          console.log('No users found in database');
          users = [];
          const debugMessage = supabase ? 
            'No users found in the database. Open browser console and run window.debugSupabase() to diagnose the issue.' :
            'Supabase not initialized. Check your connection settings.';
          showAlert('info', debugMessage);
          return;
        }
        
        console.log('Raw user data from database:', data.slice(0, 2)); // Show first 2 users for debugging
        
        // Map ALL user data with flexible field mapping, regardless of role
        users = data.map(user => {
          // Use multiple possible field names for name
          const firstName = user.first_name || user.firstName || '';
          const lastName = user.last_name || user.lastName || '';
          const fullName = user.full_name || user.fullName || user.name || user.display_name || user.username || '';
          
          let name;
          if (fullName) {
            name = fullName;
          } else if (firstName || lastName) {
            name = `${firstName} ${lastName}`.trim();
          } else {
            name = user.email || user.email_address || user.user_email || 'Unknown User';
          }
          
          // Use multiple possible field names for email
          const email = user.email || user.email_address || user.user_email || user.auth_email || 'no-email@example.com';
          
          // Create avatar from available data
          let avatar;
          if (user.avatar_url || user.avatar) {
            avatar = user.avatar_url || user.avatar;
          } else if (name && name !== 'Unknown User') {
            avatar = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
          } else {
            avatar = email.charAt(0).toUpperCase();
          }
          
          return {
            id: user.id,
            name: name,
            email: email,
            avatar: avatar,
            role: user.role || user.user_role || user.account_type || 'No Role',
            raw: user // Keep original data for debugging
          };
        });
        
        // Sort users by name after mapping
        users.sort((a, b) => a.name.localeCompare(b.name));
        
        console.log('Successfully loaded ' + users.length + ' users from database (all roles):', users.slice(0, 3)); // Show first 3 users
        console.log('User mapping sample:', users[0]); // Show detailed mapping of first user
        
      } catch (error) {
        console.error('Error loading users:', error);
        users = [];
        showAlert('error', 'Failed to load users from database. User assignment may not work properly.');
      }
    }

    async function handleAssign() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts to assign');
        return;
      }
      
      console.log('Opening assign modal for', selectedContacts.length, 'contacts');
      
      const modal = document.getElementById('user-modal');
      modal.style.display = 'block';
      
      try {
        // Load users from Supabase before displaying
        await loadUsers();
        
        // Show all users initially
        displayUsers(users);
        
        if (users.length === 0) {
          const debugMessage = supabase ? 
            'No users found in the database. Open browser console and run window.debugSupabase() to diagnose the issue.' :
            'Supabase not initialized. Check your connection settings.';
          showAlert('info', debugMessage);
        }
        
        // Focus on search input
        const searchInput = document.getElementById('user-search');
        if (searchInput) {
          searchInput.value = ''; // Clear previous search
          searchInput.focus();
        }
        
        // Disable confirm button initially
        document.getElementById('confirm-assign').disabled = true;
        
      } catch (error) {
        console.error('Error in handleAssign:', error);
        document.getElementById('user-results').innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading users. Please try again.</div>';
        showAlert('error', 'Failed to load users from database');
      }
    }

    async function confirmAssign() {
      console.log('confirmAssign() called'); // Debug log
      
      const selectedUser = document.querySelector('.user-item.selected');
      console.log('Selected user element:', selectedUser); // Debug log
      
      if (!selectedUser) {
        showAlert('warning', 'Please select a user to assign contacts to');
        return;
      }
      
      const userId = selectedUser.getAttribute('data-user-id');
      const user = users.find(u => u.id === userId);
      console.log('Found user object:', user); // Debug log
      
      if (!user) {
        showAlert('error', 'Selected user not found');
        return;
      }
      
      const selectedContacts = getSelectedContacts();
      console.log('Selected contacts for assignment:', selectedContacts); // Debug log
      
      if (selectedContacts.length === 0) {
        showAlert('warning', 'No contacts selected for assignment');
        return;
      }
      
      try {
        console.log('Assigning', selectedContacts.length, 'contacts to user:', user);
        console.log('Selected contact IDs:', selectedContacts);
        console.log('Selected contact IDs types:', selectedContacts.map(id => typeof id));
        
        // Update each selected contact in Supabase
        // Use contact IDs as strings (UUIDs)
        const updates = selectedContacts.map(contactId => {
          console.log(`Updating contact ${contactId} (${typeof contactId})`);
          
          return supabase
            .from('contacts')
            .update({ assignee: user.name })
            .eq('id', contactId); // Use contactId directly (UUID string)
        });
        
        const results = await Promise.all(updates);
        
        // Check for errors
        const errors = results.filter(result => result.error);
        if (errors.length > 0) {
          console.error('Assignment errors:', errors);
          showAlert('error', 'Some contacts could not be assigned: ' + errors[0].error.message);
          return;
        }
        
        // Update local data - use string comparison for UUIDs
        allContacts.forEach(contact => {
          if (selectedContacts.includes(contact.id)) {
            contact.assignee = user.name;
            console.log(`Updated local contact ${contact.id} assignee to ${user.name}`);
          }
        });
        
        // Also update filtered contacts
        filteredContacts.forEach(contact => {
          if (selectedContacts.includes(contact.id)) {
            contact.assignee = user.name;
          }
        });
        
        // Refresh display
        renderContacts();
        
        // Close modal and clear selections
        document.getElementById('user-modal').style.display = 'none';
        clearContactSelections();
        
        // Clear user selection in modal
        const selectedUserDiv = document.getElementById('selected-user');
        selectedUserDiv.style.display = 'none';
        document.querySelectorAll('.user-item.selected').forEach(item => {
          item.classList.remove('selected');
        });
        document.getElementById('confirm-assign').disabled = true;
        
        showAlert('success', `Successfully assigned ${selectedContacts.length} contact(s) to ${user.name}`);
        
      } catch (error) {
        console.error('Error assigning contacts:', error);
        showAlert('error', 'Failed to assign contacts: ' + error.message);
      }
    }

    async function confirmUnassign() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'No contacts selected for unassignment');
        return;
      }
      
      try {
        console.log('Unassigning', selectedContacts.length, 'contacts');
        console.log('Selected contact IDs:', selectedContacts);
        
        // Update each selected contact in Supabase to clear assignee
        const updates = selectedContacts.map(contactId => {
          console.log(`Clearing assignee for contact ${contactId} (${typeof contactId})`);
          
          return supabase
            .from('contacts')
            .update({ assignee: null })
            .eq('id', contactId); // Use contactId directly (UUID string)
        });
        
        const results = await Promise.all(updates);
        
        // Check for errors
        const errors = results.filter(result => result.error);
        if (errors.length > 0) {
          console.error('Unassignment errors:', errors);
          showAlert('error', 'Some contacts could not be unassigned: ' + errors[0].error.message);
          return;
        }
        
        // Update local data - use string comparison for UUIDs
        allContacts.forEach(contact => {
          if (selectedContacts.includes(contact.id)) {
            contact.assignee = '';
            console.log(`Cleared local contact ${contact.id} assignee`);
          }
        });
        
        // Also update filtered contacts
        filteredContacts.forEach(contact => {
          if (selectedContacts.includes(contact.id)) {
            contact.assignee = '';
          }
        });
        
        // Refresh display
        renderContacts();
        
        // Close modal and clear selections
        document.getElementById('user-modal').style.display = 'none';
        clearContactSelections();
        
        // Clear user selection in modal
        const selectedUserDiv = document.getElementById('selected-user');
        selectedUserDiv.style.display = 'none';
        document.querySelectorAll('.user-item.selected').forEach(item => {
          item.classList.remove('selected');
        });
        document.getElementById('confirm-assign').disabled = true;
        
        showAlert('success', `Successfully unassigned ${selectedContacts.length} contact(s)`);
        
      } catch (error) {
        console.error('Error unassigning contacts:', error);
        showAlert('error', 'Failed to unassign contacts: ' + error.message);
      }
    }

    function handleDelete() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts to delete');
        return;
      }
      
      const modal = document.getElementById('delete-modal');
      document.getElementById('delete-count').textContent = selectedContacts.length;
      modal.style.display = 'block';
    }

    function handleSMS() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts for SMS');
        return;
      }
      // Open SMS modal or redirect to SMS page
      showAlert('info', `SMS feature for ${selectedContacts.length} contacts - Coming soon!`);
    }

    function handleEmail() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts for email');
        return;
      }
      // Open email modal or redirect to email page
      showAlert('info', `Email feature for ${selectedContacts.length} contacts - Coming soon!`);
    }

    function handleRVM() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts for RVM');
        return;
      }
      // Open RVM modal or redirect to RVM page
      showAlert('info', `RVM feature for ${selectedContacts.length} contacts - Coming soon!`);
    }

    function handleCampaign() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts for campaign');
        return;
      }
      // Open campaign modal or redirect to campaign page
      showAlert('info', `Campaign feature for ${selectedContacts.length} contacts - Coming soon!`);
    }

    function handleAdd() {
      const modal = document.getElementById('add-contact-modal');
      modal.style.display = 'block';
      // Clear form
      document.getElementById('add-contact-form').reset();
    }

    function handleImport() {
      const modal = document.getElementById('import-modal');
      modal.style.display = 'block';
      // Clear file input and preview
      document.getElementById('csv-file').value = '';
      document.getElementById('import-preview').style.display = 'none';
      document.getElementById('confirm-import').disabled = true;
    }

    function handleExport() {
      // Export all contacts or filtered contacts to CSV
      const contactsToExport = filteredContacts.length > 0 ? filteredContacts : allContacts;
      if (contactsToExport.length === 0) {
        showAlert('warning', 'No contacts to export');
        return;
      }
      
      // Create CSV content
      const headers = ['First Name', 'Last Name', 'Email', 'Phone', 'City', 'State', 'Assignee'];
      const csvContent = [
        headers.join(','),
        ...contactsToExport.map(contact => [
          contact.first_name || '',
          contact.last_name || '',
          contact.email || '',
          contact.phone || '',
          contact.city || '',
          contact.state || '',
          contact.assignee || ''
        ].map(field => `"${field}"`).join(','))
      ].join('\n');
      
      // Download CSV
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'contacts.csv';
      link.click();
      window.URL.revokeObjectURL(url);
      
      showAlert('success', `Exported ${contactsToExport.length} contacts`);
    }

    function handleSearch() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
      
      if (!searchTerm) {
        filteredContacts = [...allContacts];
        hideSuggestions();
      } else {
        filteredContacts = allContacts.filter(contact => {
          return Object.values(contact).some(value => 
            value && value.toString().toLowerCase().includes(searchTerm)
          );
        });
        showSuggestions(searchTerm);
      }
      
      currentPage = 1;
      renderContacts();
      console.log('Search performed for "' + searchTerm + '", found ' + filteredContacts.length + ' contacts');
    }

    function showSuggestions(searchTerm) {
      const suggestions = document.getElementById('search-suggestions');
      const uniqueSuggestions = new Set();
      
      // Get field-specific suggestions
      allContacts.forEach(contact => {
        Object.entries(contact).forEach(([key, value]) => {
          if (value && value.toString().toLowerCase().includes(searchTerm)) {
            uniqueSuggestions.add(value.toString());
          }
        });
      });
      
      const suggestionArray = Array.from(uniqueSuggestions).slice(0, 8);
      
      if (suggestionArray.length > 0) {
        suggestions.innerHTML = suggestionArray.map(suggestion => 
          `<div class="suggestion-item" onclick="selectSuggestion('${suggestion}')">${suggestion}</div>`
        ).join('');
        suggestions.style.display = 'block';
      } else {
        suggestions.style.display = 'none';
      }
    }

    function selectSuggestion(suggestion) {
      document.getElementById('search-input').value = suggestion;
      hideSuggestions();
      handleSearch();
    }

    function hideSuggestions() {
      document.getElementById('search-suggestions').style.display = 'none';
    }

    function showAlert(type, message) {
      console.log(`[${type.toUpperCase()}] ${message}`);
      // Simple alert for now to ensure user sees messages
      alert(`${type.toUpperCase()}: ${message}`);
    }

    function updateStats() {
      console.log('Stats updated - Total contacts:', allContacts.length, 'Filtered:', filteredContacts.length);
    }

    // Simple startup diagnostic
    async function runStartupDiagnostic() {
      console.log('=== STARTUP DIAGNOSTIC ===');
      console.log('1. Supabase library check:', typeof window.supabase !== 'undefined' ? 'LOADED' : 'MISSING');
      console.log('2. Supabase client initialized:', !!supabase ? 'YES' : 'NO');
      console.log('3. Supabase URL:', SUPABASE_URL);
      console.log('4. Running table connection test...');
      
      if (supabase) {
        try {
          const { data, error } = await supabase
            .from('contacts')
            .select('count', { count: 'exact', head: true });
            
          if (error) {
            console.log('5. Table connection: FAILED -', error.message);
            showAlert('error', `Database connection failed: ${error.message}. Please check your Supabase setup and run the table creation script.`);
          } else {
            console.log('5. Table connection: SUCCESS');
            console.log('6. Now testing data query...');
            
            const { data: sampleData, error: queryError } = await supabase
              .from('contacts')
              .select('*')
              .limit(1);
              
            if (queryError) {
              console.log('7. Data query: FAILED -', queryError.message);
              showAlert('error', `Data query failed: ${queryError.message}`);
            } else {
              console.log('7. Data query: SUCCESS');
              console.log('8. Sample data:', sampleData);
              
              if (sampleData && sampleData.length > 0) {
                console.log('9. Data structure check: PASSED');
                console.log('Available columns:', Object.keys(sampleData[0]));
              } else {
                console.log('9. Data structure check: NO DATA (table is empty)');
                showAlert('info', 'Contacts table is empty. You can add sample data by running createSampleContacts() in the browser console.');
              }
            }
          }
        } catch (err) {
          console.log('5. Table connection: ERROR -', err.message);
          showAlert('error', `Connection error: ${err.message}`);
        }
      } else {
        console.log('5. Cannot test - Supabase client not initialized');
        showAlert('error', 'Supabase client not initialized. Please check if the Supabase library loaded correctly.');
      }
      
      console.log('=== DIAGNOSTIC COMPLETE ===');
    }

    // Initialize app with diagnostic
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Contacts app starting...');
      adjustTableHeight();
      
      // Check URL parameters for view mode
      const urlParams = new URLSearchParams(window.location.search);
      const viewParam = urlParams.get('view');
      if (viewParam === 'supervisor') {
        console.log('Supervisor view requested via URL parameter');
        supervisorViewActive = true;
        const viewIndicator = document.getElementById('view-indicator');
        if (viewIndicator) {
          viewIndicator.textContent = 'Supervisor View';
          viewIndicator.style.color = '#28a745';
        }
      }
