<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Assets</title>
  <link rel="icon" type="image/png" href="static/supersparky.png">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #f7f7f7; }
    .container { max-width: 1300px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px #0001; padding: 32px; }
    h1 { color: #1976ff; }
    .assets { display: flex; gap: 24px; margin-bottom: 32px; flex-wrap: wrap; }
    .assets img, .assets .file-icon { border-radius: 8px; box-shadow: 0 1px 4px #0002; height: 80px; width: 80px; object-fit: cover; display: block; }
    .assets .file-block { display: flex; flex-direction: column; align-items: center; margin-right: 12px; margin-bottom: 12px; background: #f9f9f9; padding: 10px 8px 8px 8px; border-radius: 10px; box-shadow: 0 1px 4px #0001; min-width: 180px; }
    .assets .file-label { font-size: 0.85em; margin-top: 4px; word-break: break-all; text-align: center; max-width: 160px; }
    .file-actions { display: flex; gap: 8px; margin-top: 6px; align-items: center; }
    .file-btn, .url-icon-btn, .delete-btn {
      border: none;
      background: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      font-size: 1.2em;
      transition: background 0.15s, color 0.15s;
      border-radius: 4px;
    }
    .file-btn:hover, .url-icon-btn:hover { background: #e3edff; color: #155acb; }
    .url-icon-btn {
      color: #1976ff;
      font-weight: bold;
      font-size: 0.95em;
      letter-spacing: 1px;
      height: 32px;
      padding: 2px 10px;
      position: relative;
    }
    .download-btn {
      color: #1976ff;
      background: none;
      border: none;
      padding: 4px;
      cursor: pointer;
      transition: color 0.15s;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .download-btn:hover {
      color: #155acb;
    }
    .delete-btn {
      width: 18px;
      height: 18px;
      padding: 0;
      background: none;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: pointer;
      align-self: center;
    }
    .copied-tooltip {
      position: absolute;
      background: #1976ff;
      color: #fff;
      padding: 2px 10px;
      border-radius: 4px;
      font-size: 0.85em;
      top: -28px;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0.95;
      pointer-events: none;
      z-index: 10;
      white-space: nowrap;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { padding: 10px 14px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #f3f3f3; color: #1976ff; }
    tr:last-child td { border-bottom: none; }
    .edit-link { display: inline-block; margin-top: 18px; color: #1976ff; font-weight: bold; text-decoration: none; }
    .edit-link:hover { text-decoration: underline; }
    .upload-section { margin: 32px 0 0 0; }
    .upload-btn { background: #1976ff; color: #fff; border: none; padding: 10px 22px; border-radius: 4px; font-size: 1em; cursor: pointer; margin-top: 12px; }
    .upload-btn:hover { background: #155acb; }
    .drop-area {
      border: 2px dashed #1976ff;
      border-radius: 8px;
      padding: 32px;
      text-align: center;
      color: #1976ff;
      background: #f3f8ff;
      margin-top: 18px;
      transition: background 0.2s, border-color 0.2s;
    }
    .drop-area.dragover {
      background: #e3edff;
      border-color: #155acb;
    }
    .browse-btn {
      background: #21c55d;
      color: #fff;
      border: none;
      padding: 8px 18px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1em;
      margin-left: 8px;
      display: inline-block;
    }
    .browse-btn:hover {
      background: #178a3a;
    }
    
    /* Enhanced Controls Styles */
    .view-btn {
      background: #e9ecef;
      border: 1px solid #dee2e6;
      color: #6c757d;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }
    
    .view-btn:hover {
      background: #dee2e6;
      color: #495057;
    }
    
    .view-btn.active {
      background: #1976ff;
      color: white;
      border-color: #1976ff;
    }
    
    /* List View Styles */
    .assets.list-view {
      display: block;
    }
    
    .assets.list-view .file-block {
      display: flex;
      flex-direction: row;
      align-items: center;
      min-width: 100%;
      margin-bottom: 8px;
      padding: 12px 16px;
      background: #fff;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .assets.list-view .file-block img,
    .assets.list-view .file-block .file-icon {
      height: 40px;
      width: 40px;
      margin-right: 16px;
      flex-shrink: 0;
    }
    
    .assets.list-view .file-info {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    
    .assets.list-view .file-label {
      margin: 0;
      font-weight: 600;
      text-align: left;
      max-width: none;
    }
    
    .assets.list-view .file-meta {
      font-size: 12px;
      color: #6c757d;
      margin-top: 4px;
    }
    
    .assets.list-view .file-actions {
      margin: 0;
      flex-shrink: 0;
    }
    
    /* Search and Enhanced Controls Styles */
    .search-sort-controls input[type="text"] {
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .search-sort-controls input[type="text"]:focus {
      border-color: #1976ff;
      box-shadow: 0 0 0 2px rgba(25, 118, 255, 0.1);
      outline: none;
    }
    
    .search-sort-controls select {
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .search-sort-controls select:focus {
      border-color: #1976ff;
      box-shadow: 0 0 0 2px rgba(25, 118, 255, 0.1);
      outline: none;
    }
    
    #clearSearch:hover {
      background: #5a6268;
    }
    
    #assetCount {
      background: #e9ecef;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .no-assets-message {
      text-align: center;
      color: #6c757d;
      font-style: italic;
      padding: 40px 20px;
      background: #f8f9fa;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    /* Group Header Styles */
    .group-header {
      background: #1976ff;
      color: white;
      padding: 12px 16px;
      margin: 24px 0 16px 0;
      border-radius: 6px;
      font-weight: 600;
      font-size: 1.1em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .group-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9em;
    }
    
    .group-section {
      margin-bottom: 32px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script src="static/header.js"></script>
  <script src="static/user_impersonation.js"></script>
</head>
<body>
  <div class="container">
    <h1>Your Profile</h1>
    <h2>Template Settings</h2>
    <p style="color: #666; margin-bottom: 20px; font-size: 1.1em;">Enter the information below that you want inserted into your messages.</p>
    
    <!-- Template Settings Form -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
      <!-- Left Column: Settings Form -->
      <div style="background: #f8f9fa; padding: 24px; border-radius: 8px;">
        <form id="settingsForm">
          <div style="margin-bottom: 10px; display: flex;">
            <div style="width: calc(15% - 8px); margin-right: 10px;">
              <label for="prefix" style="display: block; font-weight: 600; color: #333; margin-bottom: 6px;">Prefix:</label>
              <input type="text" id="prefix" name="prefix" placeholder="Mr." maxlength="4"
                     style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
            </div>
            <div style="width: calc(30% - 8px); margin-right: 10px;">
              <label for="firstName" style="display: block; font-weight: 600; color: #333; margin-bottom: 6px;">First Name:</label>
              <input type="text" id="firstName" name="firstName" placeholder="Enter your first name" 
                     style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
            </div>
            <div style="width: calc(10% - 8px); margin-right: 10px;">
              <label for="middleInitial" style="display: block; font-weight: 600; color: #333; margin-bottom: 6px;">M.I.:</label>
              <input type="text" id="middleInitial" name="middleInitial" placeholder="M" maxlength="1"
                     style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; text-align: center; box-sizing: border-box;">
            </div>
            <div style="width: calc(30% - 8px); margin-right: 10px;">
              <label for="lastName" style="display: block; font-weight: 600; color: #333; margin-bottom: 6px;">Last Name:</label>
              <input type="text" id="lastName" name="lastName" placeholder="Enter your last name" 
                     style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
            </div>
            <div style="width: 15%;">
              <label for="suffix" style="display: block; font-weight: 600; color: #333; margin-bottom: 6px;">Suffix:</label>
              <input type="text" id="suffix" name="suffix" placeholder="Jr." maxlength="4"
                     style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
            </div>
          </div>
          
          <div style="margin-bottom: 20px; display: flex;">
            <div style="width: calc(65% - 5px); margin-right: 10px;">
              <label for="email" style="display: block; font-weight: 600; color: #333; margin-bottom: 6px;">Email:</label>
              <input type="email" id="email" name="email" placeholder="Enter your email" 
                     style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
            </div>
            <div style="width: 35%;">
              <label for="phone" style="display: block; font-weight: 600; color: #333; margin-bottom: 6px;">Phone:</label>
              <input type="tel" id="phone" name="phone" placeholder="Enter phone number" maxlength="16"
                     style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
            </div>
          </div>
          
          <!-- New row for Sparky Phone and Support -->
          <div style="margin-bottom: 20px; display: flex;">
            <div style="width: calc(50% - 5px); margin-right: 10px;">
              <label for="sparkyPhone" style="display: block; font-weight: 600; color: #333; margin-bottom: 6px;">Sparky Phone:</label>
              <input type="tel" id="sparkyPhone" name="sparkyPhone" placeholder="Sparky Callback Phone Number" maxlength="16"
                     style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
            </div>
            <div style="width: 50%;">
              <label for="support" style="display: block; font-weight: 600; color: #333; margin-bottom: 6px;">Support:</label>
              <input type="text" id="support" name="support" placeholder="Live Support Link" 
                     style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
            </div>
          </div>

          <!-- Sparky Username row -->
          <div style="margin-bottom: 20px;">
            <label for="sparkyUsername" style="display: block; font-weight: 600; color: #333; margin-bottom: 6px;">Sparky Username:</label>
            <input type="text" id="sparkyUsername" name="sparkyUsername" placeholder="Your Sparky Username" maxlength="50"
                   style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
          </div>
          
          <div style="margin-bottom: 10px; display: flex;">
            <div style="width: calc(50% - 7px); margin-right: 10px;">
              <label for="city" style="display: block; font-weight: 600; color: #333; margin-bottom: 6px;">City:</label>
              <input type="text" id="city" name="city" placeholder="Your city" 
                     style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
            </div>
            <div style="width: calc(25% - 5px); margin-right: 10px;">
              <label for="state" style="display: block; font-weight: 600; color: #333; margin-bottom: 6px;">State:</label>
              <input type="text" id="state" name="state" placeholder="ST" maxlength="2"
                     style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box; text-transform: uppercase;">
            </div>
            <div style="width: 25%;">
              <label for="country" style="display: block; font-weight: 600; color: #333; margin-bottom: 6px;">Country:</label>
              <input type="text" id="country" name="country" placeholder="USA" 
                     style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
            </div>
          </div>
          
          <div style="margin-bottom: 10px; display: flex;">
            <div style="width: calc(50% - 5px); margin-right: 10px;">
              <label for="website" style="display: block; font-weight: 600; color: #333; margin-bottom: 6px;">Website:</label>
              <input type="url" id="website" name="website" placeholder="yourwebsite.com" 
                     style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
            </div>
            <div style="width: 50%;">
              <label for="hotLink" style="display: block; font-weight: 600; color: #333; margin-bottom: 6px;">Hot Link:</label>
              <input type="url" id="hotLink" name="hotLink" placeholder="special-link.com" 
                     style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
            </div>
          </div>
          <p style="color: #666; font-size: 0.9em; margin-top: -5px; margin-bottom: 20px; font-style: italic;">
            💡 For better deliverability, do not include https://
          </p>
        </form>
      </div>
      
      <!-- Right Column: Profile Picture and Bio -->
      <div style="background: #f8f9fa; padding: 24px; border-radius: 8px;">
        <h3 style="margin-top: 0; margin-bottom: 20px; color: #333; font-size: 1.2em;">Profile & Bio</h3>
        
        <div style="display: flex; gap: 24px; margin-bottom: 24px;">
          <!-- Profile Picture Upload -->
          <div style="flex-shrink: 0;">
            <label style="display: block; font-weight: 600; color: #333; margin-bottom: 8px;">Profile Picture:</label>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
              <div id="profilePicturePreview" style="width: 80px; height: 80px; border-radius: 50%; background: #e9ecef; border: 2px dashed #ddd; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                <span style="color: #666; font-size: 0.8em; text-align: center;">No Image</span>
              </div>
              <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
              <div style="display: flex; flex-direction: column; gap: 6px;">
                <button type="button" id="uploadProfileBtn" style="background: #1976ff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                  Choose Image
                </button>
                <button type="button" id="removeProfileBtn" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em; display: none;">
                  Remove
                </button>
              </div>
            </div>
          </div>
          
          <!-- Bio Text Area -->
          <div style="flex-grow: 1;">
            <label for="bio" style="display: block; font-weight: 600; color: #333; margin-bottom: 8px;">Bio:</label>
            <textarea id="bio" name="bio" placeholder="Write a brief bio about yourself or your business..." 
                      style="width: 100%; height: 120px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
            <div style="text-align: right; margin-top: 4px;">
              <small id="bioCharCount" style="color: #666; font-size: 0.8em;">0 / 500 characters</small>
            </div>
          </div>
        </div>
        
        <!-- Buttons Row -->
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button type="submit" form="settingsForm" style="background: #1976ff; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-weight: 600;">
              Save Settings
            </button>
            <span id="saveStatus" style="color: #28a745; font-weight: 500; opacity: 0; transition: opacity 0.3s;"></span>
          </div>
          <button type="button" id="changePasswordBtn" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-weight: 600;">
            Change Password
          </button>
        </div>
      </div>
    </div>
    
    <h2 style="margin-top:40px;">Your Assets</h2>
    
    <!-- Migration Alert Section -->
    <div id="migrationAlert" style="display: none; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <span style="font-size: 1.2em;">⚠️</span>
        <div style="flex-grow: 1;">
          <strong>Legacy Assets Detected</strong>
          <br>
          <span id="legacyCount">0</span> assets are using the old storage structure. For enhanced security, migrate them to your personal folder.
        </div>
        <div>
          <button onclick="migrateAllLegacyAssets()" style="background: #ff9800; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 8px;">
            Migrate All
          </button>
          <button onclick="dismissMigrationAlert()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
            Dismiss
          </button>
        </div>
      </div>
    </div>
    
    <!-- Two Column Layout: Upload & Sort Controls -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
      
      <!-- Left Column: Upload Section -->
      <div class="upload-section" style="margin: 0; background: #f8f9fa; padding: 20px; border-radius: 8px;">
        <h3 style="margin-top: 0; color: #1976ff;">Upload New Asset</h3>
        <form id="uploadForm" enctype="multipart/form-data">
          <input type="file" id="fileInput" name="file" style="display:none;" multiple />
          <div id="dropArea" class="drop-area" style="margin-top: 16px;">
            Drag &amp; drop files here,
            <button type="button" id="browseBtn" class="browse-btn">Browse</button>
          </div>
          <button type="submit" class="upload-btn" style="margin-top: 16px;">Upload Files</button>
        </form>
      </div>
      
      <!-- Right Column: Search and Sort Controls -->
      <div class="search-sort-controls" style="margin: 0; background: #f8f9fa; padding: 20px; border-radius: 8px;">
        <h3 style="margin-top: 0; color: #1976ff;">Search & Filter</h3>
        
        <!-- Search Bar -->
        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
          <label style="font-weight: 600; color: #333; min-width: 60px;">Search:</label>
          <input type="text" id="searchAssets" placeholder="Search by name, description, or tags..." 
                 style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
          <button id="clearSearch" style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear</button>
        </div>
        
        <!-- Sort Controls Row 1 -->
        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
          <label style="font-weight: 600; color: #333; min-width: 60px;">Sort by:</label>
          <select id="sortBy" style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            <option value="created_at_desc">Date (Newest First)</option>
            <option value="created_at_asc">Date (Oldest First)</option>
            <option value="name_asc">Name (A-Z)</option>
            <option value="name_desc">Name (Z-A)</option>
            <option value="type_asc">Type (A-Z)</option>
            <option value="type_desc">Type (Z-A)</option>
            <option value="size_desc">Size (Largest First)</option>
            <option value="size_asc">Size (Smallest First)</option>
            <option value="updated_at_desc">Modified (Newest First)</option>
            <option value="updated_at_asc">Modified (Oldest First)</option>
          </select>
        </div>
        
        <!-- Filter Controls Row 2 -->
        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
          <label style="font-weight: 600; color: #333; min-width: 60px;">Filter:</label>
          <select id="filterType" style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            <option value="all">All Types</option>
            <option value="sms_message">SMS Messages</option>
            <option value="image">Images</option>
            <option value="document">Documents</option>
            <option value="video">Videos</option>
            <option value="audio">Audio</option>
            <option value="other">Other</option>
          </select>
          <select id="dateFilter" style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            <option value="all">All Time</option>
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="quarter">Last 3 Months</option>
            <option value="year">This Year</option>
          </select>
        </div>
        
        <!-- Group By Controls Row 3 -->
        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
          <label style="font-weight: 600; color: #333; min-width: 60px;">Group:</label>
          <select id="groupBy" style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            <option value="none">No Grouping</option>
            <option value="type">Group by Type</option>
            <option value="date">Group by Date</option>
            <option value="size">Group by Size</option>
          </select>
        </div>
        
        <!-- View Controls and Asset Count -->
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span id="assetCount" style="color: #6c757d; font-size: 14px; font-weight: 500;"></span>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button id="gridView" class="view-btn active" title="Grid View">📱</button>
            <button id="listView" class="view-btn" title="List View">📋</button>
            <button onclick="debugAssetLoading()" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;" title="Open browser console to see debug info">
              🐛
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="assets" id="user-assets">
      <!-- User files will be loaded here -->
    </div>
  </div>
  
  <script>
    // --- CONFIGURE YOUR SUPABASE INFO ---
    const SUPABASE_URL = 'https://yggfiuqxfxsoyesqgpyt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlnZ2ZpdXF4Znhzb3llc3FncHl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4MTQ0NjEsImV4cCI6MjA2NjM5MDQ2MX0.YD3fUy1m7lNWCMfUhd1DP7rlmq2tmlwAxg_yJxruB-Q';
    const BUCKET = 'assets';

    // Use the global Supabase client from global-nav-v2.js if available, otherwise create one
    let supabase;
    if (window.globalSupabase) {
      supabase = window.globalSupabase;
      console.log('[DEBUG] Using global Supabase client');
    } else if (window.supabase && window.supabase.createClient) {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('[DEBUG] Created new Supabase client');
    } else {
      console.error('[ERROR] Supabase library not available');
    }

    // Clear any corrupted session data on initialization
    function clearCorruptedSession() {
      try {
        // Clear Supabase session storage keys that might be corrupted
        const keysToCheck = [
          `sb-${SUPABASE_URL.split('//')[1].split('.')[0]}-auth-token`,
          'supabase.auth.token',
          'sb-yggfiuqxfxsoyesqgpyt-auth-token'
        ];
        
        keysToCheck.forEach(key => {
          const item = localStorage.getItem(key);
          if (item) {
            try {
              const parsed = JSON.parse(item);
              // Only remove if token is clearly corrupted (not just missing fields)
              if (parsed && typeof parsed !== 'object') {
                console.log(`[AUTH] Removing clearly corrupted session data for key: ${key}`);
                localStorage.removeItem(key);
              }
            } catch (e) {
              console.log(`[AUTH] Removing invalid JSON session data for key: ${key}`);
              localStorage.removeItem(key);
            }
          }
        });
      } catch (error) {
        console.error('[AUTH] Error clearing corrupted session:', error);
      }
    }

    // Comment out aggressive session clearing to prevent navigation issues
    // clearCorruptedSession();

    // Check authentication on page load
    async function checkAuthentication() {
      try {
        // First try to refresh the session to ensure we have a valid token
        const { data: sessionData, error: refreshError } = await supabase.auth.refreshSession();
        
        if (refreshError) {
          console.error('[AUTH] Session refresh failed:', refreshError);
          await supabase.auth.signOut();
          window.location.href = 'login.html';
          return false;
        }
        
        const { data: { session }, error } = await supabase.auth.getSession();
        console.log('[AUTH] Session check:', { session, error });
        
        if (error) {
          console.error('[AUTH] Session error:', error);
          await supabase.auth.signOut();
          window.location.href = 'login.html';
          return false;
        }
        
        if (!session || !session.user) {
          console.log('[AUTH] No valid session found, redirecting to login');
          window.location.href = 'login.html';
          return false;
        }
        
        console.log('[AUTH] User authenticated:', session.user.email);
        return true;
      } catch (error) {
        console.error('[AUTH] Authentication check failed:', error);
        await supabase.auth.signOut();
        window.location.href = 'login.html';
        return false;
      }
    }

    // Helper function to get authenticated user with session refresh
    async function getAuthenticatedUser() {
      try {
        // First check if we're in impersonation mode
        const impersonationData = localStorage.getItem('impersonationData');
        console.log('🎭 Assets: Checking impersonation data:', impersonationData ? 'Found' : 'Not found');
        
        if (impersonationData) {
          try {
            const data = JSON.parse(impersonationData);
            console.log('🎭 Assets: Parsed impersonation data:', data);
            
            if (data.impersonatedUser) {
              console.log('🎭 Assets: Using impersonated user:', data.impersonatedUser.email, 'ID:', data.impersonatedUser.id);
              // Return impersonated user in the same format as supabase user
              const impersonatedUser = {
                id: data.impersonatedUser.id,
                email: data.impersonatedUser.email,
                // Add other properties that might be needed
                user_metadata: data.impersonatedUser.user_metadata || {},
                app_metadata: data.impersonatedUser.app_metadata || {}
              };
              console.log('🎭 Assets: Returning impersonated user object:', impersonatedUser);
              return impersonatedUser;
            }
          } catch (parseError) {
            console.error('❌ Assets: Error parsing impersonation data:', parseError);
            localStorage.removeItem('impersonationData');
          }
        }
        
        console.log('🔑 Assets: No impersonation, using normal auth');
        
        // Try to refresh session first
        const { data: sessionData, error: refreshError } = await supabase.auth.refreshSession();
        
        if (refreshError) {
          console.error('Session refresh failed:', refreshError);
          // Clear invalid session and redirect
          await supabase.auth.signOut();
          window.location.href = 'login.html';
          return null;
        }
        
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          console.error('User authentication error:', userError);
          // Clear invalid session and redirect
          await supabase.auth.signOut();
          window.location.href = 'login.html';
          return null;
        }
        
        console.log('🔑 Assets: Using normal authenticated user:', user.email, 'ID:', user.id);
        return user;
      } catch (error) {
        console.error('Error getting authenticated user:', error);
        // Clear invalid session and redirect
        await supabase.auth.signOut();
        window.location.href = 'login.html';
        return null;
      }
    }

    // Global variables for sorting and filtering
    let allAssets = [];
    let currentView = 'grid';

    // Load user settings from the settings table
    async function loadUserSettings() {
      try {
        const user = await getAuthenticatedUser();
        if (!user) {
          return;
        }

        const { data: settings, error } = await supabase
          .from('settings')
          .select('*')
          .eq('user_id', user.id)
          .single();

        if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
          console.error('Error loading settings:', error);
          return;
        }

        if (settings) {
          // Populate form fields with existing settings
          document.getElementById('prefix').value = settings.prefix || '';
          document.getElementById('firstName').value = settings.first_name || '';
          document.getElementById('middleInitial').value = settings.middle_initial || '';
          document.getElementById('lastName').value = settings.last_name || '';
          document.getElementById('suffix').value = settings.suffix || '';
          document.getElementById('email').value = settings.email || '';
          document.getElementById('phone').value = settings.phone || '';
          document.getElementById('sparkyPhone').value = settings.sparky_phone || '';
          document.getElementById('support').value = settings.support || '';
          document.getElementById('sparkyUsername').value = settings.sparky_username || '';
          document.getElementById('city').value = settings.city || '';
          document.getElementById('state').value = settings.state || '';
          document.getElementById('country').value = settings.country || '';
          document.getElementById('website').value = settings.website || '';
          document.getElementById('hotLink').value = settings.hot_link || '';
          document.getElementById('bio').value = settings.bio || '';
          
          // Update bio character count
          const bioLength = (settings.bio || '').length;
          document.getElementById('bioCharCount').textContent = `${bioLength} / 500 characters`;
        }
      } catch (error) {
        console.error('Error loading user settings:', error);
      }
    }

    // Save user settings to the settings table
    async function saveUserSettings(formData) {
      try {
        console.log('Attempting to save settings:', formData);
        
        const user = await getAuthenticatedUser();
        if (!user) {
          return;
        }

        console.log('Authenticated user:', user.id);

        const settingsData = {
          user_id: user.id,
          prefix: formData.prefix || '',
          first_name: formData.firstName || '',
          middle_initial: formData.middleInitial || '',
          last_name: formData.lastName || '',
          suffix: formData.suffix || '',
          email: formData.email || '',
          phone: formData.phone || '',
          sparky_phone: formData.sparkyPhone || '',
          support: formData.support || '',
          sparky_username: formData.sparkyUsername || '',
          city: formData.city || '',
          state: formData.state || '',
          country: formData.country || '',
          website: formData.website || '',
          hot_link: formData.hotLink || '',
          bio: formData.bio || '',
          updated_at: new Date().toISOString()
        };

        console.log('Settings data to save:', settingsData);

        // First, try to check if the settings table exists and is accessible
        const { data: testData, error: testError } = await supabase
          .from('settings')
          .select('user_id')
          .eq('user_id', user.id)
          .limit(1);

        console.log('Table access test:', { testData, testError });

        // Try to update existing record, or insert if none exists
        const { data, error } = await supabase
          .from('settings')
          .upsert(settingsData, { 
            onConflict: 'user_id',
            returning: 'minimal'
          });

        console.log('Upsert result:', { data, error });

        if (error) {
          console.error('Supabase upsert error:', error);
          throw error;
        }

        // Show success message
        const statusEl = document.getElementById('saveStatus');
        statusEl.textContent = 'Settings saved successfully!';
        statusEl.style.opacity = '1';
        setTimeout(() => {
          statusEl.style.opacity = '0';
        }, 3000);

      } catch (error) {
        console.error('Error saving settings:', error);
        console.error('Error details:', {
          message: error.message,
          details: error.details,
          hint: error.hint,
          code: error.code
        });
        
        // Show detailed error message
        const statusEl = document.getElementById('saveStatus');
        let errorMessage = 'Error saving settings. ';
        
        if (error.message.includes('relation "settings" does not exist')) {
          errorMessage += 'Settings table not found. Please contact support.';
        } else if (error.message.includes('permission denied') || error.message.includes('invalid claim') || error.message.includes('missing sub claim')) {
          errorMessage += 'Authentication expired. Redirecting to login...';
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
        } else if (error.code === '23505') {
          errorMessage += 'Duplicate entry detected.';
        } else {
          errorMessage += 'Please try again. ' + (error.message || '');
        }
        
        statusEl.textContent = errorMessage;
        statusEl.style.color = '#dc3545';
        statusEl.style.opacity = '1';
        setTimeout(() => {
          statusEl.style.opacity = '0';
          statusEl.style.color = '#28a745';
        }, 5000);
      }
    }

    // Upload avatar image to Supabase Storage
    async function uploadAvatarImage(file) {
      try {
        const user = await getAuthenticatedUser();
        if (!user) {
          throw new Error('User not authenticated');
        }

        // Create a unique filename
        const timestamp = new Date().getTime();
        const fileExt = file.name.split('.').pop();
        const fileName = `avatar_${user.id}_${timestamp}.${fileExt}`;

        // Upload to Supabase Storage
        const { data, error } = await supabase.storage
          .from('assets')
          .upload(fileName, file, {
            cacheControl: '3600',
            upsert: false
          });

        if (error) {
          console.error('Storage upload error:', error);
          throw error;
        }

        // Get the public URL
        const { data: urlData } = supabase.storage
          .from('assets')
          .getPublicUrl(fileName);

        return urlData.publicUrl;
      } catch (error) {
        console.error('Error uploading avatar:', error);
        throw error;
      }
    }

    // Save avatar URL to user settings
    async function saveAvatarUrl(avatarUrl) {
      try {
        console.log('Saving avatar URL:', avatarUrl);
        const user = await getAuthenticatedUser();
        if (!user) {
          throw new Error('User not authenticated');
        }

        console.log('User ID for avatar save:', user.id);

        const { data, error } = await supabase
          .from('settings')
          .upsert({
            user_id: user.id,
            avatar_url: avatarUrl,
            updated_at: new Date().toISOString()
          }, {
            onConflict: 'user_id',
            returning: 'minimal'
          });

        if (error) {
          console.error('Error saving avatar URL:', error);
          throw error;
        }

        console.log('Avatar URL saved successfully:', data);
      } catch (error) {
        console.error('Error saving avatar URL:', error);
        throw error;
      }
    }

    // Load and display saved avatar
    async function loadSavedAvatar() {
      try {
        const user = await getAuthenticatedUser();
        if (!user) {
          return;
        }

        const { data: settings, error } = await supabase
          .from('settings')
          .select('avatar_url')
          .eq('user_id', user.id)
          .single();

        if (settings && settings.avatar_url && !error) {
          const profilePicturePreview = document.getElementById('profilePicturePreview');
          const removeProfileBtn = document.getElementById('removeProfileBtn');
          
          profilePicturePreview.innerHTML = `<img src="${settings.avatar_url}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
          removeProfileBtn.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading saved avatar:', error);
      }
    }

    // Remove avatar from storage and settings
    async function removeAvatar() {
      try {
        const user = await getAuthenticatedUser();
        if (!user) {
          throw new Error('User not authenticated');
        }

        // Get current avatar URL to delete from storage
        const { data: settings, error: getError } = await supabase
          .from('settings')
          .select('avatar_url')
          .eq('user_id', user.id)
          .single();

        if (settings && settings.avatar_url && !getError) {
          // Extract filename from URL
          const urlParts = settings.avatar_url.split('/');
          const fileName = urlParts[urlParts.length - 1];

          // Delete from storage
          const { error: deleteError } = await supabase.storage
            .from('assets')
            .remove([fileName]);

          if (deleteError) {
            console.warn('Error deleting avatar from storage:', deleteError);
          }
        }

        // Remove avatar URL from settings
        const { error: updateError } = await supabase
          .from('settings')
          .update({
            avatar_url: null,
            updated_at: new Date().toISOString()
          })
          .eq('user_id', user.id);

        if (updateError) {
          console.error('Error removing avatar URL from settings:', updateError);
          throw updateError;
        }

        console.log('Avatar removed successfully');
      } catch (error) {
        console.error('Error removing avatar:', error);
        throw error;
      }
    }

    // Format file size for display
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // Determine file type from filename
    function getFileType(filename) {
      const ext = filename.toLowerCase().split('.').pop();
      if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'bmp', 'svg', 'ico'].includes(ext)) {
        return 'image';
      } else if (['mp4', 'avi', 'mov', 'wmv', 'flv', 'webm'].includes(ext)) {
        return 'video';
      } else if (['mp3', 'wav', 'flac', 'aac', 'ogg'].includes(ext)) {
        return 'audio';
      } else if (['pdf', 'doc', 'docx', 'txt', 'rtf'].includes(ext)) {
        return 'document';
      } else {
        return 'other';
      }
    }

    // Load and show all assets from both storage bucket and assets table
    async function loadAssets() {
      const userAssets = document.getElementById('user-assets');
      userAssets.innerHTML = '<p>Loading assets...</p>';
      
      try {
        // Get current user (with impersonation support)
        const user = await getAuthenticatedUser();
        console.log('🎯 Assets: loadAssets using user:', user?.email, 'ID:', user?.id);
        
        if (!user) {
          userAssets.innerHTML = '<p style="color:orange;">Please log in to view your assets.</p>';
          return;
        }

        allAssets = [];

        // Load storage bucket files for current user (new structure)
        const { data: newStorageFiles, error: newStorageError } = await supabase.storage
          .from(BUCKET)
          .list(user.id, { limit: 100, offset: 0, sortBy: { column: 'name', order: 'desc' } });

        console.log('🗂️ Assets: Storage files for user', user.id, ':', newStorageFiles?.length || 0, 'files');

        if (newStorageFiles && !newStorageError) {
          newStorageFiles.forEach(file => {
            const filePath = `${user.id}/${file.name}`;
            const { data: publicUrlData } = supabase.storage.from(BUCKET).getPublicUrl(filePath);
            const url = publicUrlData.publicUrl;
            
            console.log('📁 Assets: Adding file:', file.name, 'URL:', url);
            
            allAssets.push({
              id: file.name,
              name: file.name.replace(/^[^_]+_[^_]+_/, ''), // Remove timestamp/random prefix
              type: getFileType(file.name),
              source: 'storage',
              created_at: file.created_at || new Date().toISOString(),
              updated_at: file.updated_at || new Date().toISOString(),
              size: file.metadata?.size || 0,
              url: url,
              file: file,
              pathType: 'new'
            });
          });
        }

        // TEMPORARY: Also check for legacy assets in root folder
        // This helps during migration period
        const { data: legacyStorageFiles, error: legacyStorageError } = await supabase.storage
          .from(BUCKET)
          .list('', { limit: 100, offset: 0, sortBy: { column: 'name', order: 'desc' } });

        if (legacyStorageFiles && !legacyStorageError) {
          // Filter out any folder names (which would be user IDs) and only show actual files
          const actualFiles = legacyStorageFiles.filter(file => !file.name.includes('/') && file.name.includes('.'));
          
          actualFiles.forEach(file => {
            const { data: publicUrlData } = supabase.storage.from(BUCKET).getPublicUrl(file.name);
            const url = publicUrlData.publicUrl;
            
            allAssets.push({
              id: file.name,
              name: file.name.replace(/^[^_]+_[^_]+_/, ''), // Remove timestamp/random prefix
              type: getFileType(file.name),
              source: 'storage',
              created_at: file.created_at || new Date().toISOString(),
              updated_at: file.updated_at || new Date().toISOString(),
              size: file.metadata?.size || 0,
              url: url,
              file: file,
              pathType: 'legacy'
            });
          });
        }

        // Load assets table records (SMS messages, etc.) - Optional table
        try {
          const { data: assetRecords, error: assetsError } = await supabase
            .from('assets')
            .select('*')
            .eq('user_id', user.id)
            .order('created_at', { ascending: false });

          if (assetRecords && !assetsError) {
            assetRecords.forEach(asset => {
              allAssets.push({
                id: asset.id,
                name: asset.name,
                description: asset.description,
                type: asset.type || 'other',
                source: 'database',
                created_at: asset.created_at,
              updated_at: asset.updated_at,
              size: JSON.stringify(asset.content || {}).length,
              tags: asset.tags || [],
              content: asset.content,
              asset: asset
            });
          });
        } else if (assetsError) {
          console.log('Assets table not available (this is optional):', assetsError.message);
        }
        } catch (assetsTableError) {
          console.log('Assets table not available (this is optional):', assetsTableError.message);
        }

        renderAssets();

      } catch (error) {
        console.error('Error loading assets:', error);
        userAssets.innerHTML = '<p style="color:red;">Failed to load assets.</p>';
      }
    }

    // Sort and filter assets
    function sortAndFilterAssets() {
      const sortBy = document.getElementById('sortBy').value;
      const filterType = document.getElementById('filterType').value;
      const dateFilter = document.getElementById('dateFilter').value;
      const searchTerm = document.getElementById('searchAssets').value.toLowerCase().trim();

      let filteredAssets = [...allAssets];

      // Apply search filter
      if (searchTerm) {
        filteredAssets = filteredAssets.filter(asset => {
          const name = asset.name.toLowerCase();
          const description = (asset.description || '').toLowerCase();
          const tags = (asset.tags || []).join(' ').toLowerCase();
          
          return name.includes(searchTerm) || 
                 description.includes(searchTerm) || 
                 tags.includes(searchTerm);
        });
      }

      // Apply type filter
      if (filterType !== 'all') {
        filteredAssets = filteredAssets.filter(asset => asset.type === filterType);
      }

      // Apply date filter
      if (dateFilter !== 'all') {
        const now = new Date();
        const filterDate = new Date();
        
        switch (dateFilter) {
          case 'today':
            filterDate.setHours(0, 0, 0, 0);
            break;
          case 'week':
            filterDate.setDate(now.getDate() - 7);
            break;
          case 'month':
            filterDate.setMonth(now.getMonth() - 1);
            break;
          case 'quarter':
            filterDate.setMonth(now.getMonth() - 3);
            break;
          case 'year':
            filterDate.setFullYear(now.getFullYear() - 1);
            break;
        }
        
        if (dateFilter !== 'all') {
          filteredAssets = filteredAssets.filter(asset => 
            new Date(asset.created_at) >= filterDate
          );
        }
      }

      // Apply sorting
      filteredAssets.sort((a, b) => {
        switch (sortBy) {
          case 'name_asc':
            return a.name.localeCompare(b.name);
          case 'name_desc':
            return b.name.localeCompare(a.name);
          case 'created_at_asc':
            return new Date(a.created_at) - new Date(b.created_at);
          case 'created_at_desc':
            return new Date(b.created_at) - new Date(a.created_at);
          case 'updated_at_asc':
            return new Date(a.updated_at) - new Date(b.updated_at);
          case 'updated_at_desc':
            return new Date(b.updated_at) - new Date(a.updated_at);
          case 'type_asc':
            return a.type.localeCompare(b.type);
          case 'type_desc':
            return b.type.localeCompare(a.type);
          case 'size_asc':
            return a.size - b.size;
          case 'size_desc':
            return b.size - a.size;
          default:
            return new Date(b.created_at) - new Date(a.created_at);
        }
      });

      // Update asset count display
      document.getElementById('assetCount').textContent = 
        `${filteredAssets.length} of ${allAssets.length} assets`;

      return filteredAssets;
    }

    // Render assets with current sort/filter
    function renderAssets() {
      const userAssets = document.getElementById('user-assets');
      const sortedAssets = sortAndFilterAssets();
      const groupBy = document.getElementById('groupBy').value;

      // Check for legacy assets and show migration alert
      const legacyAssets = allAssets.filter(asset => asset.pathType === 'legacy');
      const migrationAlert = document.getElementById('migrationAlert');
      const legacyCount = document.getElementById('legacyCount');
      
      if (legacyAssets.length > 0 && !sessionStorage.getItem('migrationAlertDismissed')) {
        migrationAlert.style.display = 'block';
        legacyCount.textContent = legacyAssets.length;
      } else {
        migrationAlert.style.display = 'none';
      }

      if (sortedAssets.length === 0) {
        const searchTerm = document.getElementById('searchAssets').value.trim();
        const filterType = document.getElementById('filterType').value;
        const dateFilter = document.getElementById('dateFilter').value;
        
        let message = 'No assets found';
        if (searchTerm || filterType !== 'all' || dateFilter !== 'all') {
          message += ' matching your filters.';
          message += '<br><small>Try adjusting your search term or filters.</small>';
        } else {
          message += '. Upload some files to get started!';
        }
        
        userAssets.innerHTML = `<div class="no-assets-message">${message}</div>`;
        return;
      }

      userAssets.innerHTML = '';
      
      if (groupBy === 'none') {
        // No grouping - render as before
        userAssets.className = `assets ${currentView === 'list' ? 'list-view' : ''}`;
        sortedAssets.forEach(asset => {
          const block = createAssetBlock(asset);
          userAssets.appendChild(block);
        });
      } else {
        // Group assets
        const groups = groupAssets(sortedAssets, groupBy);
        userAssets.className = '';
        
        Object.keys(groups).forEach(groupName => {
          const groupAssets = groups[groupName];
          
          // Create group header
          const groupHeader = document.createElement('div');
          groupHeader.className = 'group-header';
          groupHeader.innerHTML = `
            <span>${groupName}</span>
            <span class="group-count">${groupAssets.length} item${groupAssets.length !== 1 ? 's' : ''}</span>
          `;
          userAssets.appendChild(groupHeader);
          
          // Create group container
          const groupContainer = document.createElement('div');
          groupContainer.className = `group-section assets ${currentView === 'list' ? 'list-view' : ''}`;
          
          groupAssets.forEach(asset => {
            const block = createAssetBlock(asset);
            groupContainer.appendChild(block);
          });
          
          userAssets.appendChild(groupContainer);
        });
      }
    }

    // Create an asset block (extracted for reuse)
    function createAssetBlock(asset) {
      const block = document.createElement('div');
      block.className = 'file-block';

      // Create thumbnail/icon
      let thumb = createAssetThumbnail(asset);
      block.appendChild(thumb);

      // Create file info container
      const fileInfo = document.createElement('div');
      fileInfo.className = 'file-info';

      const label = document.createElement('div');
      label.className = 'file-label';
      label.textContent = asset.name;
      
      // Add legacy indicator for assets using old path structure
      if (asset.pathType === 'legacy') {
        const legacyBadge = document.createElement('span');
        legacyBadge.style.cssText = 'background: #ff9800; color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 12px; margin-left: 8px; font-weight: bold;';
        legacyBadge.textContent = 'LEGACY';
        legacyBadge.title = 'This asset uses the old storage structure. Click the migrate button to move it to your secure personal folder.';
        label.appendChild(legacyBadge);
      }
      
      fileInfo.appendChild(label);

      // Add metadata for list view
      if (currentView === 'list') {
        const meta = document.createElement('div');
        meta.className = 'file-meta';
        const date = new Date(asset.created_at).toLocaleDateString();
        const size = formatFileSize(asset.size);
        const type = asset.type.charAt(0).toUpperCase() + asset.type.slice(1);
        meta.textContent = `${type} • ${date} • ${size}`;
        fileInfo.appendChild(meta);
      }

      block.appendChild(fileInfo);

      // Create actions
      const actions = createAssetActions(asset);
      block.appendChild(actions);

      return block;
    }

    // Group assets based on groupBy criteria
    function groupAssets(assets, groupBy) {
      const groups = {};
      
      assets.forEach(asset => {
        let groupKey;
        
        switch (groupBy) {
          case 'type':
            groupKey = asset.type.charAt(0).toUpperCase() + asset.type.slice(1).replace('_', ' ');
            break;
          case 'date':
            const date = new Date(asset.created_at);
            const today = new Date();
            const diffTime = Math.abs(today - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) groupKey = 'Today';
            else if (diffDays === 1) groupKey = 'Yesterday';
            else if (diffDays <= 7) groupKey = 'This Week';
            else if (diffDays <= 30) groupKey = 'This Month';
            else if (diffDays <= 90) groupKey = 'Last 3 Months';
            else groupKey = 'Older';
            break;
          case 'size':
            const size = asset.size;
            if (size < 1024) groupKey = 'Small (< 1 KB)';
            else if (size < 1024 * 1024) groupKey = 'Medium (< 1 MB)';
            else if (size < 1024 * 1024 * 10) groupKey = 'Large (< 10 MB)';
            else groupKey = 'Very Large (≥ 10 MB)';
            break;
          default:
            groupKey = 'Other';
        }
        
        if (!groups[groupKey]) {
          groups[groupKey] = [];
        }
        groups[groupKey].push(asset);
      });
      
      return groups;
    }

    // Create thumbnail for asset
    function createAssetThumbnail(asset) {
      let thumb = document.createElement('a');
      
      if (asset.source === 'storage') {
        thumb.href = asset.url;
        thumb.target = "_blank";
        
        if (asset.type === 'image') {
          const img = document.createElement('img');
          img.src = asset.url;
          img.alt = asset.name;
          thumb.appendChild(img);
        } else {
          const icon = createFileIcon(asset.type);
          thumb.appendChild(icon);
        }
      } else {
        // Database asset (SMS message, etc.)
        thumb.href = '#';
        thumb.onclick = (e) => {
          e.preventDefault();
          viewDatabaseAsset(asset);
        };
        
        const icon = createFileIcon(asset.type);
        thumb.appendChild(icon);
      }
      
      return thumb;
    }

    // Create file icon based on type
    function createFileIcon(type) {
      const icon = document.createElement('div');
      icon.className = 'file-icon';
      icon.style.width = currentView === 'list' ? '40px' : '80px';
      icon.style.height = currentView === 'list' ? '40px' : '80px';
      icon.style.display = 'flex';
      icon.style.alignItems = 'center';
      icon.style.justifyContent = 'center';
      icon.style.background = '#eee';
      icon.style.fontSize = currentView === 'list' ? '1.5em' : '2.5em';
      
      const icons = {
        'sms_message': '💬',
        'image': '🖼️',
        'video': '🎥',
        'audio': '🎵',
        'document': '📄',
        'other': '📄'
      };
      
      icon.textContent = icons[type] || '📄';
      return icon;
    }

    // Create action buttons for asset
    function createAssetActions(asset) {
      const actions = document.createElement('div');
      actions.className = 'file-actions';

      if (asset.source === 'storage') {
        // Storage file actions
        const viewBtn = createActionButton('👁️', 'View', () => window.open(asset.url, '_blank'));
        const urlBtn = createUrlButton(asset.url);
        const downloadBtn = createDownloadButton(asset.file.name, asset.pathType);
        const deleteBtn = createDeleteButton(asset.file.name, asset.pathType);

        actions.appendChild(viewBtn);
        actions.appendChild(urlBtn);
        actions.appendChild(downloadBtn);
        actions.appendChild(deleteBtn);

        // Add migration button for legacy assets
        if (asset.pathType === 'legacy') {
          const migrateBtn = createActionButton('🔄', 'Migrate to Secure Path', () => migrateAsset(asset.file.name));
          migrateBtn.style.background = '#ff9800';
          migrateBtn.style.color = 'white';
          actions.appendChild(migrateBtn);
        }
      } else {
        // Database asset actions
        const viewBtn = createActionButton('👁️', 'View', () => viewDatabaseAsset(asset));
        const editBtn = createActionButton('✏️', 'Edit', () => editDatabaseAsset(asset));
        const deleteBtn = createActionButton('🗑️', 'Delete', () => deleteDatabaseAsset(asset));

        actions.appendChild(viewBtn);
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
      }

      return actions;
    }

    // Helper function to create action buttons
    function createActionButton(icon, title, onclick) {
      const btn = document.createElement('button');
      btn.className = 'file-btn';
      btn.title = title;
      btn.innerHTML = icon;
      btn.onclick = onclick;
      return btn;
    }

    // Create URL copy button
    function createUrlButton(url) {
      const urlBtn = document.createElement('button');
      urlBtn.className = 'url-icon-btn';
      urlBtn.title = 'Copy URL';
      urlBtn.innerHTML = 'URL';
      urlBtn.onclick = () => copyUrlToClipboard(url, urlBtn);
      return urlBtn;
    }

    // Create download button
    function createDownloadButton(fileName, pathType = 'new') {
      const downloadBtn = document.createElement('button');
      downloadBtn.className = 'download-btn';
      downloadBtn.title = 'Download';
      downloadBtn.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M12 4v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 14l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M5 20h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      `;
      downloadBtn.onclick = () => downloadFile(fileName, pathType);
      return downloadBtn;
    }

    // Create delete button
    function createDeleteButton(fileName, pathType = 'new') {
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn';
      deleteBtn.title = 'Delete';
      deleteBtn.innerHTML = '🗑️';
      deleteBtn.style.fontSize = '14px'; // Reduced from default
      deleteBtn.onclick = () => deleteFile(fileName, pathType);
      return deleteBtn;
    }

    // Download a file from Supabase Storage
    async function downloadFile(fileName, pathType = 'new') {
      // Get current user (with impersonation support)
      const user = await getAuthenticatedUser();
      if (!user) {
        alert('You must be logged in to download files.');
        return;
      }
      
      // Determine the correct file path based on path type
      const filePath = pathType === 'legacy' ? fileName : `${user.id}/${fileName}`;
      
      const { data, error } = await supabase.storage.from(BUCKET).download(filePath);
      if (error) {
        alert('Download failed: ' + error.message);
        return;
      }
      const url = window.URL.createObjectURL(data);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName.replace(/^[^_]+_[^_]+_/, '');
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        window.URL.revokeObjectURL(url);
        a.remove();
      }, 100);
    }

    // Delete a file from Supabase Storage
    async function deleteFile(fileName, pathType = 'new') {
      if (!confirm('Are you sure you want to delete this file?')) return;
      
      // Get current user (with impersonation support)
      const user = await getAuthenticatedUser();
      if (!user) {
        alert('You must be logged in to delete files.');
        return;
      }
      
      // Determine the correct file path based on path type
      const filePath = pathType === 'legacy' ? fileName : `${user.id}/${fileName}`;
      
      const { error } = await supabase.storage.from(BUCKET).remove([filePath]);
      if (error) {
        alert('Delete failed: ' + error.message);
        return;
      }
      loadAssets();
    }

    // Copy URL to clipboard and show tooltip
    function copyUrlToClipboard(url, btn) {
      navigator.clipboard.writeText(url).then(() => {
        let tooltip = document.createElement('div');
        tooltip.className = 'copied-tooltip';
        tooltip.textContent = 'Copied!';
        btn.parentElement.appendChild(tooltip);
        setTimeout(() => {
          tooltip.remove();
        }, 1200);
      });
    }

    // View database asset (SMS message, etc.)
    function viewDatabaseAsset(asset) {
      if (asset.type === 'sms_message') {
        const content = asset.content;
        alert(`SMS Message: "${asset.name}"
Message: ${content.message || 'No message content'}
Tags: ${(asset.tags || []).join(', ') || 'None'}
Created: ${new Date(asset.created_at).toLocaleString()}`);
      }
    }

    // Edit database asset
    function editDatabaseAsset(asset) {
      if (asset.type === 'sms_message') {
        const params = new URLSearchParams({
          message: asset.content.message,
          name: asset.name
        });
        window.location.href = `sms_editor.html?${params.toString()}`;
      } else {
        alert('Editing this asset type is not yet supported.');
      }
    }

    // Delete database asset
    async function deleteDatabaseAsset(asset) {
      if (!confirm(`Are you sure you want to delete "${asset.name}"?`)) return;
      
      try {
        const { error } = await supabase
          .from('assets')
          .delete()
          .eq('id', asset.id);
          
        if (error) {
          alert('Delete failed: ' + error.message);
          return;
        }
        
        loadAssets();
      } catch (error) {
        console.error('Error deleting asset:', error);
        alert('Delete failed: ' + error.message);
      }
    }

    // Migrate legacy asset to user-based path structure
    async function migrateAsset(fileName) {
      if (!confirm(`Migrate "${fileName}" to secure user-based path? This will move it from the root to your personal folder.`)) return;
      
      try {
        // Get current user (respecting impersonation)
        const user = await getAuthenticatedUser();
        if (!user) {
          alert('You must be logged in to migrate files.');
          return;
        }
        
        // Download the file from legacy path
        const { data: fileData, error: downloadError } = await supabase.storage
          .from(BUCKET)
          .download(fileName);
        
        if (downloadError) {
          throw new Error(`Failed to download file: ${downloadError.message}`);
        }
        
        // Upload to new user-based path
        const newFilePath = `${user.id}/${fileName}`;
        const { error: uploadError } = await supabase.storage
          .from(BUCKET)
          .upload(newFilePath, fileData, { upsert: false });
        
        if (uploadError) {
          throw new Error(`Failed to upload to new path: ${uploadError.message}`);
        }
        
        // Delete from legacy path
        const { error: deleteError } = await supabase.storage
          .from(BUCKET)
          .remove([fileName]);
        
        if (deleteError) {
          console.warn('Warning: Could not delete legacy file:', deleteError.message);
          alert(`Migration successful! However, the old file could not be automatically deleted. You may need to clean it up manually.`);
        } else {
          alert('Migration successful! Your file is now in your secure personal folder.');
        }
        
        // Refresh the asset list
        loadAssets();
        
      } catch (error) {
        console.error('Migration error:', error);
        alert(`Migration failed: ${error.message}`);
      }
    }

    // Migrate all legacy assets for current user
    async function migrateAllLegacyAssets() {
      const legacyAssets = allAssets.filter(asset => asset.pathType === 'legacy');
      
      if (legacyAssets.length === 0) {
        alert('No legacy assets to migrate.');
        return;
      }
      
      if (!confirm(`Migrate all ${legacyAssets.length} legacy assets to secure paths? This process may take a moment.`)) return;
      
      let successCount = 0;
      let errorCount = 0;
      
      for (const asset of legacyAssets) {
        try {
          await migrateAsset(asset.file.name);
          successCount++;
        } catch (error) {
          console.error(`Failed to migrate ${asset.file.name}:`, error);
          errorCount++;
        }
      }
      
      alert(`Migration complete! ${successCount} assets migrated successfully. ${errorCount} errors.`);
      loadAssets();
    }

    // Dismiss migration alert
    function dismissMigrationAlert() {
      document.getElementById('migrationAlert').style.display = 'none';
      sessionStorage.setItem('migrationAlertDismissed', 'true');
    }

    // Drag & drop and upload logic
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const browseBtn = document.getElementById('browseBtn');

    browseBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      fileInput.click();
    });

    dropArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropArea.classList.add('dragover');
    });

    dropArea.addEventListener('dragleave', () => {
      dropArea.classList.remove('dragover');
    });

    dropArea.addEventListener('drop', (e) => {
      e.preventDefault();
      dropArea.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        updateDropAreaText();
      }
    });

    dropArea.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', updateDropAreaText);

    function updateDropAreaText() {
      if (fileInput.files.length === 1) {
        dropArea.textContent = "Selected: " + fileInput.files[0].name;
      } else if (fileInput.files.length > 1) {
        dropArea.textContent = "Selected: " + fileInput.files.length + " files";
      } else {
        dropArea.innerHTML = 'Drag &amp; drop files here, <button type="button" id="browseBtn" class="browse-btn">Browse</button>';
        document.getElementById('browseBtn').addEventListener('click', function(e) {
          e.stopPropagation();
          fileInput.click();
        });
      }
    }

    // Upload form submission
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!fileInput.files.length) {
        alert('Please select file(s) to upload.');
        return;
      }
      dropArea.textContent = "Uploading...";
      const user = await getAuthenticatedUser();
      if (!user) {
        alert('You must be logged in to upload files.');
        return;
      }
      
      for (const file of fileInput.files) {
        // Include user ID in the path for proper RLS access control
        const filePath = `${user.id}/${Date.now()}_${Math.random().toString(36).slice(2)}_${file.name}`;
        const { error } = await supabase.storage.from(BUCKET).upload(filePath, file, { upsert: false });
        if (error) {
          alert('Upload failed for ' + file.name + ': ' + error.message);
        }
      }
      fileInput.value = "";
      updateDropAreaText();
      loadAssets();
    });

    // Event listeners for sort controls
    document.addEventListener('DOMContentLoaded', async function() {
      // Check authentication first - redirect to login if not authenticated
      const isAuthenticated = await checkAuthentication();
      if (!isAuthenticated) {
        return; // Stop execution if not authenticated
      }
      
      // Refresh the global navigation with the authenticated user's display name
      if (typeof window.refreshGlobalNav === 'function') {
        console.log('[ASSETS] Refreshing global navigation');
        try {
          await window.refreshGlobalNav();
        } catch (error) {
          console.error('[ASSETS] Error refreshing navigation:', error);
        }
      } else {
        console.log('[ASSETS] refreshGlobalNav function not available yet, navigation may load automatically');
      }
      
      // Listen for authentication state changes
      supabase.auth.onAuthStateChange((event, session) => {
        console.log('[AUTH] Auth state changed:', event, session);
        if (event === 'SIGNED_OUT' || !session) {
          console.log('[AUTH] User signed out or session expired, redirecting to login');
          window.location.href = 'login.html';
        }
      });
      
      // Load user settings on page load
      loadUserSettings();
      
      // Load saved avatar
      loadSavedAvatar();
      
      // Profile picture functionality
      const profilePictureInput = document.getElementById('profilePictureInput');
      const profilePicturePreview = document.getElementById('profilePicturePreview');
      const uploadProfileBtn = document.getElementById('uploadProfileBtn');
      const removeProfileBtn = document.getElementById('removeProfileBtn');
      
      uploadProfileBtn.addEventListener('click', () => {
        profilePictureInput.click();
      });
      
      profilePictureInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
          // Show loading state
          profilePicturePreview.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;"><span>Uploading...</span></div>';
          
          try {
            // Upload to Supabase Storage
            const avatarUrl = await uploadAvatarImage(file);
            if (avatarUrl) {
              // Display the uploaded image
              profilePicturePreview.innerHTML = `<img src="${avatarUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
              removeProfileBtn.style.display = 'block';
              
              // Save the avatar URL to user settings
              await saveAvatarUrl(avatarUrl);
              
              // Show success message
              const statusEl = document.getElementById('saveStatus');
              statusEl.textContent = 'Avatar uploaded and saved successfully!';
              statusEl.style.opacity = '1';
              setTimeout(() => {
                statusEl.style.opacity = '0';
              }, 3000);
            }
          } catch (error) {
            console.error('Error uploading avatar:', error);
            profilePicturePreview.innerHTML = '<span style="color: #dc3545; font-size: 0.8em; text-align: center;">Upload Failed</span>';
            
            // Show error message
            const statusEl = document.getElementById('saveStatus');
            statusEl.textContent = 'Error uploading avatar. Please try again.';
            statusEl.style.color = '#dc3545';
            statusEl.style.opacity = '1';
            setTimeout(() => {
              statusEl.style.opacity = '0';
              statusEl.style.color = '#28a745';
            }, 5000);
          }
        }
      });
      
      removeProfileBtn.addEventListener('click', async function() {
        try {
          // Show loading state
          const profilePicturePreview = document.getElementById('profilePicturePreview');
          profilePicturePreview.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;"><span>Removing...</span></div>';
          
          // Remove avatar from storage and settings
          await removeAvatar();
          
          // Reset the preview
          profilePicturePreview.innerHTML = '<span style="color: #666; font-size: 0.8em; text-align: center;">No Image</span>';
          profilePictureInput.value = '';
          removeProfileBtn.style.display = 'none';
          
          // Show success message
          const statusEl = document.getElementById('saveStatus');
          statusEl.textContent = 'Avatar removed successfully!';
          statusEl.style.opacity = '1';
          setTimeout(() => {
            statusEl.style.opacity = '0';
          }, 3000);
          
        } catch (error) {
          console.error('Error removing avatar:', error);
          
          // Show error message
          const statusEl = document.getElementById('saveStatus');
          statusEl.textContent = 'Error removing avatar. Please try again.';
          statusEl.style.color = '#dc3545';
          statusEl.style.opacity = '1';
          setTimeout(() => {
            statusEl.style.opacity = '0';
            statusEl.style.color = '#28a745';
          }, 5000);
        }
      });
      
      // Bio character counter
      const bioTextarea = document.getElementById('bio');
      const bioCharCount = document.getElementById('bioCharCount');
      
      bioTextarea.addEventListener('input', function() {
        const length = this.value.length;
        const maxLength = 500;
        bioCharCount.textContent = `${length} / ${maxLength} characters`;
        
        if (length > maxLength) {
          bioCharCount.style.color = '#dc3545';
          this.value = this.value.substring(0, maxLength);
          bioCharCount.textContent = `${maxLength} / ${maxLength} characters`;
        } else if (length > maxLength * 0.9) {
          bioCharCount.style.color = '#ff9800';
        } else {
          bioCharCount.style.color = '#666';
        }
      });
      
      // Settings form submission
      document.getElementById('settingsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
          prefix: document.getElementById('prefix').value.trim(),
          firstName: document.getElementById('firstName').value.trim(),
          middleInitial: document.getElementById('middleInitial').value.trim(),
          lastName: document.getElementById('lastName').value.trim(),
          suffix: document.getElementById('suffix').value.trim(),
          email: document.getElementById('email').value.trim(),
          phone: document.getElementById('phone').value.trim(),
          sparkyPhone: document.getElementById('sparkyPhone').value.trim(),
          support: document.getElementById('support').value.trim(),
          sparkyUsername: document.getElementById('sparkyUsername').value.trim(),
          city: document.getElementById('city').value.trim(),
          state: document.getElementById('state').value.trim(),
          country: document.getElementById('country').value.trim(),
          website: document.getElementById('website').value.trim(),
          hotLink: document.getElementById('hotLink').value.trim(),
          bio: document.getElementById('bio').value.trim()
        };
        
        console.log('Form data being saved:', formData);
        saveUserSettings(formData);
      });
      
      // Sort and filter controls
      document.getElementById('sortBy').addEventListener('change', renderAssets);
      document.getElementById('filterType').addEventListener('change', renderAssets);
      document.getElementById('dateFilter').addEventListener('change', renderAssets);
      document.getElementById('groupBy').addEventListener('change', renderAssets);
      
      // Search functionality
      document.getElementById('searchAssets').addEventListener('input', renderAssets);
      document.getElementById('clearSearch').addEventListener('click', function() {
        document.getElementById('searchAssets').value = '';
        document.getElementById('searchAssets').focus();
        renderAssets();
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
          e.preventDefault();
          document.getElementById('searchAssets').focus();
        }
        
        if (e.key === 'Escape' && document.activeElement === document.getElementById('searchAssets')) {
          document.getElementById('searchAssets').value = '';
          renderAssets();
        }
      });
      
      // View toggle buttons
      document.getElementById('gridView').addEventListener('click', function() {
        currentView = 'grid';
        this.classList.add('active');
        document.getElementById('listView').classList.remove('active');
        renderAssets();
      });
      
      document.getElementById('listView').addEventListener('click', function() {
        currentView = 'list';
        this.classList.add('active');
        document.getElementById('gridView').classList.remove('active');
        renderAssets();
      });

      // Change Password functionality
      const changePasswordBtn = document.getElementById('changePasswordBtn');
      changePasswordBtn.addEventListener('click', async function() {
        try {
          // Create a modal dialog for password change
          const modal = document.createElement('div');
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
          `;
          
          const modalContent = document.createElement('div');
          modalContent.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
          `;
          
          modalContent.innerHTML = `
            <h3 style="margin: 0 0 20px 0; color: #333; text-align: center;">Change Password</h3>
            <div style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 6px; color: #333; font-weight: 500;">New Password:</label>
              <div style="position: relative;">
                <input type="password" id="newPassword" style="width: 100%; padding: 10px 40px 10px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;" placeholder="Enter new password" minlength="6">
                <button type="button" id="toggleNewPassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #666; font-size: 14px;">👁️</button>
              </div>
            </div>
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 6px; color: #333; font-weight: 500;">Confirm Password:</label>
              <div style="position: relative;">
                <input type="password" id="confirmPassword" style="width: 100%; padding: 10px 40px 10px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;" placeholder="Confirm new password" minlength="6">
                <button type="button" id="toggleConfirmPassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #666; font-size: 14px;">👁️</button>
              </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button type="button" id="cancelPasswordChange" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Cancel</button>
              <button type="button" id="confirmPasswordChange" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Change Password</button>
            </div>
            <div id="passwordChangeStatus" style="margin-top: 10px; text-align: center; font-size: 14px; opacity: 0; transition: opacity 0.3s;"></div>
          `;
          
          modal.appendChild(modalContent);
          document.body.appendChild(modal);
          
          // Focus on first input
          setTimeout(() => document.getElementById('newPassword').focus(), 100);
          
          // Handle show/hide password toggles
          document.getElementById('toggleNewPassword').onclick = () => {
            const input = document.getElementById('newPassword');
            const button = document.getElementById('toggleNewPassword');
            if (input.type === 'password') {
              input.type = 'text';
              button.textContent = '🙈';
            } else {
              input.type = 'password';
              button.textContent = '👁️';
            }
          };
          
          document.getElementById('toggleConfirmPassword').onclick = () => {
            const input = document.getElementById('confirmPassword');
            const button = document.getElementById('toggleConfirmPassword');
            if (input.type === 'password') {
              input.type = 'text';
              button.textContent = '🙈';
            } else {
              input.type = 'password';
              button.textContent = '👁️';
            }
          };
          
          // Handle cancel
          document.getElementById('cancelPasswordChange').onclick = () => {
            document.body.removeChild(modal);
          };
          
          // Handle password change
          document.getElementById('confirmPasswordChange').onclick = async () => {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const statusEl = document.getElementById('passwordChangeStatus');
            
            if (!newPassword || newPassword.length < 6) {
              statusEl.textContent = 'Password must be at least 6 characters';
              statusEl.style.color = '#dc3545';
              statusEl.style.opacity = '1';
              return;
            }
            
            if (newPassword !== confirmPassword) {
              statusEl.textContent = 'Passwords do not match';
              statusEl.style.color = '#dc3545';
              statusEl.style.opacity = '1';
              return;
            }
            
            try {
              statusEl.textContent = 'Changing password...';
              statusEl.style.color = '#666';
              statusEl.style.opacity = '1';
              
              // Check if user is in impersonation mode
              const impersonationData = localStorage.getItem('impersonationData');
              if (impersonationData) {
                throw new Error('Cannot change password while impersonating another user. Please exit impersonation first.');
              }
              
              // Use the same supabase client as the rest of the page
              if (!supabase) {
                throw new Error('Supabase client not available');
              }
              
              // Check if user is authenticated
              const { data: { session }, error: sessionError } = await supabase.auth.getSession();
              if (sessionError || !session) {
                throw new Error('You must be logged in to change your password');
              }
              
              // Update password using Supabase auth
              const { data, error } = await supabase.auth.updateUser({
                password: newPassword
              });
              
              if (error) {
                throw error;
              }
              
              statusEl.textContent = 'Password changed successfully!';
              statusEl.style.color = '#28a745';
              statusEl.style.opacity = '1';
              
              setTimeout(() => {
                document.body.removeChild(modal);
                
                // Show main page success message
                const mainStatusEl = document.getElementById('saveStatus');
                if (mainStatusEl) {
                  mainStatusEl.textContent = 'Password changed successfully!';
                  mainStatusEl.style.opacity = '1';
                  setTimeout(() => {
                    mainStatusEl.style.opacity = '0';
                  }, 3000);
                }
              }, 1500);
              
            } catch (error) {
              console.error('Error changing password:', error);
              let errorMessage = 'Please try again';
              
              // Handle specific error types
              if (error.message?.includes('Invalid API key')) {
                errorMessage = 'Authentication error. Please log out and log back in.';
              } else if (error.message?.includes('not authenticated')) {
                errorMessage = 'Please log out and log back in to change your password.';
              } else if (error.message?.includes('impersonating')) {
                errorMessage = error.message;
              } else if (error.message) {
                errorMessage = error.message;
              }
              
              statusEl.textContent = 'Error: ' + errorMessage;
              statusEl.style.color = '#dc3545';
              statusEl.style.opacity = '1';
            }
          };
          
          // Close modal on outside click
          modal.onclick = (e) => {
            if (e.target === modal) {
              document.body.removeChild(modal);
            }
          };
          
          // Handle Enter key
          const inputs = modal.querySelectorAll('input');
          inputs.forEach(input => {
            input.addEventListener('keypress', (e) => {
              if (e.key === 'Enter') {
                document.getElementById('confirmPasswordChange').click();
              }
            });
          });
          
        } catch (error) {
          console.error('Error opening password change dialog:', error);
          alert('Error opening password change dialog. Please try again.');
        }
      });

      // Initial load
      loadAssets();
    });

    // Debug function to help troubleshoot asset loading issues
    async function debugAssetLoading() {
      console.log('=== ASSET LOADING DEBUG ===');
      
      try {
        // Check auth status (respecting impersonation)
        const user = await getAuthenticatedUser();
        console.log('User:', user ? `${user.email} (${user.id})` : 'Not logged in');
        
        if (!user) return;
        
        // Check bucket access
        const { data: buckets, error: bucketsError } = await supabase.storage.listBuckets();
        console.log('Available buckets:', buckets?.map(b => b.id) || []);
        if (bucketsError) console.log('Buckets error:', bucketsError);
        
        // Check user folder
        const { data: userFiles, error: userError2 } = await supabase.storage
          .from(BUCKET)
          .list(user.id);
        console.log(`Files in user folder (${user.id}):`, userFiles?.length || 0);
        if (userError2) console.log('User folder error:', userError2);
        
        // Check root folder
        const { data: rootFiles, error: rootError } = await supabase.storage
          .from(BUCKET)
          .list('');
        console.log('Files in root folder:', rootFiles?.length || 0);
        if (rootError) console.log('Root folder error:', rootError);
        
        // Check allAssets array
        console.log('Total assets loaded:', allAssets.length);
        console.log('Asset breakdown:', {
          new: allAssets.filter(a => a.pathType === 'new').length,
          legacy: allAssets.filter(a => a.pathType === 'legacy').length,
          database: allAssets.filter(a => a.source === 'database').length
        });
        
      } catch (error) {
        console.error('Debug error:', error);
      }
      
      console.log('=== END DEBUG ===');
    }
  </script>
</body>
</html>
