<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Contacts - New Version</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="static/supersparky.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <script src="static/global-nav-v2.js"></script>
  <style>
    body { 
      margin: 0; 
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
    }
    
    /* Reset any margins from global navigation */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body * {
      margin: revert;
      padding: revert;
    }
    
    /* Force tight positioning against global nav */
    #global-nav, .global-nav, [id*="nav"], [class*="nav"] {
      margin-bottom: 0 !important;
      padding-bottom: 0 !important;
    }
    
    /* Ensure body content starts immediately after nav */
    body > div:first-child,
    body > header:first-child,
    body > nav:first-child {
      margin-bottom: 0 !important;
      padding-bottom: 0 !important;
    }
    
    .controls {
      background: white;
      padding: 5px 20px;
      margin: -10px 20px 5px 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: space-between;
      position: sticky;
      top: 60px;
      z-index: 2000;
    }
    
    .search-group {
      display: flex;
      gap: 10px;
      align-items: center;
      flex: 0.33;
      min-width: 100px;
      position: relative;
    }
    
    .search-input {
      flex: 1;
      padding: 2px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .search-input:focus {
      border-color: #667eea;
    }
    
    /* Search suggestions dropdown */
    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 1000;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    
    .suggestion-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #f8f9fa;
    }
    
    .suggestion-item:hover,
    .suggestion-item.active {
      background: #f8f9fa;
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .btn {
      padding: 2px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .btn-primary { 
      background: linear-gradient(to bottom, #4dabf7, #007bff); 
      color: white; 
    }
    .btn-success { 
      background: linear-gradient(to bottom, #51cf66, #28a745); 
      color: white; 
    }
    .btn-warning { 
      background: linear-gradient(to bottom, #ffd43b, #ffc107); 
      color: #212529; 
    }
    .btn-danger { 
      background: linear-gradient(to bottom, #ff6b6b, #dc3545); 
      color: white; 
    }
    .btn-info { 
      background: linear-gradient(to bottom, #22d3ee, #17a2b8); 
      color: white; 
    }
    .btn-secondary { 
      background: linear-gradient(to bottom, #adb5bd, #6c757d); 
      color: white; 
    }
    
    .table-container {
      margin: 0 20px;
      background: white;
      border-radius: 0px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      overflow: auto;
      position: sticky;
      top: 120px;
      height: calc(100vh - 160px);
      z-index: 1000;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    .table th,
    .table td {
      padding: 0 12px;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
    }
    
    .table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #495057;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    /* Sticky columns 1-5 with proper sizing */
    .table th:nth-child(1),
    .table td:nth-child(1) {
      background: #e3f2fd;
      padding: 0 !important;
      width: 20px;
      min-width: 20px;
      max-width: 20px;
      text-align: center;
      position: sticky;
      left: 0;
      z-index: 10;
    }
    
    .table th:nth-child(2),
    .table td:nth-child(2) {
      background: #c0c0c0;
      padding: 0 1px 0 2px !important;
      width: auto;
      min-width: fit-content;
      text-align: center !important;
      position: sticky;
      left: 20px;
      z-index: 9;
    }
    
    .table th:nth-child(3),
    .table td:nth-child(3) {
      background: #e8e8e8;
      padding: 0 1px 0 1px !important;
      width: 25px;
      min-width: 25px;
      max-width: 25px;
      text-align: center !important;
      position: sticky;
      left: 48px;
      z-index: 8;
    }
    
    .table th:nth-child(4),
    .table td:nth-child(4) {
      background: #d3d3d3;
      padding: 0 1px 0 1px !important;
      width: auto;
      min-width: fit-content;
      text-align: center !important;
      position: sticky;
      left: 73px;
      z-index: 7;
    }
    
    /* Red text for data cells only in columns 2, 3, 4 */
    .table td:nth-child(2),
    .table td:nth-child(3),
    .table td:nth-child(4) {
      color: #ff0000 !important;
    }
    
    .table th:nth-child(5),
    .table td:nth-child(5) {
      background: #fff3e0;
      padding: 0 !important;
      width: 30px;
      min-width: 30px;
      max-width: 30px;
      position: sticky;
      left: 107px;
      z-index: 6;
    }
    
    .table th:nth-child(6),
    .table td:nth-child(6) {
      background: #e8f5e8;
      padding: 0 !important;
      width: 50px;
      min-width: 50px;
      max-width: 50px;
      position: sticky;
      left: 137px;
      z-index: 5;
    }
    
    /* Ensure sticky headers appear above data cells and are sticky vertically */
    .table thead th {
      position: sticky;
      top: 0;
      z-index: 20;
    }
    
    .table thead th:nth-child(1) { 
      position: sticky;
      top: 0;
      left: 0;
      z-index: 30; 
    }
    .table thead th:nth-child(2) { 
      position: sticky;
      top: 0;
      left: 20px;
      z-index: 29; 
    }
    .table thead th:nth-child(3) { 
      position: sticky;
      top: 0;
      left: 48px;
      z-index: 28; 
    }
    .table thead th:nth-child(4) { 
      position: sticky;
      top: 0;
      left: 73px;
      z-index: 27; 
    }
    .table thead th:nth-child(5) { 
      position: sticky;
      top: 0;
      left: 107px;
      z-index: 26; 
    }
    .table thead th:nth-child(6) { 
      position: sticky;
      top: 0;
      left: 137px;
      z-index: 25; 
    }
    
    .table tbody tr:hover {
      background-color: #f1f3f4;
    }
    
    .table tbody tr.selected {
      background-color: #e3f2fd !important;
    }
    
    .table tbody tr.selected:hover {
      background-color: #bbdefb !important;
    }
    
    .checkbox {
      margin: 0;
      cursor: pointer;
    }
    
    /* Editable table styles */
    .editable-cell {
      position: relative;
      cursor: pointer;
    }
    
    .editable-cell:hover {
      background-color: #e8f4fd !important;
      outline: 1px solid #007bff;
    }
    
    .editable-cell.editing {
      padding: 0 !important;
      background-color: #fff !important;
      outline: 2px solid #007bff;
    }
    
    .cell-input {
      width: 100%;
      height: 100%;
      border: none;
      padding: 4px 6px;
      font-size: 12px;
      font-family: inherit;
      background: white;
      outline: none;
      min-height: 28px;
      box-sizing: border-box;
    }
    
    .cell-input:focus {
      outline: none;
    }
    
    .edit-indicator {
      display: none;
    }
    
    .readonly-cell {
      background-color: #f8f9fa !important;
      cursor: text;
      user-select: text;
    }
    
    .readonly-cell:hover {
      background-color: #e9ecef !important;
      outline: 1px solid #6c757d !important;
    }
    
    .readonly-cell .cell-content {
      user-select: text;
      cursor: text;
    }
    
    /* Tooltip styles for cell hover */
    .cell-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-family: inherit;
      white-space: nowrap;
      z-index: 10000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      max-width: 300px;
      word-break: break-all;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .cell-tooltip.show {
      opacity: 1;
    }
    
    .cell-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
    }
    
    /* Save indicator */
    .saving-cell {
      background-color: #fff3cd !important;
      animation: pulse 1s infinite;
    }
    
    .saved-cell {
      background-color: #d4edda !important;
      transition: background-color 0.3s ease;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    .red-header {
      background: #ffebee !important;
      color: #c62828 !important;
    }
    
    .grey-header {
      background: #ff0000 !important;
      color: #ffffff !important;
      font-weight: bold !important;
    }
    
    /* Blue gradient for table headers starting from column 7 */
    .table th:nth-child(n+7) {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      color: white !important;
      font-weight: bold !important;
    }
    
    /* Blue gradient background for columns 7 and up */
    .table th:nth-child(n+7) {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      color: white !important;
      font-weight: bold !important;
    }
    
    /* Resizable column styles */
    .table th:nth-child(n+6) {
      position: relative;
      min-width: 50px;
    }
    
    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      cursor: col-resize;
      background: rgba(0,0,0,0.1);
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 100;
    }
    
    .table th:nth-child(n+6):hover .resize-handle {
      opacity: 1;
    }
    
    .resize-handle:hover {
      background: rgba(0,0,0,0.3);
      opacity: 1 !important;
    }
    
    .resize-handle.resizing {
      background: #007bff;
      opacity: 1 !important;
    }
    
    .table th.resizing {
      user-select: none;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0;
      background: white;
      margin: 0px 20px 0 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      font-size: 12px;
    }
    
    .pagination {
      display: flex;
      gap: 5px;
      align-items: center;
      font-size: 12px;
    }
    
    .pagination button {
      padding: 0;
      border: 1px solid #dee2e6;
      background: white;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
      font-size: 12px;
    }
    
    .pagination button:hover:not(:disabled) {
      background: #e9ecef;
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination button.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
    
    .page-size-selector {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 12px;
    }
    
    .page-size-selector select {
      padding: 0;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      background: white;
      font-size: 12px;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 15% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .modal-header h3 {
      margin: 0;
      color: #495057;
    }
    
    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }
    
    .close:hover {
      color: #000;
    }
    
    .user-search {
      width: 100%;
      padding: 10px;
      border: 2px solid #e9ecef;
      border-radius: 5px;
      font-size: 16px;
      margin-bottom: 15px;
    }
    
    .user-search:focus {
      border-color: #007bff;
      outline: none;
    }
    
    .user-results {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e9ecef;
      border-radius: 5px;
      background: white;
    }
    
    .user-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #f8f9fa;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .user-item:hover {
      background: #f8f9fa;
    }
    
    .user-item:last-child {
      border-bottom: none;
    }
    
    .user-item.selected {
      background: #e3f2fd !important;
      border-left: 4px solid #007bff;
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #007bff;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }
    
    .user-info {
      flex: 1;
    }
    
    .user-name {
      font-weight: 600;
      color: #495057;
    }
    
    .user-email {
      font-size: 12px;
      color: #6c757d;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #e9ecef;
    }
  </style>
</head>

<body>
  <!-- Controls -->
  <div class="controls">
    <div style="display: flex; gap: 15px; align-items: center;">
      <button id="delete-btn" class="btn btn-danger">Delete</button>
      
      <div class="search-group">
        <input id="search-input" type="text" class="search-input" placeholder="Search contacts..." autocomplete="off" />
        <div id="search-suggestions" class="search-suggestions"></div>
        <button id="search-btn" class="btn btn-primary">Search</button>
        <button id="reset-btn" class="btn btn-secondary">Reset</button>
      </div>
    </div>
    
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <button id="assign-btn" class="btn btn-success">Assign</button>
      <button id="sms-btn" class="btn btn-success">SMS</button>
      <button id="email-btn" class="btn btn-info">Email</button>
      <button id="rvm-btn" class="btn btn-warning">RVM</button>
      <button id="campaign-btn" class="btn btn-primary">Campaign</button>
      <button id="add-btn" class="btn btn-success">Add</button>
      <button id="import-btn" class="btn btn-info">Import</button>
      <button id="export-btn" class="btn btn-warning">Export</button>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Loading contacts...</p>
  </div>

  <!-- Pagination -->
  <div class="pagination-container">
    <div class="dnd-indicator" style="color: #dc3545; font-weight: bold; font-size: 12px;">
      Do Not Disturb = X
    </div>
    
    <div id="select-all-toggle" style="display: none; color: #0056b3; font-weight: bold; font-size: 12px;">
      <a href="#" id="select-all-link" style="color: #0056b3; text-decoration: none; cursor: pointer;">
        <span id="selected-count">0</span> selected - Select all <span id="total-contacts-count">0</span> contacts
      </a>
    </div>
    
    <div class="contact-info" style="color: #495057; font-weight: bold; font-size: 12px;">
      <span id="contact-count-display">Loading...</span>
    </div>
    
    <div class="page-size-selector">
      <label>Show:</label>
      <select id="page-size-select">
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="all">All</option>
      </select>
      <span>entries</span>
    </div>
    
    <div class="pagination" id="pagination">
      <!-- Pagination buttons will be inserted here -->
    </div>
  </div>

  <!-- Table -->
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>
            <input type="checkbox" id="header-checkbox" class="checkbox">
          </th>
          <th class="grey-header">SMS</th>
          <th class="grey-header">Call</th>
          <th class="grey-header">Email</th>
          <th>No.</th>
          <th>Contact ID<div class="resize-handle"></div></th>
          <th>Assignee<div class="resize-handle"></div></th>
          <th>Sponsor<div class="resize-handle"></div></th>
          <th>Sponsor First<div class="resize-handle"></div></th>
          <th>Sponsor Last<div class="resize-handle"></div></th>
          <th>Sparky ID<div class="resize-handle"></div></th>
          <th>First Name<div class="resize-handle"></div></th>
          <th>Last Name<div class="resize-handle"></div></th>
          <th>Email<div class="resize-handle"></div></th>
          <th>Valid<div class="resize-handle"></div></th>
          <th>Phone<div class="resize-handle"></div></th>
          <th>Address<div class="resize-handle"></div></th>
          <th>City<div class="resize-handle"></div></th>
          <th>State<div class="resize-handle"></div></th>
          <th>Zip<div class="resize-handle"></div></th>
          <th>IP<div class="resize-handle"></div></th>
          <th>Date<div class="resize-handle"></div></th>
          <th>Timezone<div class="resize-handle"></div></th>
          <th>Cell<div class="resize-handle"></div></th>
          <th>Carrier<div class="resize-handle"></div></th>
          <th>Landline<div class="resize-handle"></div></th>
          <th>VoIP<div class="resize-handle"></div></th>
          <th>Other<div class="resize-handle"></div></th>
          <th>Foreign<div class="resize-handle"></div></th>
          <th>Country<div class="resize-handle"></div></th>
        </tr>
      </thead>
      <tbody id="contacts-tbody">
        <!-- Contacts will be populated here -->
      </tbody>
    </table>
  </div>

  <!-- User Assignment Modal -->
  <div id="user-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Assign Users</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <input type="text" id="user-search" class="user-search" placeholder="Search users..." autocomplete="off">
        <div id="user-results" class="user-results">
          <!-- User search results will appear here -->
        </div>
        <div id="selected-user" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
          <strong>Selected User:</strong> <span id="selected-user-name"></span>
        </div>
      </div>
      <div class="modal-actions">
        <button id="cancel-assign" class="btn btn-secondary">Cancel</button>
        <button id="unassign-selected" class="btn btn-warning">Unassign Selected</button>
        <button id="confirm-assign" class="btn btn-success" disabled>Assign Selected</button>
      </div>
    </div>
  </div>

  <!-- Add Contact Modal -->
  <div id="add-contact-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Add New Contact</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <form id="add-contact-form">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label>First Name *</label>
              <input type="text" name="first_name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label>Last Name *</label>
              <input type="text" name="last_name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label>Email *</label>
              <input type="email" name="email" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label>Phone</label>
              <input type="tel" name="phone" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label>City</label>
              <input type="text" name="city" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label>State</label>
              <input type="text" name="state" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-actions">
        <button id="cancel-add" class="btn btn-secondary">Cancel</button>
        <button id="confirm-add" class="btn btn-success">Add Contact</button>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="import-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Import Contacts</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 15px;">
          <label>Choose CSV file:</label>
          <input type="file" id="csv-file" accept=".csv" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 15px;">
          <button id="download-template" class="btn btn-info">Download Template</button>
        </div>
        <div id="import-preview" style="display: none;">
          <h4>Preview (first 5 rows):</h4>
          <div id="preview-table" style="max-height: 200px; overflow: auto; border: 1px solid #ddd; border-radius: 4px;"></div>
          <p><strong>Total rows:</strong> <span id="total-rows">0</span></p>
        </div>
      </div>
      <div class="modal-actions">
        <button id="cancel-import" class="btn btn-secondary">Cancel</button>
        <button id="confirm-import" class="btn btn-success" disabled>Import Contacts</button>
      </div>
    </div>
  </div>

  <!-- Message Composer Modal -->
  <div id="message-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="message-modal-title">Compose Message</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 15px;">
          <label>Recipients: <span id="recipient-count">0</span> contacts selected</label>
        </div>
        <div style="margin-bottom: 15px;">
          <label>Subject (for email):</label>
          <input type="text" id="message-subject" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="margin-bottom: 15px;">
          <label>Message:</label>
          <textarea id="message-content" rows="6" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Enter your message here..."></textarea>
        </div>
        <div style="margin-bottom: 15px;">
          <label>
            <input type="checkbox" id="message-preview"> Preview before sending
          </label>
        </div>
      </div>
      <div class="modal-actions">
        <button id="cancel-message" class="btn btn-secondary">Cancel</button>
        <button id="send-message" class="btn btn-success">Send Message</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Confirm Delete</h3>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong id="delete-count">0</strong> selected contact(s)?</p>
        <p style="color: #dc3545; font-size: 14px;">This action cannot be undone.</p>
      </div>
      <div class="modal-actions">
        <button id="cancel-delete" class="btn btn-secondary">Cancel</button>
        <button id="confirm-delete" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://yggfiuqxfxsoyesqgpyt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlnZ2ZpdXF4Znhzb3llc3FncHl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4MTQ0NjEsImV4cCI6MjA2NjM5MDQ2MX0.YD3fUy1m7lNWCMfUhd1DP7rlmq2tmlwAxg_yJxruB-Q';
    
    // Initialize Supabase client
    let supabase;
    try {
      if (typeof window.supabase !== 'undefined') {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase client initialized successfully');
        
        // Test the connection immediately
        supabase.from('contacts').select('count', { count: 'exact', head: true })
          .then(({ data, error }) => {
            if (error) {
              console.error('Supabase connection test failed:', error);
            } else {
              console.log('Supabase connection test passed');
            }
          })
          .catch(err => {
            console.error('Supabase connection error:', err);
          });
      } else {
        console.warn('Supabase library not loaded, using sample data');
        supabase = null;
      }
    } catch (error) {
      console.error('Failed to initialize Supabase client:', error);
      supabase = null;
    }

    // Global variables
    let allContacts = [];
    let filteredContacts = [];
    let selectedContactIds = new Set();
    let pageSize = 25;
    let currentPage = 1;
    let paginatedContacts = [];
    let selectedUser = null;
    let importData = [];
    let users = [];

    // Load users from Supabase profiles table
    async function loadUsers() {
      const timestamp = new Date().toISOString();
      console.log(`[${timestamp}] loadUsers() called - starting fresh user load attempt`);
      
      try {
        if (!supabase) {
          console.warn('Supabase not available');
          users = [];
          return;
        }

        console.log('Attempting to fetch users from profiles table...');

        // Try multiple approaches to get user data from Supabase
        let data = null;
        let error = null;
        
        // First attempt: Simple select from profiles
        try {
          console.log('About to execute profiles query with simple select...');
          const result1 = await supabase
            .from('profiles')
            .select('*');
          
          console.log('Profiles query executed, result:', result1);
          
          if (!result1.error && result1.data) {
            data = result1.data;
            console.log('Success with profiles table (simple select):', data.length + ' users found');
          } else {
            error = result1.error;
            console.log('Profiles table failed, error:', error);
          }
        } catch (e) {
          console.log('Profiles table exception:', e);
          error = e;
        }
        
        // Second attempt: Try auth.users if profiles fails
        if (!data && error) {
          try {
            console.log('Trying auth.users table as fallback...');
            const result2 = await supabase.auth.admin.listUsers();
            if (result2.data && result2.data.users) {
              // Convert auth users to expected format
              data = result2.data.users.map(user => ({
                id: user.id,
                email: user.email,
                name: user.user_metadata?.full_name || user.user_metadata?.name || user.email,
                role: user.user_metadata?.role || 'User',
                created_at: user.created_at
              }));
              console.log('Success with auth.users:', data.length + ' users found');
              error = null;
            }
          } catch (e) {
            console.log('Auth users failed:', e);
          }
        }
        
        // Third attempt: Try a different table name
        if (!data && error) {
          try {
            console.log('Trying users table as final fallback...');
            const result3 = await supabase
              .from('users')
              .select('*');
            
            if (!result3.error && result3.data) {
              data = result3.data;
              console.log('Success with users table:', data.length + ' users found');
              error = null;
            }
          } catch (e) {
            console.log('Users table failed:', e);
          }
        }
        
        if (error && !data) {
          console.error('All user loading attempts failed. Final error:', error);
          users = [];
          showAlert('warning', 'Could not load users from database. Please check your Supabase setup. User assignment may not work properly.');
          return;
        }
        
        if (!data || data.length === 0) {
          console.log('No users found in database');
          users = [];
          const debugMessage = supabase ? 
            'No users found in the database. Open browser console and run window.debugSupabase() to diagnose the issue.' :
            'Supabase not initialized. Check your connection settings.';
          showAlert('info', debugMessage);
          return;
        }
        
        console.log('Raw user data from database:', data.slice(0, 2)); // Show first 2 users for debugging
        
        // Map ALL user data with flexible field mapping, regardless of role
        users = data.map(user => {
          // Use multiple possible field names for name
          const firstName = user.first_name || user.firstName || '';
          const lastName = user.last_name || user.lastName || '';
          const fullName = user.full_name || user.fullName || user.name || user.display_name || user.username || '';
          
          let name;
          if (fullName) {
            name = fullName;
          } else if (firstName || lastName) {
            name = `${firstName} ${lastName}`.trim();
          } else {
            name = user.email || user.email_address || user.user_email || 'Unknown User';
          }
          
          // Use multiple possible field names for email
          const email = user.email || user.email_address || user.user_email || user.auth_email || 'no-email@example.com';
          
          // Create avatar from available data
          let avatar;
          if (user.avatar_url || user.avatar) {
            avatar = user.avatar_url || user.avatar;
          } else if (name && name !== 'Unknown User') {
            avatar = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
          } else {
            avatar = email.charAt(0).toUpperCase();
          }
          
          return {
            id: user.id,
            name: name,
            email: email,
            avatar: avatar,
            role: user.role || user.user_role || user.account_type || 'No Role',
            raw: user // Keep original data for debugging
          };
        });
        
        // Sort users by name after mapping
        users.sort((a, b) => a.name.localeCompare(b.name));
        
        console.log('Successfully loaded ' + users.length + ' users from database (all roles):', users.slice(0, 3)); // Show first 3 users
        console.log('User mapping sample:', users[0]); // Show detailed mapping of first user
        
        showAlert('success', `Loaded ${users.length} users for assignment.`);
        
      } catch (error) {
        console.error('Error loading users:', error);
        users = [];
        showAlert('error', 'Failed to load users from database. User assignment may not work properly.');
      }
    }

    async function handleAssign() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts to assign');
        return;
      }
      
      console.log('Opening assign modal for', selectedContacts.length, 'contacts');
      
      const modal = document.getElementById('user-modal');
      modal.style.display = 'block';
      
      try {
        // Load users from Supabase before displaying
        await loadUsers();
        
        // Show all users initially
        displayUsers(users);
        
        if (users.length === 0) {
          const debugMessage = supabase ? 
            'No users found in the database. Open browser console and run window.debugSupabase() to diagnose the issue.' :
            'Supabase not initialized. Check your connection settings.';
          showAlert('info', debugMessage);
        }
        
        // Focus on search input
        const searchInput = document.getElementById('user-search');
        if (searchInput) {
          searchInput.value = ''; // Clear previous search
          searchInput.focus();
        }
        
        // Disable confirm button initially
        document.getElementById('confirm-assign').disabled = true;
        
      } catch (error) {
        console.error('Error in handleAssign:', error);
        document.getElementById('user-results').innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading users. Please try again.</div>';
        showAlert('error', 'Failed to load users from database');
      }
    }

    async function confirmAssign() {
      console.log('confirmAssign() called'); // Debug log
      
      const selectedUser = document.querySelector('.user-item.selected');
      console.log('Selected user element:', selectedUser); // Debug log
      
      if (!selectedUser) {
        showAlert('warning', 'Please select a user to assign contacts to');
        return;
      }
      
      const userId = selectedUser.getAttribute('data-user-id');
      const user = users.find(u => u.id === userId);
      console.log('Found user object:', user); // Debug log
      
      if (!user) {
        showAlert('error', 'Selected user not found');
        return;
      }
      
      const selectedContacts = getSelectedContacts();
      console.log('Selected contacts for assignment:', selectedContacts); // Debug log
      
      if (selectedContacts.length === 0) {
        showAlert('warning', 'No contacts selected for assignment');
        return;
      }
      
      try {
        console.log('Assigning', selectedContacts.length, 'contacts to user:', user);
        console.log('Selected contact IDs:', selectedContacts);
        console.log('Selected contact IDs types:', selectedContacts.map(id => typeof id));
        
        // Update each selected contact in Supabase
        // Use contact IDs as strings (UUIDs)
        const updates = selectedContacts.map(contactId => {
          console.log(`Updating contact ${contactId} (${typeof contactId})`);
          
          return supabase
            .from('contacts')
            .update({ assignee: user.name })
            .eq('id', contactId); // Use contactId directly (UUID string)
        });
        
        const results = await Promise.all(updates);
        
        // Check for errors
        const errors = results.filter(result => result.error);
        if (errors.length > 0) {
          console.error('Assignment errors:', errors);
          showAlert('error', 'Some contacts could not be assigned: ' + errors[0].error.message);
          return;
        }
        
        // Update local data - use string comparison for UUIDs
        allContacts.forEach(contact => {
          if (selectedContacts.includes(contact.id)) {
            contact.assignee = user.name;
            console.log(`Updated local contact ${contact.id} assignee to ${user.name}`);
          }
        });
        
        // Also update filtered contacts
        filteredContacts.forEach(contact => {
          if (selectedContacts.includes(contact.id)) {
            contact.assignee = user.name;
          }
        });
        
        // Refresh display
        renderContacts();
        
        // Close modal and clear selections
        document.getElementById('user-modal').style.display = 'none';
        clearContactSelections();
        
        // Clear user selection in modal
        const selectedUserDiv = document.getElementById('selected-user');
        selectedUserDiv.style.display = 'none';
        document.querySelectorAll('.user-item.selected').forEach(item => {
          item.classList.remove('selected');
        });
        document.getElementById('confirm-assign').disabled = true;
        
        showAlert('success', `Successfully assigned ${selectedContacts.length} contact(s) to ${user.name}`);
        
      } catch (error) {
        console.error('Error assigning contacts:', error);
        showAlert('error', 'Failed to assign contacts: ' + error.message);
      }
    }

    async function confirmUnassign() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'No contacts selected for unassignment');
        return;
      }
      
      try {
        console.log('Unassigning', selectedContacts.length, 'contacts');
        console.log('Selected contact IDs:', selectedContacts);
        
        // Update each selected contact in Supabase to clear assignee
        const updates = selectedContacts.map(contactId => {
          console.log(`Clearing assignee for contact ${contactId} (${typeof contactId})`);
          
          return supabase
            .from('contacts')
            .update({ assignee: null })
            .eq('id', contactId); // Use contactId directly (UUID string)
        });
        
        const results = await Promise.all(updates);
        
        // Check for errors
        const errors = results.filter(result => result.error);
        if (errors.length > 0) {
          console.error('Unassignment errors:', errors);
          showAlert('error', 'Some contacts could not be unassigned: ' + errors[0].error.message);
          return;
        }
        
        // Update local data - use string comparison for UUIDs
        allContacts.forEach(contact => {
          if (selectedContacts.includes(contact.id)) {
            contact.assignee = '';
            console.log(`Cleared local contact ${contact.id} assignee`);
          }
        });
        
        // Also update filtered contacts
        filteredContacts.forEach(contact => {
          if (selectedContacts.includes(contact.id)) {
            contact.assignee = '';
          }
        });
        
        // Refresh display
        renderContacts();
        
        // Close modal and clear selections
        document.getElementById('user-modal').style.display = 'none';
        clearContactSelections();
        
        // Clear user selection in modal
        const selectedUserDiv = document.getElementById('selected-user');
        selectedUserDiv.style.display = 'none';
        document.querySelectorAll('.user-item.selected').forEach(item => {
          item.classList.remove('selected');
        });
        document.getElementById('confirm-assign').disabled = true;
        
        showAlert('success', `Successfully unassigned ${selectedContacts.length} contact(s)`);
        
      } catch (error) {
        console.error('Error unassigning contacts:', error);
        showAlert('error', 'Failed to unassign contacts: ' + error.message);
      }
    }

    function handleDelete() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts to delete');
        return;
      }
      
      const modal = document.getElementById('delete-modal');
      document.getElementById('delete-count').textContent = selectedContacts.length;
      modal.style.display = 'block';
    }

    function handleSMS() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts for SMS');
        return;
      }
      // Open SMS modal or redirect to SMS page
      showAlert('info', `SMS feature for ${selectedContacts.length} contacts - Coming soon!`);
    }

    function handleEmail() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts for email');
        return;
      }
      // Open email modal or redirect to email page
      showAlert('info', `Email feature for ${selectedContacts.length} contacts - Coming soon!`);
    }

    function handleRVM() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts for RVM');
        return;
      }
      // Open RVM modal or redirect to RVM page
      showAlert('info', `RVM feature for ${selectedContacts.length} contacts - Coming soon!`);
    }

    function handleCampaign() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'Please select contacts for campaign');
        return;
      }
      // Open campaign modal or redirect to campaign page
      showAlert('info', `Campaign feature for ${selectedContacts.length} contacts - Coming soon!`);
    }

    function handleAdd() {
      const modal = document.getElementById('add-contact-modal');
      modal.style.display = 'block';
      // Clear form
      document.getElementById('add-contact-form').reset();
    }

    function handleImport() {
      const modal = document.getElementById('import-modal');
      modal.style.display = 'block';
      // Clear file input and preview
      document.getElementById('csv-file').value = '';
      document.getElementById('import-preview').style.display = 'none';
      document.getElementById('confirm-import').disabled = true;
    }

    function handleExport() {
      // Export all contacts or filtered contacts to CSV
      const contactsToExport = filteredContacts.length > 0 ? filteredContacts : allContacts;
      if (contactsToExport.length === 0) {
        showAlert('warning', 'No contacts to export');
        return;
      }
      
      // Create CSV content
      const headers = ['First Name', 'Last Name', 'Email', 'Phone', 'City', 'State', 'Assignee'];
      const csvContent = [
        headers.join(','),
        ...contactsToExport.map(contact => [
          contact.first_name || '',
          contact.last_name || '',
          contact.email || '',
          contact.phone || '',
          contact.city || '',
          contact.state || '',
          contact.assignee || ''
        ].map(field => `"${field}"`).join(','))
      ].join('\n');
      
      // Download CSV
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'contacts.csv';
      link.click();
      window.URL.revokeObjectURL(url);
      
      showAlert('success', `Exported ${contactsToExport.length} contacts`);
    }

    function handleSearch() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
      
      if (!searchTerm) {
        filteredContacts = [...allContacts];
        hideSuggestions();
      } else {
        filteredContacts = allContacts.filter(contact => {
          return Object.values(contact).some(value => 
            value && value.toString().toLowerCase().includes(searchTerm)
          );
        });
        showSuggestions(searchTerm);
      }
      
      currentPage = 1;
      renderContacts();
      console.log('Search performed for "' + searchTerm + '", found ' + filteredContacts.length + ' contacts');
    }

    function showSuggestions(searchTerm) {
      const suggestions = document.getElementById('search-suggestions');
      const uniqueSuggestions = new Set();
      
      // Get field-specific suggestions
      allContacts.forEach(contact => {
        Object.entries(contact).forEach(([key, value]) => {
          if (value && value.toString().toLowerCase().includes(searchTerm)) {
            uniqueSuggestions.add(value.toString());
          }
        });
      });
      
      const suggestionArray = Array.from(uniqueSuggestions).slice(0, 8);
      
      if (suggestionArray.length > 0) {
        suggestions.innerHTML = suggestionArray.map(suggestion => 
          `<div class="suggestion-item" onclick="selectSuggestion('${suggestion}')">${suggestion}</div>`
        ).join('');
        suggestions.style.display = 'block';
      } else {
        suggestions.style.display = 'none';
      }
    }

    function selectSuggestion(suggestion) {
      document.getElementById('search-input').value = suggestion;
      hideSuggestions();
      handleSearch();
    }

    function hideSuggestions() {
      document.getElementById('search-suggestions').style.display = 'none';
    }

    function showAlert(type, message) {
      console.log(`[${type.toUpperCase()}] ${message}`);
      // Simple alert for now to ensure user sees messages
      alert(`${type.toUpperCase()}: ${message}`);
    }

    function updateStats() {
      console.log('Stats updated - Total contacts:', allContacts.length, 'Filtered:', filteredContacts.length);
    }

    // Simple startup diagnostic
    async function runStartupDiagnostic() {
      console.log('=== STARTUP DIAGNOSTIC ===');
      console.log('1. Supabase library check:', typeof window.supabase !== 'undefined' ? 'LOADED' : 'MISSING');
      console.log('2. Supabase client initialized:', !!supabase ? 'YES' : 'NO');
      console.log('3. Supabase URL:', SUPABASE_URL);
      console.log('4. Running table connection test...');
      
      if (supabase) {
        try {
          const { data, error } = await supabase
            .from('contacts')
            .select('count', { count: 'exact', head: true });
            
          if (error) {
            console.log('5. Table connection: FAILED -', error.message);
            showAlert('error', `Database connection failed: ${error.message}. Please check your Supabase setup and run the table creation script.`);
          } else {
            console.log('5. Table connection: SUCCESS');
            console.log('6. Now testing data query...');
            
            const { data: sampleData, error: queryError } = await supabase
              .from('contacts')
              .select('*')
              .limit(1);
              
            if (queryError) {
              console.log('7. Data query: FAILED -', queryError.message);
              showAlert('error', `Data query failed: ${queryError.message}`);
            } else {
              console.log('7. Data query: SUCCESS');
              console.log('8. Sample data:', sampleData);
              
              if (sampleData && sampleData.length > 0) {
                console.log('9. Data structure check: PASSED');
                console.log('Available columns:', Object.keys(sampleData[0]));
              } else {
                console.log('9. Data structure check: NO DATA (table is empty)');
                showAlert('info', 'Contacts table is empty. You can add sample data by running createSampleContacts() in the browser console.');
              }
            }
          }
        } catch (err) {
          console.log('5. Table connection: ERROR -', err.message);
          showAlert('error', `Connection error: ${err.message}`);
        }
      } else {
        console.log('5. Cannot test - Supabase client not initialized');
        showAlert('error', 'Supabase client not initialized. Please check if the Supabase library loaded correctly.');
      }
      
      console.log('=== DIAGNOSTIC COMPLETE ===');
    }

    // Initialize app with diagnostic
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Contacts app starting...');
      adjustTableHeight();
      
      // Run diagnostic first
      setTimeout(async () => {
        await runStartupDiagnostic();
        await initializeApp();
      }, 100); // Small delay to ensure DOM is ready
    });

    // Adjust table height dynamically
    function adjustTableHeight() {
      const tableContainer = document.querySelector('.table-container');
      if (!tableContainer) return;
      
      const viewportHeight = window.innerHeight;
      const availableHeight = viewportHeight - 120;
      const bottomMargin = 40;
      
      const dynamicHeight = Math.max(200, availableHeight - bottomMargin);
      tableContainer.style.height = dynamicHeight + 'px';
      
      console.log('Table height adjusted to:', dynamicHeight, 'px');
    }

    async function initializeApp() {
      try {
        console.log('Initializing app...');
        
        // First try to load contacts
        await loadContacts();
        
        // Only setup event listeners if we get this far
        setupEventListeners();
        
        // Initialize delete button as disabled
        const deleteBtn = document.getElementById('delete-btn');
        if (deleteBtn) {
          deleteBtn.disabled = true;
          deleteBtn.style.opacity = '0.5';
          deleteBtn.style.cursor = 'not-allowed';
        }
        
        const pageSizeSelect = document.getElementById('page-size-select');
        if (pageSizeSelect) {
          pageSize = pageSizeSelect.value === 'all' ? 'all' : parseInt(pageSizeSelect.value);
          console.log('Initial pageSize set to:', pageSize);
        }
        
        updateStats();
        
        if (allContacts.length === 0) {
          showAlert('info', 'No contacts found. The table may be empty or you may need to run the table setup script. Check the browser console for more details.');
        } else {
          showAlert('success', `Contacts loaded successfully! Found ${allContacts.length} contacts.`);
        }
      } catch (error) {
        console.error('Error initializing app:', error);
        const errorMessage = error.message || 'Unknown error occurred';
        
        // Provide specific guidance based on error type
        let guidance = '';
        if (errorMessage.includes('does not exist')) {
          guidance = ' Please run the complete_contacts_table_setup.sql script in your Supabase SQL Editor.';
        } else if (errorMessage.includes('JWT') || errorMessage.includes('auth')) {
          guidance = ' Please check your Supabase URL and API key configuration.';
        } else if (errorMessage.includes('permission')) {
          guidance = ' Please check your Supabase RLS policies and table permissions.';
        }
        
        showAlert('error', `Failed to load contacts: ${errorMessage}.${guidance} Check the browser console for details.`);
        
        // Still render empty table so user can see the interface
        allContacts = [];
        filteredContacts = [];
        renderContacts();
      }
    }

    // Load contacts from Supabase
    async function loadContacts() {
      try {
        if (supabase) {
          console.log('Loading contacts from Supabase...');
          console.log('Supabase client:', supabase);
          
          // First check if the table exists and get its structure
          console.log('Testing connection to contacts table...');
          const { data: testData, error: testError } = await supabase
            .from('contacts')
            .select('*')
            .limit(1);
          
          if (testError) {
            console.error('Error testing contacts table:', testError);
            
            // Provide specific error messages for common issues
            if (testError.message.includes('relation "contacts" does not exist')) {
              throw new Error('Contacts table does not exist. Please run the table creation SQL script in your Supabase database.');
            } else if (testError.message.includes('JWT')) {
              throw new Error('Authentication error. Please check your Supabase configuration and permissions.');
            } else {
              throw new Error(`Database connection error: ${testError.message}`);
            }
          }
          
          console.log('Contacts table accessible, loading all data...');
          const { data, error } = await supabase
            .from('contacts')
            .select('*')
            .order('id', { ascending: true });
          
          if (error) {
            console.error('Error querying contacts:', error);
            throw new Error(`Query error: ${error.message}`);
          }
          
          console.log('Raw data from Supabase:', data);
          console.log('Data type:', typeof data, 'Is array:', Array.isArray(data), 'Length:', data?.length);
          
          if (data && Array.isArray(data)) {
            // Map data and ensure all expected fields exist with defaults
            allContacts = data.map(contact => ({
              id: contact.id || '',
              sms: contact.sms || '',
              call: contact.call || '',
              email_flag: contact.email_flag || '',
              assignee: contact.assignee || '',
              sponsor: contact.sponsor || '',
              sponsor_first: contact.sponsor_first || '',
              sponsor_last: contact.sponsor_last || '',
              user_id: contact.user_id || '',
              first_name: contact.first_name || '',
              last_name: contact.last_name || '',
              email: contact.email || '',
              valid: contact.valid || (contact.email_valid ? 'Yes' : ''), // Handle both field names
              phone: contact.phone || '',
              address: contact.address || '',
              city: contact.city || '',
              state: contact.state || '',
              zip: contact.zip || '',
              ip_address: contact.ip_address || '',
              date_created: contact.date_created || '',
              timezone: contact.timezone || '',
              cell: contact.cell,
              carrier: contact.carrier || '',
              landline: contact.landline,
              voip: contact.voip,
              other_phone: contact.other_phone,
              foreign_number: contact.foreign_number,
              country: contact.country || 'US'
            }));
            
            filteredContacts = [...allContacts];
            renderContacts();
            console.log('Successfully loaded ' + allContacts.length + ' contacts from Supabase');
            return;
          } else {
            console.warn('No data returned from Supabase, initializing empty arrays');
            allContacts = [];
            filteredContacts = [];
            renderContacts();
            return;
          }
        } else {
          throw new Error('Supabase client not initialized. Please check if the Supabase library loaded correctly.');
        }
        
      } catch (error) {
        console.error('Error loading contacts from Supabase:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          supabaseConnected: !!supabase,
          supabaseUrl: SUPABASE_URL
        });
        
        // Initialize empty arrays if Supabase fails
        allContacts = [];
        filteredContacts = [];
        renderContacts();
        
        throw error; // Re-throw to be handled by initializeApp
      }
    }

    function renderContacts() {
      console.log('renderContacts called - pageSize:', pageSize, 'currentPage:', currentPage, 'filteredContacts.length:', filteredContacts.length);
      const tbody = document.getElementById('contacts-tbody');
      
      if (!tbody) {
        console.error('Tbody element not found!');
        return;
      }
      
      tbody.innerHTML = '';
      
      if (filteredContacts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="30" style="text-align: center; padding: 40px; color: #6c757d;">No contacts found</td></tr>';
        return;
      }

      // Calculate pagination
      let contactsToShow;
      if (pageSize === 'all') {
        contactsToShow = filteredContacts;
      } else {
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        contactsToShow = filteredContacts.slice(startIndex, endIndex);
      }

      contactsToShow.forEach((contact, index) => {
        const row = document.createElement('tr');
        
        // Calculate row number based on pagination
        const rowNumber = pageSize === 'all' ? index + 1 : ((currentPage - 1) * pageSize) + index + 1;
        
        // All columns are now editable except the checkbox
        row.innerHTML = 
          '<td><input type="checkbox" class="contact-checkbox checkbox" data-id="' + contact.id + '"></td>' +
          '<td class="editable-cell" data-field="sms" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.sms || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="call" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.call || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="email_flag" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.email_flag || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="readonly-cell">' + 
            '<span class="cell-content">' + rowNumber + '</span>' +
          '</td>' +
          '<td class="readonly-cell">' + 
            '<span class="cell-content">' + (contact.id || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="assignee" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.assignee || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="sponsor" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.sponsor || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="sponsor_first" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.sponsor_first || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="sponsor_last" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.sponsor_last || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="readonly-cell">' + 
            '<span class="cell-content">' + (contact.user_id || '') + '</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="first_name" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.first_name || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="last_name" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.last_name || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="email" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.email || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="valid" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.valid || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="phone" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.phone || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="address" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.address || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="city" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.city || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="state" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.state || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="zip" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.zip || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="ip_address" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.ip_address || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="date_created" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.date_created || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="timezone" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.timezone || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="cell" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.cell ? 'Yes' : (contact.cell === false ? 'No' : '')) + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="carrier" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.carrier || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="landline" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.landline ? 'Yes' : (contact.landline === false ? 'No' : '')) + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="voip" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.voip ? 'Yes' : (contact.voip === false ? 'No' : '')) + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="other_phone" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.other_phone ? 'Yes' : (contact.other_phone === false ? 'No' : '')) + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="foreign_number" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.foreign_number ? 'Yes' : (contact.foreign_number === false ? 'No' : '')) + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>' +
          '<td class="editable-cell" data-field="country" data-id="' + contact.id + '">' + 
            '<span class="cell-content">' + (contact.country || '') + '</span>' +
            '<span class="edit-indicator">✎</span>' +
          '</td>';
        
        tbody.appendChild(row);
      });
      
      // Update pagination
      updatePagination();
      
      // Add event listeners to checkboxes
      document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', handleContactSelection);
      });
      
      // Add event listeners to editable cells
      document.querySelectorAll('.editable-cell').forEach(cell => {
        cell.addEventListener('click', function(e) {
          if (!this.classList.contains('editing')) {
            makeEditable(this);
          }
        });
        
        cell.addEventListener('dblclick', function(e) {
          if (!this.classList.contains('editing')) {
            makeEditable(this);
          }
        });
      });
      
      console.log('renderContacts completed - rendered ' + contactsToShow.length + ' rows');
    }

    function handleContactSelection(event) {
      const contactId = event.target.dataset.id; // Keep as string for UUID
      const row = event.target.closest('tr');
      
           
      console.log('Contact selection - ID:', contactId, 'Type:', typeof contactId);
      
      if (event.target.checked) {
        selectedContactIds.add(contactId);
        row.classList.add('selected');
        console.log('Contact selected, added to selectedContactIds'); // Debug log
      } else {
        selectedContactIds.delete(contactId);
        row.classList.remove('selected');
        console.log('Contact deselected, removed from selectedContactIds'); // Debug log
      }
      
      // Update header checkbox and delete button state
      updateHeaderCheckboxAndDeleteButton();
      
      console.log('Selected contacts:', Array.from(selectedContactIds));
    }

    function updateHeaderCheckboxAndDeleteButton() {
      const headerCheckbox = document.getElementById('header-checkbox');
      const deleteBtn = document.getElementById('delete-btn');
      const selectAllToggle = document.getElementById('select-all-toggle');
      const totalContactsCount = document.getElementById('total-contacts-count');
      const selectedCount = document.getElementById('selected-count');
      const allCheckboxes = document.querySelectorAll('.contact-checkbox');
      const checkedCheckboxes = document.querySelectorAll('.contact-checkbox:checked');
      
      // Update selected count display
      if (selectedCount) {
        selectedCount.textContent = selectedContactIds.size;
      }
      
      if (totalContactsCount) {
        totalContactsCount.textContent = filteredContacts.length;
      }
      
      // Show/hide select all toggle
      if (selectAllToggle) {
        if (selectedContactIds.size > 0) {
          selectAllToggle.style.display = 'block';
        } else {
          selectAllToggle.style.display = 'none';
        }
      }
      
      // Update header checkbox state
      if (headerCheckbox) {
        if (allCheckboxes.length === 0) {
          headerCheckbox.indeterminate = false;
          headerCheckbox.checked = false;
        } else if (checkedCheckboxes.length === allCheckboxes.length) {
          headerCheckbox.indeterminate = false;
          headerCheckbox.checked = true;
        } else if (checkedCheckboxes.length > 0) {
          headerCheckbox.indeterminate = true;
          headerCheckbox.checked = false;
        } else {
          headerCheckbox.indeterminate = false;
          headerCheckbox.checked = false;
        }
      }
      
      // Update delete button state
      if (deleteBtn) {
        if (selectedContactIds.size > 0) {
          deleteBtn.disabled = false;
          deleteBtn.style.opacity = '1';
          deleteBtn.style.cursor = 'pointer';
        } else {
          deleteBtn.disabled = true;
          deleteBtn.style.opacity = '0.5';
          deleteBtn.style.cursor = 'not-allowed';
        }
      }
    }

    function updatePagination() {
      // Simple pagination implementation
      const paginationContainer = document.getElementById('pagination');
      const contactCountDisplay = document.getElementById('contact-count-display');
      
      if (contactCountDisplay) {
        contactCountDisplay.textContent = `Showing ${filteredContacts.length} contacts`;
      }
      
      if (paginationContainer) {
        paginationContainer.innerHTML = '';
        // Add basic pagination if needed
      }
    }

    function displayUsers(usersToShow) {
      const userResults = document.getElementById('user-results');
      if (!userResults) return;
      
      if (!usersToShow || usersToShow.length === 0) {
        userResults.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">No users found</div>';
        return;
      }
      
      userResults.innerHTML = usersToShow.map(user => `
        <div class="user-item" data-user-id="${user.id}">
          <div class="user-avatar">${user.avatar}</div>
          <div class="user-info">
            <div class="user-name">${user.name}</div>
            <div class="user-email">${user.email} • ${user.role}</div>
          </div>
        </div>
      `).join('');
      
      // Add click listeners to user items
      document.querySelectorAll('.user-item').forEach(item => {
        item.addEventListener('click', function() {
          // Clear previous selections
          document.querySelectorAll('.user-item.selected').forEach(selectedItem => {
            selectedItem.classList.remove('selected');
          });
          
          // Select this item
          this.classList.add('selected');
          
          // Update UI
          const userId = this.getAttribute('data-user-id');
          const user = users.find(u => u.id === userId);
          
          if (user) {
            const selectedUserDiv = document.getElementById('selected-user');
            const selectedUserName = document.getElementById('selected-user-name');
            
            if (selectedUserDiv && selectedUserName) {
              selectedUserName.textContent = user.name;
              selectedUserDiv.style.display = 'block';
            }
            
            // Enable confirm button
            const confirmBtn = document.getElementById('confirm-assign');
            if (confirmBtn) {
              confirmBtn.disabled = false;
            }
          }
        });
      });
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const csvData = e.target.result;
          const lines = csvData.split('\n');
          const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
          
          importData = [];
          for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim()) {
              const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
              const contact = {};
              headers.forEach((header, index) => {
                contact[header.toLowerCase().replace(/\s+/g, '_')] = values[index] || '';
              });
              importData.push(contact);
            }
          }
          
          // Show preview
          const previewDiv = document.getElementById('import-preview');
          const previewTable = document.getElementById('preview-table');
          const totalRows = document.getElementById('total-rows');
          
          if (previewDiv && previewTable && totalRows) {
            previewDiv.style.display = 'block';
            totalRows.textContent = importData.length;
            
            // Create preview table
            const previewData = importData.slice(0, 5);
            let tableHTML = '<table style="width: 100%; font-size: 12px;"><thead><tr>';
            headers.forEach(header => {
              tableHTML += `<th style="padding: 5px; border: 1px solid #ddd;">${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            previewData.forEach(row => {
              tableHTML += '<tr>';
              headers.forEach(header => {
                const value = row[header.toLowerCase().replace(/\s+/g, '_')] || '';
                tableHTML += `<td style="padding: 5px; border: 1px solid #ddd;">${value}</td>`;
              });
              tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            previewTable.innerHTML = tableHTML;
            
            // Enable import button
            const confirmImportBtn = document.getElementById('confirm-import');
            if (confirmImportBtn) {
              confirmImportBtn.disabled = false;
            }
          }
          
        } catch (error) {
          console.error('Error parsing CSV:', error);
          showAlert('error', 'Error parsing CSV file. Please check the format.');
        }
      };
      
      reader.readAsText(file);
    }

    function setupEventListeners() {
      // Button event listeners
      const deleteBtn = document.getElementById('delete-btn');
      const assignBtn = document.getElementById('assign-btn');
      const smsBtn = document.getElementById('sms-btn');
      const emailBtn = document.getElementById('email-btn');
      const rvmBtn = document.getElementById('rvm-btn');
      const campaignBtn = document.getElementById('campaign-btn');
      const addBtn = document.getElementById('add-btn');
      const importBtn = document.getElementById('import-btn');
      const exportBtn = document.getElementById('export-btn');
      const searchBtn = document.getElementById('search-btn');
      const resetBtn = document.getElementById('reset-btn');
      
      if (deleteBtn) deleteBtn.addEventListener('click', handleDelete);
      if (assignBtn) assignBtn.addEventListener('click', handleAssign);
      if (smsBtn) smsBtn.addEventListener('click', handleSMS);
      if (emailBtn) emailBtn.addEventListener('click', handleEmail);
      if (rvmBtn) rvmBtn.addEventListener('click', handleRVM);
      if (campaignBtn) campaignBtn.addEventListener('click', handleCampaign);
      if (addBtn) addBtn.addEventListener('click', handleAdd);
      if (importBtn) importBtn.addEventListener('click', handleImport);
      if (exportBtn) exportBtn.addEventListener('click', handleExport);
      if (searchBtn) searchBtn.addEventListener('click', handleSearch);
      if (resetBtn) resetBtn.addEventListener('click', () => {
        document.getElementById('search-input').value = '';
        filteredContacts = [...allContacts];
        currentPage = 1;
        renderContacts();
        hideSuggestions();
      });
      
      // Search input event listener
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.addEventListener('input', handleSearch);
        searchInput.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            hideSuggestions();
          }
        });
      }
      
      // Header checkbox event listener
      const headerCheckbox = document.getElementById('header-checkbox');
      if (headerCheckbox) {
        headerCheckbox.addEventListener('change', function(e) {
          const isChecked = e.target.checked;
          document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
            checkbox.checked = isChecked;
            const contactId = checkbox.dataset.id;
            const row = checkbox.closest('tr');
            
            if (isChecked) {
              selectedContactIds.add(contactId);
              row.classList.add('selected');
            } else {
              selectedContactIds.delete(contactId);
              row.classList.remove('selected');
            }
          });
          updateHeaderCheckboxAndDeleteButton();
        });
      }
      
      // Modal event listeners
      setupModalEventListeners();
      
      // File input event listener
      const csvFileInput = document.getElementById('csv-file');
      if (csvFileInput) {
        csvFileInput.addEventListener('change', handleFileSelect);
      }
      
      console.log('Event listeners set up successfully');
    }

    function setupModalEventListeners() {
      // Close buttons for all modals
      document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.addEventListener('click', function() {
          this.closest('.modal').style.display = 'none';
        });
      });
      
      // Modal background click to close
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            this.style.display = 'none';
          }
        });
      });
      
      // User modal buttons
      const cancelAssignBtn = document.getElementById('cancel-assign');
      const confirmAssignBtn = document.getElementById('confirm-assign');
      const unassignBtn = document.getElementById('unassign-selected');
      
      if (cancelAssignBtn) {
        cancelAssignBtn.addEventListener('click', () => {
          document.getElementById('user-modal').style.display = 'none';
        });
      }
      
      if (confirmAssignBtn) {
        confirmAssignBtn.addEventListener('click', confirmAssign);
      }
      
      if (unassignBtn) {
        unassignBtn.addEventListener('click', confirmUnassign);
      }
      
      // User search functionality
      const userSearchInput = document.getElementById('user-search');
      if (userSearchInput) {
        userSearchInput.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          if (searchTerm.trim() === '') {
            displayUsers(users);
          } else {
            const filteredUsers = users.filter(user => 
              user.name.toLowerCase().includes(searchTerm) ||
              user.email.toLowerCase().includes(searchTerm) ||
              user.role.toLowerCase().includes(searchTerm)
            );
            displayUsers(filteredUsers);
          }
        });
      }
      
      // Add contact modal buttons
      const cancelAddBtn = document.getElementById('cancel-add');
      const confirmAddBtn = document.getElementById('confirm-add');
      
      if (cancelAddBtn) {
        cancelAddBtn.addEventListener('click', () => {
          document.getElementById('add-contact-modal').style.display = 'none';
        });
      }
      
      if (confirmAddBtn) {
        confirmAddBtn.addEventListener('click', async () => {
          const form = document.getElementById('add-contact-form');
          const formData = new FormData(form);
          const newContact = Object.fromEntries(formData.entries());
          
          try {
            const { data, error } = await supabase
              .from('contacts')
              .insert([newContact])
              .select();
              
            if (error) throw error;
            
            showAlert('success', 'Contact added successfully');
            document.getElementById('add-contact-modal').style.display = 'none';
            await loadContacts(); // Reload contacts
            
          } catch (error) {
            console.error('Error adding contact:', error);
            showAlert('error', 'Failed to add contact: ' + error.message);
          }
        });
      }
      
      // Import modal buttons
      const cancelImportBtn = document.getElementById('cancel-import');
      const confirmImportBtn = document.getElementById('confirm-import');
      
      if (cancelImportBtn) {
        cancelImportBtn.addEventListener('click', () => {
          document.getElementById('import-modal').style.display = 'none';
        });
      }
      
      if (confirmImportBtn) {
        confirmImportBtn.addEventListener('click', async () => {
          if (importData.length === 0) {
            showAlert('warning', 'No data to import');
            return;
          }
          
          try {
            const { data, error } = await supabase
              .from('contacts')
              .insert(importData)
              .select();
              
            if (error) throw error;
            
            showAlert('success', `Successfully imported ${data.length} contacts`);
            document.getElementById('import-modal').style.display = 'none';
            await loadContacts(); // Reload contacts
            
          } catch (error) {
            console.error('Error importing contacts:', error);
            showAlert('error', 'Failed to import contacts: ' + error.message);
          }
        });
      }
      
      // Delete modal buttons
      const cancelDeleteBtn = document.getElementById('cancel-delete');
      const confirmDeleteBtn = document.getElementById('confirm-delete');
      
      if (cancelDeleteBtn) {
        cancelDeleteBtn.addEventListener('click', () => {
          document.getElementById('delete-modal').style.display = 'none';
        });
      }
      
      if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener('click', async () => {
          const selectedContacts = getSelectedContacts();
          
          try {
            const { error } = await supabase
              .from('contacts')
              .delete()
              .in('id', selectedContacts);
              
            if (error) throw error;
            
            showAlert('success', `Successfully deleted ${selectedContacts.length} contact(s)`);
            document.getElementById('delete-modal').style.display = 'none';
            clearContactSelections();
            await loadContacts(); // Reload contacts
            
          } catch (error) {
            console.error('Error deleting contacts:', error);
            showAlert('error', 'Failed to delete contacts: ' + error.message);
          }
        });
      }
    }

    // Missing utility functions that are referenced but not defined

    function getSelectedContacts() {
      return Array.from(selectedContactIds);
    }

    function clearContactSelections() {
      selectedContactIds.clear();
      document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      document.querySelectorAll('.table tbody tr').forEach(row => {
        row.classList.remove('selected');
      });
      updateHeaderCheckboxAndDeleteButton();
    }

    function updateHeaderCheckboxAndDeleteButton() {
      const headerCheckbox = document.getElementById('header-checkbox');
      const deleteBtn = document.getElementById('delete-btn');
      const selectAllToggle = document.getElementById('select-all-toggle');
      const totalContactsCount = document.getElementById('total-contacts-count');
      const selectedCount = document.getElementById('selected-count');
      const allCheckboxes = document.querySelectorAll('.contact-checkbox');
      const checkedCheckboxes = document.querySelectorAll('.contact-checkbox:checked');
      
      // Update selected count display
      if (selectedCount) {
        selectedCount.textContent = selectedContactIds.size;
      }
      
      if (totalContactsCount) {
        totalContactsCount.textContent = filteredContacts.length;
      }
      
      // Show/hide select all toggle
      if (selectAllToggle) {
        if (selectedContactIds.size > 0) {
          selectAllToggle.style.display = 'block';
        } else {
          selectAllToggle.style.display = 'none';
        }
      }
      
      // Update header checkbox state
      if (headerCheckbox) {
        if (allCheckboxes.length === 0) {
          headerCheckbox.indeterminate = false;
          headerCheckbox.checked = false;
        } else if (checkedCheckboxes.length === allCheckboxes.length) {
          headerCheckbox.indeterminate = false;
          headerCheckbox.checked = true;
        } else if (checkedCheckboxes.length > 0) {
          headerCheckbox.indeterminate = true;
          headerCheckbox.checked = false;
        } else {
          headerCheckbox.indeterminate = false;
          headerCheckbox.checked = false;
        }
      }
      
      // Update delete button state
      if (deleteBtn) {
        if (selectedContactIds.size > 0) {
          deleteBtn.disabled = false;
          deleteBtn.style.opacity = '1';
          deleteBtn.style.cursor = 'pointer';
        } else {
          deleteBtn.disabled = true;
          deleteBtn.style.opacity = '0.5';
          deleteBtn.style.cursor = 'not-allowed';
        }
      }
    }

    function updatePagination() {
      // Simple pagination implementation
      const paginationContainer = document.getElementById('pagination');
      const contactCountDisplay = document.getElementById('contact-count-display');
      
      if (contactCountDisplay) {
        contactCountDisplay.textContent = `Showing ${filteredContacts.length} contacts`;
      }
      
      if (paginationContainer) {
        paginationContainer.innerHTML = '';
        // Add basic pagination if needed
      }
    }

    function displayUsers(usersToShow) {
      const userResults = document.getElementById('user-results');
      if (!userResults) return;
      
      if (!usersToShow || usersToShow.length === 0) {
        userResults.innerHTML = '<div style="text-align: center; padding: 20px; color: #6c757d;">No users found</div>';
        return;
      }
      
      userResults.innerHTML = usersToShow.map(user => `
        <div class="user-item" data-user-id="${user.id}">
          <div class="user-avatar">${user.avatar}</div>
          <div class="user-info">
            <div class="user-name">${user.name}</div>
            <div class="user-email">${user.email} • ${user.role}</div>
          </div>
        </div>
      `).join('');
      
      // Add click listeners to user items
      document.querySelectorAll('.user-item').forEach(item => {
        item.addEventListener('click', function() {
          // Clear previous selections
          document.querySelectorAll('.user-item.selected').forEach(selectedItem => {
            selectedItem.classList.remove('selected');
          });
          
          // Select this item
          this.classList.add('selected');
          
          // Update UI
          const userId = this.getAttribute('data-user-id');
          const user = users.find(u => u.id === userId);
          
          if (user) {
            const selectedUserDiv = document.getElementById('selected-user');
            const selectedUserName = document.getElementById('selected-user-name');
            
            if (selectedUserDiv && selectedUserName) {
              selectedUserName.textContent = user.name;
              selectedUserDiv.style.display = 'block';
            }
            
            // Enable confirm button
            const confirmBtn = document.getElementById('confirm-assign');
            if (confirmBtn) {
              confirmBtn.disabled = false;
            }
          }
        });
      });
    }

    // Debug function to test Supabase connection
    async function testSupabaseConnection() {
      console.log('Testing Supabase connection...');
      console.log('Supabase URL:', SUPABASE_URL);
      console.log('Supabase client:', supabase);
      
      if (!supabase) {
        console.error('Supabase client not initialized');
        return false;
      }
      
      try {
        // Test basic connection
        const { data, error } = await supabase
          .from('contacts')
          .select('*')
          .limit(1);
          
        if (error) {
          console.error('Supabase connection test failed:', error);
          return false;
        }
        
        console.log('Supabase connection test successful:', data);
        return true;
      } catch (err) {
        console.error('Supabase connection test error:', err);
        return false;
      }
    }

    // Call this in browser console to test: testSupabaseConnection()
    window.testSupabaseConnection = testSupabase;

    // Debug function to check contacts table schema
    async function checkContactsSchema() {
      console.log('Checking contacts table schema...');
      
      if (!supabase) {
        console.error('Supabase client not initialized');
        return;
      }
      
      try {
        // Get one record to see the structure
        const { data, error } = await supabase
          .from('contacts')
          .select('*')
          .limit(1);
          
        if (error) {
          console.error('Schema check failed:', error);
        } else {
          console.log('Contacts table schema (sample record):', data?.[0] || 'No records found');
        }
        
        // Try to get column info
        const { data: columns, error: colError } = await supabase
          .rpc('get_table_columns', { table_name: 'contacts' });
          
        if (!colError && columns) {
          console.log('Table columns:', columns);
        }
      } catch (err) {
        console.error('Schema check error:', err);
      }
    }
    
    window.checkContactsSchema = checkContactsSchema;
    
    // Debug function to analyze table structure and report missing columns
    async function analyzeContactsTable() {
      console.log('Analyzing contacts table structure...');
      
      if (!supabase) {
        console.error('Supabase client not initialized');
        showAlert('error', 'Supabase client not initialized');
        return;
      }
      
      try {
        // Get a sample record to see what columns exist
        const { data, error } = await supabase
          .from('contacts')
          .select('*')
          .limit(1);
          
        if (error) {
          console.error('Table analysis failed:', error);
          showAlert('error', `Table analysis failed: ${error.message}`);
          return;
        }
        
        const expectedColumns = [
          'id', 'sms', 'call', 'email_flag', 'assignee', 'sponsor', 'sponsor_first', 
          'sponsor_last', 'user_id', 'first_name', 'last_name', 'email', 'valid', 
          'phone', 'address', 'city', 'state', 'zip', 'ip_address', 'date_created',
          'timezone', 'cell', 'carrier', 'landline', 'voip', 'other_phone', 
          'foreign_number', 'country'
        ];
        
        if (data && data.length > 0) {
          const actualColumns = Object.keys(data[0]);
          const missingColumns = expectedColumns.filter(col => !actualColumns.includes(col));
          const extraColumns = actualColumns.filter(col => !expectedColumns.includes(col));
          
          console.log('Table analysis complete:');
          console.log('Expected columns:', expectedColumns);
          console.log('Actual columns:', actualColumns);
          console.log('Missing columns:', missingColumns);
          console.log('Extra columns:', extraColumns);
          console.log('Sample record:', data[0]);
          
          if (missingColumns.length > 0) {
            const message = `Missing columns detected: ${missingColumns.join(', ')}. Please run the complete_contacts_table_setup.sql script.`;
            showAlert('warning', message);
          } else {
            showAlert('success', 'All expected columns are present in the contacts table.');
          }
        } else {
          console.log('No data in contacts table');
          showAlert('info', 'Contacts table exists but is empty. You can add contacts using the Import or Add buttons.');
        }
        
      } catch (err) {
        console.error('Table analysis error:', err);
        showAlert('error', `Table analysis error: ${err.message}`);
      }
    }
    
    window.analyzeContactsTable = analyzeContactsTable;
    
    // Debug function to create sample contacts for testing
    async function createSampleContacts() {
      if (!supabase) {
        console.error('Supabase client not initialized');
        return;
      }
      
      const sampleContacts = [
        {
          sms: '', call: '', email_flag: '', assignee: '', sponsor: 'John Doe', 
          sponsor_first: 'John', sponsor_last: 'Doe', user_id: 'user001', 
          first_name: 'Alice', last_name: 'Smith', email: 'alice@example.com', 
          valid: 'Yes', phone: '555-0101', address: '123 Main St', city: 'Anytown', 
          state: 'CA', zip: '90210', ip_address: '192.168.1.1', timezone: 'PST', 
          cell: true, carrier: 'Verizon', landline: false, voip: false, 
          other_phone: false, foreign_number: false, country: 'US'
        },
        {
          sms: '', call: '', email_flag: '', assignee: '', sponsor: 'Jane Wilson', 
          sponsor_first: 'Jane', sponsor_last: 'Wilson', user_id: 'user002', 
          first_name: 'Bob', last_name: 'Johnson', email: 'bob@example.com', 
          valid: 'Yes', phone: '555-0102', address: '456 Oak Ave', city: 'Another City', 
          state: 'TX', zip: '75001', ip_address: '192.168.1.2', timezone: 'CST', 
          cell: true, carrier: 'AT&T', landline: false, voip: false, 
          other_phone: false, foreign_number: false, country: 'US'
        }
      ];
      
      try {
        const { data, error } = await supabase
          .from('contacts')
          .insert(sampleContacts)
          .select();
          
        if (error) {
          console.error('Error creating sample contacts:', error);
          showAlert('error', `Failed to create sample contacts: ${error.message}`);
        } else {
          console.log('Sample contacts created:', data);
          showAlert('success', `Created ${data.length} sample contacts`);
          await loadContacts(); // Reload the contacts
        }
      } catch (err) {
        console.error('Sample contacts creation error:', err);
        showAlert('error', `Sample contacts creation error: ${err.message}`);
      }
    }
    
    window.createSampleContacts = createSampleContacts;

    function confirmAdd() {
      const form = document.getElementById('add-contact-form');
      const formData = new FormData(form);
      
      // Basic validation
      if (!formData.get('first_name') || !formData.get('last_name') || !formData.get('email')) {
        showAlert('warning', 'Please fill in all required fields');
        return;
      }
      
      const newContact = {
        first_name: formData.get('first_name'),
        last_name: formData.get('last_name'),
        email: formData.get('email'),
        phone: formData.get('phone') || '',
        city: formData.get('city') || '',
        state: formData.get('state') || '',
        sms: '',
        call: '',
        email_flag: '',
        assignee: ''
      };
      
      // Add to Supabase and local array
      if (supabase) {
        supabase.from('contacts').insert([newContact]).then(({ data, error }) => {
          if (error) {
            console.error('Error adding contact:', error);
            showAlert('error', 'Failed to add contact: ' + error.message);
          } else {
            console.log('Contact added successfully:', data);
            showAlert('success', 'Contact added successfully');
            // Refresh contacts list
            loadContacts();
            // Close modal
            document.getElementById('add-contact-modal').style.display = 'none';
          }
        });
      } else {
        // Add to local array if Supabase not available
        newContact.id = Date.now(); // Temporary ID
        allContacts.push(newContact);
        filteredContacts = [...allContacts];
        renderContacts();
        showAlert('success', 'Contact added successfully (locally)');
        document.getElementById('add-contact-modal').style.display = 'none';
      }
    }

    function confirmImport() {
      if (importData.length === 0) {
        showAlert('warning', 'No data to import');
        return;
      }
      
      // Import contacts to Supabase
      if (supabase) {
        supabase.from('contacts').insert(importData).then(({ data, error }) => {
          if (error) {
            console.error('Error importing contacts:', error);
            showAlert('error', 'Failed to import contacts: ' + error.message);
          } else {
            console.log('Contacts imported successfully:', data);
            showAlert('success', `Successfully imported ${importData.length} contacts`);
            // Refresh contacts list
            loadContacts();
            // Close modal
            document.getElementById('import-modal').style.display = 'none';
          }
        });
      } else {
        // Add to local array if Supabase not available
        allContacts.push(...importData);
        filteredContacts = [...allContacts];
        renderContacts();
        showAlert('success', `Imported ${importData.length} contacts (locally)`);
        document.getElementById('import-modal').style.display = 'none';
      }
    }

    function confirmDelete() {
      const selectedContacts = getSelectedContacts();
      if (selectedContacts.length === 0) {
        showAlert('warning', 'No contacts selected for deletion');
        return;
      }
      
      // Delete from Supabase
      if (supabase) {
        const deletePromises = selectedContacts.map(contactId => 
          supabase.from('contacts').delete().eq('id', contactId)
        );
        
        Promise.all(deletePromises).then(results => {
          const errors = results.filter(result => result.error);
          if (errors.length > 0) {
            console.error('Delete errors:', errors);
            showAlert('error', 'Some contacts could not be deleted: ' + errors[0].error.message);
          } else {
            // Remove from local arrays
            allContacts = allContacts.filter(contact => !selectedContacts.includes(contact.id));
            filteredContacts = filteredContacts.filter(contact => !selectedContacts.includes(contact.id));
            
            // Clear selections and refresh display
            clearContactSelections();
            renderContacts();
            
            showAlert('success', `Successfully deleted ${selectedContacts.length} contact(s)`);
            
            // Close modal
            document.getElementById('delete-modal').style.display = 'none';
          }
        });
      } else {
        // Remove from local arrays
        allContacts = allContacts.filter(contact => !selectedContacts.includes(contact.id));
        filteredContacts = filteredContacts.filter(contact => !selectedContacts.includes(contact.id));
        
        clearContactSelections();
        renderContacts();
        showAlert('success', `Deleted ${selectedContacts.length} contacts (locally)`);
        document.getElementById('delete-modal').style.display = 'none';
      }
    }

    function makeEditable(cell) {
      if (cell.classList.contains('editing') || cell.classList.contains('readonly-cell')) {
        return;
      }
      
      const currentValue = cell.querySelector('.cell-content').textContent;
      const field = cell.dataset.field;
      const contactId = cell.dataset.id;
      
      // Create input element
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentValue;
      input.className = 'cell-input';
      
      // Add editing class
      cell.classList.add('editing');
      cell.innerHTML = '';
      cell.appendChild(input);
      
      // Focus and select
      input.focus();
      input.select();
      
      // Save on Enter or blur
      const saveEdit = async () => {
        const newValue = input.value.trim();
        
        // Remove editing class
        cell.classList.remove('editing');
        cell.classList.add('saving-cell');
        
        try {
          // Update Supabase
          if (supabase) {
            const { error } = await supabase
              .from('contacts')
              .update({ [field]: newValue })
              .eq('id', contactId);
            
            if (error) {
              console.error('Error updating contact:', error);
              showAlert('error', 'Failed to update contact: ' + error.message);
              // Revert to original value
              cell.innerHTML = `<span class="cell-content">${currentValue}</span><span class="edit-indicator">✎</span>`;
              cell.classList.remove('saving-cell');
              return;
            }
          }
          
          // Update local data
          const contact = allContacts.find(c => c.id === contactId);
          if (contact) {
            contact[field] = newValue;
          }
          
          const filteredContact = filteredContacts.find(c => c.id === contactId);
          if (filteredContact) {
            filteredContact[field] = newValue;
          }
          
          // Update cell display
          cell.innerHTML = `<span class="cell-content">${newValue}</span><span class="edit-indicator">✎</span>`;
          cell.classList.remove('saving-cell');
          cell.classList.add('saved-cell');
          
          // Remove saved indicator after animation
          setTimeout(() => {
            cell.classList.remove('saved-cell');
          }, 1000);
          
          console.log(`Updated ${field} for contact ${contactId} to: ${newValue}`);
          
        } catch (error) {
          console.error('Error saving edit:', error);
          showAlert('error', 'Failed to save changes');
          // Revert to original value
          cell.innerHTML = `<span class="cell-content">${currentValue}</span><span class="edit-indicator">✎</span>`;
          cell.classList.remove('saving-cell');
        }
      };
      
      const cancelEdit = () => {
        cell.classList.remove('editing');
        cell.innerHTML = `<span class="cell-content">${currentValue}</span><span class="edit-indicator">✎</span>`;
      };
      
      // Event listeners
      input.addEventListener('blur', saveEdit);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveEdit();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit();
        }
      });
    }
  </script>
</body>
</html>
